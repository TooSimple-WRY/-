Gamaredon group grows its game Release_Time :  2020-06-11  Report_URL :  https://www.welivesecurity.com/2020/06/11/gamaredon-group-grows-its-game/  ESET researchers have discovered several previously undocumented post-compromise tools used by the highly active Gamaredon threat group in various malicious campaigns .		threatActor_name others others others others others others others others others others others others security_team others others others others others others tool tool others others others others others threatActor_name others others others others others others others
One tool , a VBA macro targeting Microsoft Outlook , uses the target ’s email account to send spearphishing emails to contacts in the victim ’s Microsoft Office address book .		others others others others program_language others others company tool others others others others others others others others others attack_activity attack_activity attack_activity others others others others others others others tool tool others others others
We also analyzed further Gamaredon tools that have the ability to inject malicious macros and remote templates into existing Office documents .		others others others others threatActor_name tool others others others others others function function function function function function function function function function others
The Gamaredon group has been active since at least 2013 .		others threatActor_name others others others others others others others time others
It has been responsible for a number of attacks , mostly against Ukrainian institutions , as evidenced in several reports from CERT-UA and from other official Ukrainian bodies over time .		others others others others others others others others others others others others location others others others others others others others others security_team others others others others location others others others others
In the last few months , there has been an increase in activity from this group , with constant waves of malicious emails hitting their targets ’ mailboxes .		others time time time time others others others others others others others others others others others others others others others others attack_activity attack_activity others others others others others others
The attachments to these emails are documents with malicious macros that , when executed , try to download a multitude of different malware variants .		others others others others others others others others others others others others others others others others others others others others others others others others others
Gamaredon has leveraged many different programming languages in the past few months , ranging from C# to VBScript , batch files and C/C++ .		threatActor_name others others others others others others others others others others others others others others program_language program_language others program_language others others others others program_language others
The tools used by Gamaredon are very simple and are designed to gather sensitive information from compromised systems and to spread further .		others others others others threatActor_name others others others others others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
Contrary to other APT groups , the Gamaredon group seems to make no effort in trying to stay under the radar .		others others others threatActor_name threatActor_name others others threatActor_name others others others others others others others others others others others others others others
Even though their tools have the capacity to download and execute arbitrary binaries that could be far stealthier , it seems that this group ’s main focus is to spread as far and fast as possible in their target ’s network while trying to exfiltrate data .		others others others tool others others others others function function function function function others others others others others others others others others others others others others others others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others others others others others others
Could we be missing something?		others others others others others others
While most of the recent publications have focused on the spearphishing emails together with the downloaders they contain , this blogpost focuses on the post-compromise tools deployed on these systems .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The Gamaredon group uses a package that includes a custom Microsoft Outlook Visual Basic for Applications ( VBA ) project .		others threatActor_name others others others others others others others others tool tool tool tool tool tool tool tool tool others others
Using Outlook macros to deliver malware is something we rarely see while investigating malicious campaigns .		others tool others others others others others others others others others others others others others others
This bundle of malicious code starts out with a VBScript that first kills the Outlook process if it is running , and then removes security around VBA macro execution in Outlook by changing registry values .		reference_word reference_word reference_word reference_word reference_word others others others others program_language others others others others others others others others others others others others others others others others others others others others tool others others others others others
It also saves to disk the malicious OTM file ( Outlook VBA project ) that contains a macro , the malicious email attachment and , in some cases , a list of recipients that the emails should be sent to .		others others others others function function function function function function function function function function function function function function others others others others others others others others others others others others others others others others others others others others others others others
Next , it relaunches Outlook with a special option , /altvba <OTM filename> , which loads the Gamaredon VBA project .		others others others others tool others others others others others string string string string string others others others others threatActor_name others others others
The malicious code is executed once the Application.Startup event is received .		others others others others others others others others others others others others
They have been using this module in three different ways to send malicious email to :  Everyone in the victim ’s address book .		others others others others others others others others others others others attack_activity attack_activity attack_activity others others target_crowd target_crowd target_crowd target_crowd target_crowd target_crowd target_crowd target_crowd others
Everyone within the same organization .		target_crowd target_crowd target_crowd target_crowd target_crowd others
A predefined list of targets .		target_crowd target_crowd target_crowd target_crowd target_crowd others
While abusing a compromised mailbox to send malicious emails without the victim ’s consent is not a new technique , we believe this is the first publicly documented case of an attack group using an OTM file and Outlook macro to achieve it .		others others others others others others attack_activity attack_activity attack_activity others others others others others others others others others others others others others others others others others others others others others others others others others others others tool tool tool tool tool others others others others
Based on the “ send to all in contact list ” behavior of this malicious VBA code , we believe that this module might have led some organizations to think they were targeted by Gamaredon when they were merely collateral damage .		others others others others others others others others others others others others others others malware malware malware others others others others others others others others others others others others others others others others others threatActor_name others others others others others others others
For example , recent samples uploaded to VirusTotal coming from regions that are not traditionally targeted by Gamaredon , such as Japan , could be explained by the actions of this module .		others others others others others others others tool others others others others others others others others others threatActor_name others others others location others others others others others others others others others others others
As seen in Figure 2 , the VBA code builds the email body and attaches the malicious document to the email .		others others others others others others tool tool tool function function function function function function function function function function function function others
We ’ve seen both .docx and .lnk files being used as attachments .		others others others others others others others others others others others others others others
These are very similar to the content of the malicious attachments used in Gamaredon ’s initial spearphishing campaigns .		others others others others others others others others others others others others others threatActor_name others others others attack_activity attack_activity others
Figure 3 shows an email generated by this malicious component .		others others others others others others others others others others others
The email contains both English and Russian text .		others others others others others others others others others
However , as illustrated in Figure 3 , there is a problem with the Russian encoding .		others others others others others others others others others others others others others others others others others
This was fixed in a later version of this module — another example of the Gamaredon group ’s fast development pace and apparent lack of attention to detail .		others others others others others others others others others others others others others others others threatActor_name others others others others others others others others others others others others others others
We analyzed different variants of malicious modules used by the Gamaredon group to inject malicious macros or remote templates into documents already present on the compromised system .		others others others others others malware malware others others others threatActor_name others others counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure others others others others others others others
This is a very efficient way of moving laterally within an organization ’s network as documents are routinely shared amongst colleagues .		others others others others others counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure others others others others others others others others
Also , as these macros are run when opening the documents , it is a good way to persist on a system as some of these documents are likely to be opened multiple times and at different times .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
These macro injection modules also have the functionality to tamper with the Microsoft Office macro security settings .		others others others others others others others others others function function function tool tool function function function others
Thus , affected users have no idea that they are again compromising their workstations whenever they open the documents .		others others others others others others others others others others others others others others others others others others others others
We have seen this module implemented in two different languages : C# and VBScript .		others others others others others others others others others others others program_language program_language others program_language others
This module was delivered , like many other tools , in a 7z self-extracting archive .		others others others others others others others others others others others others others others others others
Inside , there was a password-protected RAR archive containing a few files .		others others others others others others tool others others others others others others
Notably , there were two text files , one for Word and one for Excel , containing the VBA source code of the malicious macro to be inserted into the targeted documents , and the .NET assembly responsible for finding and compromising existing documents .		others others others others others others others others others others tool others others others tool others others others others others others others others others others others others others others others others others others others malware malware malware others others function function function function function others
As illustrated in Figure 4 , the assembly name is CodeBuilder .		others others others others others others others others others others reference_word others
It iterates over all possible Office <version> values for both Word and Excel <product> values .		others others others others others others others others others others others others others others others others others others others others
It then scans for documents with valid Word or Excel file extensions on all drives connected to the system .		others others sub_activity sub_activity sub_activity sub_activity sub_activity tool sub_activity tool sub_activity others others others others others others others others others
For the drive containing the Windows installation , it scans only specific locations , namely the Desktop and Downloads folders .		others others others others others OS_name others others others others others others others others others others others others others others others
For the others , it scans the entire drive .		others others others others others others others others others others
The malware moves each located document into the AppData folder , inserts malicious Word or Excel macros into it using a Microsoft.Office.Interop object , and then moves the document back into its original folder .		others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others others others others others others others others others others others
In the samples we analyzed , the injected macros were simple downloaders .		others others others others others others others others others others others others others
The VBScript version of this module is similar in behavior to the .NET one .		others program_language others others others others others others others others others others others others others
The main difference is that instead of inserting a malicious macro into existing documents , it inserts references to a remote template into them .		others others others others others others others others others others others others others others others others others others others others others others others others others
This VBScript module also comes packaged in a self-extracting archive , containing one batch file and two VBS files responsible for iterating through documents and adding the remote template references to them .		others program_language others others others others others others others others others others others others others others others tool others others others function function function function function function function function function function function others
Interestingly , some of the custom tools described in Palo Alto Networks ’ 2017 blogpost on Gamaredon are still being updated and in use today .		others others others others others others others others others security_team security_team security_team others time others others threatActor_name others others others others others others others others others
Some show significant similarities while others are rewrites in different coding languages .		others others others others others others others others others others others others others
The most prevalent tools downloaded and installed on compromised machines can be broadly grouped into two different categories : downloaders and backdoors .		others others others others others others others others others others others others others others others others others others others tool tool tool others
There are many variations of their downloaders , most of them written in either C# or VBScript .		others others others others others others tool others others others others others others others program_language program_language program_language program_language others
This section will cover only two of their most original variants ; the others have not evolved that much and are very simple .		others others others others others others others others others others others others others others others others others others others others others others others others
This .NET executable , similar to many other tools used by the Gamaredon group , uses obfuscation techniques such as junk code insertion and string obfuscation .		reference_word reference_word reference_word others others others others others others others others others threatActor_name others others others function function others others others others others others others others others
It contains in its body the base64-encoded source code of a downloader .		others others others others others others others others others others others others others
It decodes that source code and compiles it directly on the system using the built-in Microsoft.CSharp.CSharpCodeProvider class .		others others others others others others others others others others others others others others others others others others
It places the resulting executable in an existing directory and creates a scheduled task that will launch it every 10 minutes .		others others others others others others others others others others others others others others others others others others time time time others
As can be seen in Figure 6 , the decoded source code still has comments in it , illustrating the apparent sloppiness of Gamaredon ’s operators .		others others others others others others others others others others others others others others others others others others others others others others others threatActor_name threatActor_name others others others
As seen in Figure 7 , this .NET executable uses a GitHub repository to obtain and execute a downloader .		others others others others others others malware malware others others others tool tool others function function function function function others
This repository is now gone , but we were able to download a copy of it while it was still available .		others others others others others others others others others others others others others others others others others others others others others others
The repository contained a single file — readme.txt — that was a base64-encoded .NET downloader executable .		others others others others others others others others others others others others others others others others others
The role of the GitHub project module is to download this file , decode it and execute it .		others others others others tool tool tool others others function function function function function function function function function others
While some variations exist in functionalities , the main purpose of these modules is to enumerate all documents on a compromised system and upload them to the C&C server .		others others others others others others others others others others others others others others others function function function function function function function function function function function function function function function function others
These file stealers can also download and execute arbitrary code from the C&C server .		others others others others others others others others others others others others others others others others others
As with many other tools used by the Gamaredon group , they come in four different coding languages : C/C++ , C# , batch file and VBScript .		others others others others others others others others threatActor_name others others others others others others others others others others program_language program_language program_language program_language program_language program_language program_language program_language program_language others
This variant is the successor of the USBStealer module described here .		others others others others others others others tool others others others others
Although the latest versions are now quite different , examining samples of this module throughout its development clearly shows it originates from the same source code .		others others others others others others others others others others others others others others others others others others others others others others others others others others others
One sample that illustrates this shift well is a 64-bit DLL with internal name Harvesterx64.dll , compiled in June 2019 .		others others others others others others others others others others others others others others string others others others time time others
It still has most of the strings used in the older variants , but also exhibits two improvements that are still in the newer ones .		others others others others others others others others others others others others others others others others others others others others others others others others others others
First , it now resolves Windows APIs via name hashing and second , it uses a basic text file instead of a SQLite database to track which files were already uploaded to the C&C server .		others others others others others OS_name others others others others others others others others others others function function function function function function function function function function function function function function function function function function function function function others
The behavior of this module is quite straightforward : it scans the system for new Microsoft Office documents , both on local and removable drives , and uploads them to the C&C server .		others others others others others others others others others others others others others others others company tool tool others others others others others others others others others others others others others others others others others others
To know whether the document is new , the module keeps , in a text file , one MD5 hash per file uploaded to the server .		others others others others others others others others others others others others others others others others others others md5 others others others others others others others others
These MD5 hashes are not based on the file content , but rather on a string composed of the file name , its size and its last modified time .		others md5 others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The module ’s strings are stored in its .data section , encrypted with a simple XOR key .		reference_word reference_word others others others others others others others others others others others others others others others others others
It also has the ability to download and execute arbitrary code from its C&C server .		others others others others others others function function function function function function function function function function function others
This is a reimplementation in C# of the C/C++ version .		others others others others others program_language program_language others others program_language others others
The major difference is that it also takes screenshots of the compromised computer every minute .		others others others others others others others others others others others others others others others others
As seen in Figure 8 , the version we analyzed has five different threads with evocative names .		others others others others others others others others others others others others others others others others others others
This version comprises several scripts , written in both batch file form and VBScript .		others others others others others others others others others others others others others program_language others
The ultimate goal is the same , though : scanning the system for sensitive documents .		others others others others others others others others others function function function function function function others
The main mechanism is a batch file that searches for Word documents ( *.doc* ) on the system and stores their names in a text file ( see Figure 9 ) .		others others others others others others others others others others tool tool others others others others others others others others others others others others others others others others others others others others others others
The package also contains encrypted script files named 1.log , 2.log , 3.log , 4.log and 5.log .		others others others others others others others others others others others others others others others others others others
Once decrypted , these scripts are obfuscated VBScript downloaders that are able to download and execute arbitrary code .		others others others others others others others program_language others others others others others others others others others others others
The Gamaredon group uses many different domains , both free and paid , for its C&C servers .		others threatActor_name others others others others others others others others others others others others others others others others others others
Free domains are mostly DDNS from No-IP : hopto.org , ddns.net , myftp.biz , while paid domains are registered through the REG.RU registrar and include the .fun , .site , .space , .ru , .website and .xyz TLDs .		others others others others tool others company others domain domain domain domain domain others others others others others others others others company others others others others domain domain domain domain domain domain domain domain domain domain domain domain others
They are constantly changing the domains used by their tools , but mostly on a small number of ASNs .		others others others others others others others others others others others others others others others others others others others others
Careful analysis suggests they use separate domains for small groups of victims .		others others others others others others others others others others others others others
Please check ESET ’s GitHub account for an extensive list of domains used by the Gamaredon group .		others others company others others tool tool others others others others others others others others others threatActor_name others others
We were able to collect numerous different samples of malicious scripts , executables and documents used by the Gamaredon group throughout their campaigns .		others others others others others others others others others others others others others others others others others others threatActor_name others others others others others
We noticed several mistakes in these , especially in scripts .		others others others others others others others others others others others
It is of course impossible to know the exact reason behind these bugs or oversights , but the volume of samples the group produces and their rapid development could explain it .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The fact that there were comments left in the source code included in some C# compiler module samples or that the Russian encoding was wrong in email generated by the Outlook VBA module shows that there is no stringent review or testing before releasing their many tools and using them in the wild .		others others others others others others others others others others others others others others program_language program_language others others others others others others others others others others others others others others others tool tool others others others others others others others others others others others others others others others others others others others others others others
However , while these errors might lower their tools ’ overall effectiveness , this group ’s rapid execution and adaptation also has some advantages .		others others others others others others others others others others others others others others others others others others others others others others others others others others
The volume and relentlessness of the attacks can create a state of constant dread in their targets .		others others others others others others others others others others others others others others others others others others
And although the code is very simple , some techniques , such as script obfuscation , make it hard to fully automate the analysis , making the analyst ’s job tedious .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Their GitHub project allowed us a glimpse into the rapid development of their tools .		others tool others others others others others others others others others others others others others
The code that was committed there clearly showed the evolution of the C# downloader .		others others others others others others others others others others others others program_language program_language tool others
The first versions showed no signs of obfuscation ; then the developers added different string obfuscations and junk code to make the analysis harder .		others others others others others others others others others others others others others others others others others others others others others others others others others
In terms of persistence , several different techniques are used , but the most common ones are scheduled tasks , autorun registry keys and leveraging the Startup folder .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Although these techniques are very simple and have been known for a long time , the Gamaredon group ’s strategy of trying to install multiple scripts and executables on each system , and constantly updating them , significantly complicates the defender ’s lives .		others others others others others others others others others others others others others others others others threatActor_name others others others others others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
Despite the simplicity of most of their tools , the Gamaredon group also is capable of deploying some novelty , such as their Outlook VBA module .		others others others others others others others others others others threatActor_name others others others others others others others others others others others others tool tool tool others
However , as it is far from stealthy , in the long run it is no match for a capable organization .		others others others others others others others others others others others others others others others others others others others others others others
The variety of tools Gamaredon has at its disposal can be very effective at fingerprinting a machine and understanding what sensitive data is available , then spreading throughout the network .		others others others others threatActor_name others others others others others others others others others others others others others others others others others others others others others others others others others others
Could this just be a way to deploy a much stealthier payload?		others others others others others others others others others others others others others