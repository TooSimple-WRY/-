HOT KNIVES THROUGH BUTTER : Evading File-based Sandboxes .		others others others others others others others others others
With this information , Pushdo easily cancels process notifications to security software .		others others others others malware others sample_function sample_function sample_function sample_function sample_function sample_function others
The malware determines the Windows build number using the NtBuildNumber function .		others others others others OS_name others others others others function others others
For Windows XP , the build numbers are 2600 (32-bit ) and 3790 (64-bit ) .		others OS_name OS_name others others others others others string others others others others string others others others others
The malware gets the runtime address for PsSetCreateProcessNotifyRoutine .		others others sample_function sample_function sample_function sample_function sample_function sample_function others
The jmp op-code is 2 bytes long .		others others others others others others others others
Therefore , runtime address of PsSetCreateProcess NotifyRoutine ( in memory ) is jmp PsSetCreateProcessNotifyRoutine + 2 .		others others others others others function function others others others others others others function others others others
The malware linearly scans the assembly code for 0xBF followed 5 bytes later by 0x57 .		others reference_word sample_function sample_function sample_function sample_function sample_function others string others others others others others string others
The value immediately after the 0xBF is the internal PspCreateProcessNotifyRoutine address .		others others others others others string others others others function others others
From there , the malware simply walks the PsCreateProcessNotifyRoutine pointer and NULLs out all callback objects .		others others others others others others others others function others others others others others others others others
For Windows XP , the operation code 0xBF is “ mov edi , ” and 0x57 is “ push edi.		others OS_name OS_name others others others others string others others string string others others others string others others string string others
”  Malicious downloaders typically contain code to make an HTTP request to a server controlled by the attacker and download the malware payload .		others others others others others others others others others tool others others others others others others others others others others others others others others
Many file-based sandboxes are configured with no connection to the Internet .		others others tool others others others others others others others others others
A malicious downloader observed in such a sandbox would make an HTTP request but fail to download the malware .		others others others others others others others tool others others others tool others others others others others others others others
So the sandbox detects only the HTTP request—not the actual malware download and ensuing malicious activity .		others others tool others others others others others others others others others others others others others others
Many sandboxes assign a predefined name to files during execution .		others tool others others others others others others others others others
Attackers can avoid detection by having their code determine whether it is running under one of these names and , if so , terminate before exhibiting any telltale behavior .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Here , the code calls Windows ’ GetModuleFilenameW() function to retrieve its own file path .		others others others others others OS_name others function others others others others others others others others others others
It then checks for the string “ sample ” ( a common name assigned to modules running in a sandbox ) in that path .		others others others others others others others string others others others others others others others others others others others others others others others others others
If “ sample ” appears , the malware aborts .		others others string others others others others others others others
Every computer hard drive has a volume serial number , typically assigned when formatting the drive .		others others others others others others others others others others others others others others others others others
This four-byte value is generated from a combination of the date and time of the format operation .		others others others others others others others others others others others others others others others others others others
So chances are small that any two given volumes will have the same serial number .		others others others others others others others others others others others others others others others others
But many sandboxes are virtualized copies of one another , including the volume serial number created when the original system image was created .		others others tool others others others others others others others others others others others others others others others others others others others others others
Malware can detect the presence of many sandboxes by checking whether the volume serial number of the machine it is running on matches that of widely used VMs .		others others others others others others others tool others others others others others others others others others others others others others others others others others others others tool others
The function retrieves information about the file system and volume associated with the specified root directory .		others others others others others others others others others others others others others others others others others
The instruction “ cmp DWORD PTR [EBP-8] , 0CD1A40 ” compares the volume number retrieved by GetVolumeInformation() with the volume number of a known file-based sandbox .		others others others string string string string string string others string others others others others others others others function others others others others others others others others others others tool others
If it finds a match , the malware terminates .		others others others others others others others others others others
File-based sandbox are usually set up to execute file samples one after another , and VMs do not normally reboot during analysis .		others tool others others others others others others others others others others others others others tool others others others others others others others
With this in mind , attackers are deploying malware that does nothing overtly suspicious until after a reboot .		others others others others others others others others others others others others others others others others others others others
Because the sandbox does not reboot during analysis , it observes no malicious behavior .		others others tool others others others others others others others others others others others others
One example of this technique is Terminator RAT , which has appeared in a variety of campaigns .		others others others others others others malware malware others others others others others others others others others others
Terminator works as follows :  Attacks usually start with a weaponized Microsoft Word document which drops the malicious executable DW20.exe when opened .		others others others others others others others others others others others tool tool others others others others others others sample_name others others others
DW20.exe creates two working folders , “ %UserProfile%\Microsoft ” and “ %AppData%\2019.		sample_name others others others others others others string string string string others others others string string string string others
” The “ Microsoft ” folder stores Terminator ’s configurations and executable files ( svchost_.exe and sss.exe ) , and the “ 2019 ” folder stores related shortcut link files .		others others others company others others others others others others others others others others others sample_name others sample_name others others others others others others others others others others others others others others
The malware then sets “ 2019 ” as Windows ’ startup folder ( files in this folder run automatically when Windows starts up ) by modifying the following registry value .		others reference_word others others others others others others OS_name others others others others others others others others others others others others others others others others others others others others others others
DWE20.exe deletes itself from the PC ’s hard drive and terminates .		sample_name sample_function sample_function others others others others others others others others others others
Only after the computer restarts—triggering the malware shortcuts placed in the “ 2019 ” folder that is now set as the Windows startup folder—does the malware begin its dirty work .		others others others others others others others others others others others others others others others others others others others others others OS_name others others others others others others others others others
In theory , code executed in a sandbox should run the same way it does on a physical computer .		others others others others others others others tool others others others others others others others others others others others others
In reality , most sandboxes have telltale characteristics , enabling attackers to include features into their malware that check for these virtual environments .		others others others others tool others others others others others others others others others others others others others others others others others others others
This section explains some of those checks in detail .		others others others others others others others others others others
Many malicious files are set to execute only in certain versions of applications or operating systems .		others others others others others others others others others others others others others others others others others
These self-imposed limitations are not always attempts to evade sandboxes specifically ; many seek to exploit a flaw present only in a specific version of an application , for example .		others others others others others others others others others tool others others others others others others others others others others others others others others others others others others others others others
But the effect is often the same .		others others others others others others others others
All sandboxes have predefined configurations .		others tool others others others others
If a given configuration lacks a particular combination of operating systems and applications , some malware will not execute , evading detection .		others others others others others others others others others others others others others others others others others others others others others others others
The version number of the Flash player installed on the system is an input ( variable v ) to the getUrl() function .		others others others others others tool tool others others others others others others others others others others others others others function others others others others
The code makes a GET request to a high-risk domain to download a malicious file , f.swf , to exploit a flaw in a specific version of Flash .		others others others others others others others others others others others others others others others others sample_name others others attack_goal attack_goal attack_goal others others others others others others others