Titanium: the Platinum group strikes again Release_Time : 2019-11-08 Report_URL :  https://securelist.com/titanium-the-platinum-group-strikes-again/94961/ Platinum is one of the most technologically advanced APT actors with a traditional focus on the APAC region .		malware others others threatActor_name others others others others others others others others others others others threatActor_name others others others others others others others others others others others others others others others location location others
During recent analysis we discovered Platinum using a new backdoor that we call Titanium ( named after a password to one of the self-executable archives ) .		others others others others others threatActor_name others others others others others others others malware others others others others others others others others others others others others others
Titanium is the final result of a sequence of dropping , downloading and installing stages .		malware others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
The malware hides at every step by mimicking common software .		reference_word reference_word others others others others others sub_activity sub_activity sub_activity others
During our research we found that the main targets of this campaign were located in South and Southeast Asia .		others others others others others others others others others others others others others others others location location location location others
The Titanium APT includes a complex sequence of dropping , downloading and installing stages , with deployment of a Trojan-backdoor as the final step .		others threatActor_name others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others sub_activity sub_activity sub_activity sub_activity others others others others others
In every case the default distribution is :  An exploit capable of executing code as a SYSTEM user .		others others others others others others others others others others others others others others others others person person others
A shellcode to download the next downloader .		others tool others sub_activity sub_activity sub_activity tool others
A downloader to download an SFX archive that contains a Windows task installation script .		others tool others sub_activity sub_activity tool tool others others others OS_name tool tool tool others
A password-protected SFX archive with a Trojan-backdoor installer .		others others tool tool others others malware malware others
An installer script ( ps1 ) .		tool tool tool others others others others
A COM object DLL ( a loader ) .		tool tool tool tool others others others others others
The Trojan-backdoor itself .		others malware others others
We believe the Titanium APT uses local intranet websites with a malicious code to start spreading .		others others others threatActor_name others others tool tool tool tool tool tool tool others others others others
Another known way of spreading is the use of a shellcode that needs to be injected into a process .		others others others others others others others others others others tool others others others others others others others others others
In this case it was winlogon.exe .		others others others others others sample_name others
Attackers make active use of various kinds of ‘ wrappers ’ .		reference_word others others others others others others others others malware others others
Each wrapper is usually a COM DLL , with the corresponding exported functions .		others malware others others others tool tool others others others others others others others
The main purpose of these libraries is to decrypt and load an encrypted file ( previously dropped somewhere ) into the system memory ( a payload ) and then redirect calls to the wrapper itself to the payload ’s exported functions .		others others others others others others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others others others others others others others others others others others others others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
Another type of wrapper DLL is designed to obtain a command line from its exported function argument passed by a caller and create a new process .		others others others malware malware others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
This is a password-encrypted SFX archive that can be downloaded via BITS Downloader .		others others others others tool tool others others others others others tool tool others
The password is hardcoded into the downloader that is used to decrypt the SFX archive using the -p command line argument .		others others others others others others tool others others others others others others tool tool others others others others others others others
The main feature of this archive is that it contains the cURL executable code , compiled into a DLL .		others others others others others others others others others others others tool tool tool others others others others tool others
Its purpose is to install the Windows task to establish persistence in the infected system .		others others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
The backdoor itself uses an SFX archive which must be launched from the command line using a password to unpack it .		others malware others others others tool tool others others others others others others others others others others others others others others others
All paths examples here and there will be for the DVD making software .		others others others others others others others others others others tool tool tool others
However , these notes can be also applied to any other known software paths .		others others others others others others others others others others others others others others others
The BITS Downloader is used to download encrypted files from the C&C server then decrypt and launch them .		others tool tool others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
The shellcode itself contains position-independent code and doesn’t require previously loaded libraries ( except Kernel32.dll ) .		others tool others others tool tool others others others others others others others others others others sample_name others others
Its sole purpose is to connect to the hardcoded C&C address , download an encrypted payload ( the password-protected SFX archive ) , then decrypt and launch it using the hardcoded unpacking password .		others others others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others attack_goal attack_goal attack_goal attack_goal others others others tool tool others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
The usual command line is :  "rundll32 "$temp\IOZwXLeM023.tmp" ,GetVersionInfo -t 06xwsrdrub2i84n6map3li3vz3h9bh4vfgcw" .		others others others others others others others string others sample_name sample_name others others string string string others sample_name
The BITS Downloader is a DLL file which has only one exported function : GetVersionInfoA .		others tool tool others others tool others others others others others others others others others others
The main purpose of this library is to download files in encrypted form from the C&C and launch them .		others others others others others others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
The first thing the downloader does is to check whether it was started using the SYSTEM user .		others others others others tool others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
If it was , it launches command line arguments ( that were passed to the binary loaded by the downloader DLL ) using WMI .		others others others others others sub_activity sub_activity sub_activity sub_activity others others others others others others others others others others tool tool others others tool others
If it wasn’t started using the SYSTEM user , the downloader passes command line arguments into the argument parser .		others others others others others others others others person person others others tool sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
-c URL	Specifies a URL address where system information will be sent .		string others others others others others others others others others others others others
-t STRING	An additional string that will be appended to a request string to the C&C .		string others others others others others others others others others others others others others others tool tool tool others
-u URL	Confirmation URL where the downloader will send various confirmations or request data .		string others others others others others tool others others others others others others others others
Possible to build in two additional confirmation URLs .		others others others others others others others others others
-br GUID	Stop a payload downloading .		string others others others others others others
The GUID parameter must provide a download task GUID .		others tool others others others others others others tool others
If one of these parameters exists , the downloader will collect information about installed antivirus products and send it to the C&C .		others others others others others others others others tool others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
After that , it sends the download request to the confirmation URL .		others others others reference_word sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
In response , the C&C sends a file that will be downloaded in the %USERPROFILE% directory .		others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity string string string sub_activity others
Default ( hardcoded ) URL : http://70.39.115.196/payment/confirm.gif .		others others others others others others url_evil url_evil url_evil others
The request is a string such as :  http://70.39.115.196/payment/confirm.gif?f=1 .		others others others others others others others others url_evil url_evil url_evil url_evil url_evil others
http://70.39.115.196/payment/confirm.gif?f=2 .		url_evil url_evil url_evil url_evil url_evil others
The downloader checks the hash field against a calculated MD5 of the data field hash , and if the hash is correct , performs the following actions :  Appends an extension ( DLL or EXE , depending on data type ) .		others tool sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others others others others others others others others others others others others sub_activity sub_activity sub_activity others tool others tool others others others others others others others
Stores the downloaded file in the %TMP% folder using the name % (SystemTimeAsFileTime.dwLowDateTime ).%TMP .		sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity string string string sub_activity others others others sample_name sample_name sample_name sample_name sample_name sample_name sample_name others
Then the downloader specifies a command line to launch the downloaded file .		others others tool sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
If the file is a DLL , the final command line will be :  "%systemroot%\system32\rundll32.exe % (SystemTimeAsFileTime.dwLowDateTime )%.TMP ,-peuwewh383eg -t 06xwsrdrub2i84n6map3li3vz3h9bh4vfgcw" .		others others others others others tool others others others others others others others others others sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name others string string string others sample_name
If the file is an EXE file :  % (SystemTimeAsFileTime.dwLowDateTime )%.TMP -peuwewh383eg -t 06xwsrdrub2i84n6map3li3vz3h9bh4vfgcw .		others others others others others tool others others sample_name sample_name sample_name sample_name sample_name sample_name string string string others
After that , the downloader deletes itself using the following command line :  /c for /L %i in ( 1,1,100 ) do ( for /L %k in ( 1,1,100 ) do ( del /f /q module_path > NUL & if not exist module_path exit /b 0 ) ) .		others others others others tool sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others string string string string string string string string string string string string string string string string string string string string string string string string string string string string string string string string string string string string string others
To launch the downloaded file , the downloader uses the WMI classes Win32_ProcessStartup , Win32_Process and their methods and fields .		others others others others others others others tool others others tool others sample_name others sample_name others others others others others others
To download a file , the downloader uses the BITS service and its COM interface , called IBackgroundCopyManager .		others others others others others others tool others others tool tool others others tool tool others others tool others
It creates a task with the name Microsoft Download , then specifies remote and local file paths and timeouts .		others others others others others others others company others others others others others others others others others others others others
p.bat	Launches cURL and obfuscated ps1 scripts .		sample_name sample_function sample_function sample_function sample_function sample_function sample_function others
c.dll	cURL executable compiled as a DLL ( 7.50.3 ) .		sample_name sample_function sample_function sample_function sample_function sample_function tool others others others others
f1.ps1	Will be executed after the first request to the C&C ; decrypts x.dat .		sample_name sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others sample_function sample_function others
f2.ps1	Will be executed after the second request to the C&C ; decrypts b.dat .		sample_name sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others sample_function sample_name others
e.ps1	Contains code that calculates a string for the Authorization field of the HTTP header .		sample_name sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
h.ps1	Gets information about the system proxy settings .		sample_name sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
e.dll	A DLL file with a single exported function ; calls CreateProcessA .		sample_name sample_function tool sample_function sample_function sample_function sample_function sample_function sample_function others sample_function sample_function others
x.dat	u.xml	AES-encrypted file ( see f1.ps1 for decryption algorithm ) .		sample_name sample_name others others others others sample_name others others others others others
b.dat	i.bat	AES-encrypted file ( the same decryption algorithm ) .		sample_name sample_name others others others others others others others others others
i.bat	Performs Windows task installation .		sample_name sample_function OS_name sample_function sample_function others
-pKEY	Argument with a key to unpack the SFX archive .		string others others others others others others others tool tool others
-t ACCEPTANCE_ID_STRING	Argument with a long string – AcceptanceID ( used in requests to the C&C ) .		string string others others others others others others others others others others others others others tool tool tool others others
p.bat launches the h.ps1 script to get information about system-wide proxy settings .		sample_name others others sample_name others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
After that it launches the e.ps1 script to calculate the SystemID that will be used in requests to the C&C .		others others others others others sample_name others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
To send a request , it uses c.dll ( which is cURL and has an exported function called DllGetClassObject ) .		others others others others others others others sample_name others others others tool others others others sample_function sample_function sample_function sample_function others others
%pp%	System-wide proxy .		string string string others others others
%output%	SystemID .		string string string others others
%p3%	AcceptanceID .		string string string others others
This request downloads the x.dat file , and the f1.ps1 script decrypts it into u.xml .		others others sub_activity sub_activity sample_name sub_activity others others others sample_name others sub_activity sub_activity sub_activity sample_name others
It downloads the b.dat file , and the f2.ps1 script decrypts it into i.bat ( using the same decryption algorithm ) .		others sub_activity sub_activity sample_name sub_activity others others others sample_name others sub_activity sub_activity sub_activity sample_name others others others others others others others others
The i.bat file uses the previously decrypted u.xml file as the task description .		others sample_name others others others others others sample_name others others others others others others
BabyBoyStyleBackground.wmv	Configuration data .		sample_name sample_function sample_function others
DvDupdate.dll	Trojan-backdoor loader .		sample_name tool tool others
nav_downarrow.png	Trojan-backdoor .		sample_name malware others
psinstrc.ps1	Loader installation script .		sample_name tool tool tool others
In the case of the audio drivers software mimic , it differs only in its installation method compared to DVD making software : the ps1 script uses two known CLSIDs to replace their COM DLL paths with malicious ones .		others others others others others others others others others others others others others others others others others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
psinstrc.ps1 is the installer script that registers DvDupdate.dll as the ‘ DVDMaker Help ’ service , and sets its entry point as the DllGetClassObject name .		sample_name others others others others others sample_function sample_name sample_function sample_function sample_function sample_function sample_function sample_function sample_function others others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
There are two ways the loader can be installed :  System service , with the DllGetClassObject exported function as the ServiceMain function .		others others others others others others others others others others others others others others others tool others others others others others others others
COM object , by replacing an existing CLSID registry path with its own .		tool tool others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
DvDupadte.dll is a service DLL , but with all the same exports you would expect from a COM object .		sample_name others others tool tool others others others others others others others others others others others others tool tool others
Basically , it ’s a payload loader .		others others others others others others tool tool others
The whole code is obfuscated with different Windows API calls and loops .		others others others others others others others OS_name others others others others others
It wasn’t designed to confuse a reverse engineer or to make reverse engineering harder , but to bypass some simple AV emulation engines .		others others others others others others others others others others others others others others others others others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
The first exported function for every COM object is DllGetClassObject .		others others others others others others tool tool others others others
The loader creates a thread that decrypts the payload , restores its PE and MZ headers , and then loads it into memory and launches it .		tool tool sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
The payload is encrypted with AES 256 CBC .		others others others others others encryption_algo encryption_algo encryption_algo others
The decryption key is hardcoded along with other encrypted strings .		others others others others others others others others others others others
It doesn’t contain ‘ MZ ‘ and ‘ PE ‘ tags that allow it to bypass simple AV engines .		others others others others others others others others others others others others others others others others others attack_goal attack_goal attack_goal attack_goal others
After initializing the payload , the loader calls its function with ordinal 1 .		others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
The payload , with backdoor functionality , is a DLL file .		malware malware others others others others others others others tool others others
The malware functionality is in the first exported entry only .		others others others others others others others others others others others
The first thing that it does is decrypt the other encrypted binary ( containing configuration data ) from the SFX content .		others others others others reference_word others others sub_activity sub_activity sub_activity sub_activity sub_activity others others others others others others others tool tool others
The execution thread is responsible for receiving commands from the C&C server and sending responses .		others tool tool others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
It contains an execution loop that starts by reading configuration item #00 to get the C&C address .		reference_word others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
To initialize the connection to the C&C , the payload sends a base64-encoded request that contains a unique SystemID , computer name , and hard disk serial number .		others others others others others others tool tool tool others malware malware sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
After that , the malware starts receiving commands .		others others others reference_word reference_word sub_activity sub_activity sub_activity others
To receive commands from the C&C , the payload sends an empty request to the C&C .		others others others others others tool tool tool others malware malware sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
It uses the UserAgent string from the configuration and a special cookie generation algorithm to prepare a request .		others others others tool tool others others others others others others tool tool tool others others others others others
The malware can also get proxy settings from Internet Explorer .		reference_word reference_word others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
In response to this request , the C&C answers with a PNG file that contains steganographically hidden data .		others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
This data is encrypted with the same key as the C&C requests .		others others others others others others others others others others tool tool tool others others
The decrypted data contains backdoor commands and arguments for them .		others others others others others others others others others others others
The backdoor can accept many different commands , with the following among the most interesting :  Read any file from a file system and send it to the C&C .		others malware others others others others others others others others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
Drop or delete a file in the file system .		sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
Drop a file and run it .		sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
Run a command line and send execution results to the C&C .		sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
Update configuration parameters ( except the AES encryption key ) .		sub_activity sub_activity sub_activity others others others encryption_algo others others others others
Interactive mode – allows to the attacker to receive input from console programs and send their output at the C&C .		others others others others others others reference_word others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
The Titanium APT has a very complicated infiltration scheme .		others threatActor_name others others others others others others others others
It involves numerous steps and requires good coordination between all of them .		others others others others others others others others others others others others others
In addition , none of the files in the file system can be detected as malicious due to the use of encryption and fileless technologies .		others others others others others others others others others others others others others others others others others others others others others others others others others others
One other feature that makes detection harder is the mimicking of well-known software .		others others others others others others others others others sub_activity sub_activity sub_activity sub_activity others
Regarding campaign activity , we have not detected any current activity related to the Titanium APT .		others others others others others others others others others others others others others others threatActor_name others others