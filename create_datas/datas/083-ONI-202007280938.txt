NIGHT OF THE DEVIL : RANSOMWARE OR WIPER ?		others others others others others others others others others
A LOOK INTO TARGETED ATTACKS IN JAPAN USING MBR-ONI .		others others others attack_activity attack_activity others location others malware others
Release_Time : 2017-10-31 .		others others others others
Report_URL : https://www.cybereason.com/blog/night-of-the-devil-ransomware-or-wiper-a-look-into-targeted-attacks-in-japan .		others others others others others others
For several months Cybereason has been following the concerning rise of ONI , a family of ransomware involved in targeted attacks against Japanese companies .		others others others security_team others others others others others others others malware others others others others others others others others others others company company others
We suspect that the ONI ransomware was used as a wiper to cover up an elaborate hacking operation .		others others others others malware malware others others others others others others others others others others others others others
These targeted attacks lasted between three to nine months and all ended with an attempt to encrypt hundreds of machines at once .		others attack_activity attack_activity others others others others others others others others others others others others others attack_goal attack_goal attack_goal attack_goal others others others
Forensic artifacts found on the compromised machines show that the attackers made a significant attempt to cover their operation .		others others others others others others others others others others others others others others others others others others others others
During our investigation , Cybereason discovered a new bootkit ransomware dubbed “ MBR-ONI ” used by the same threat actor in conjunction with ONI .		others others others others security_team others others others others others others others malware others others others others others others others others others others malware others
This bootkit ransomware is based on DiskCryptor , a legitimate disk encryption utility , the very same tool whose code was found in the recently discovered Bad Rabbit ransomware .		others malware malware others others others tool others others others others others others others others others others others others others others others others others others others malware malware malware others
While the ransomware discussed in this report is specific to Japan , targeted attacks involving ransomware/wipers have been on the rise across the world in recent years , which is why we ’re releasing this research .		others others others others others others others others others others location others others others others others others others others others others others others others others others others others others others others others others others others others others others
We believe that sharing information on this operation can benefit the entire security community .		others others others others others others others others others others others others others others others
The Japanese security community has discussed ONI in blog posts , and while suspicions were raised that it might be involved in targeted attacks , no further context was provided at the time .		others location others others others others malware others others others others others others others others others others others others others others others others others others others others others others others others others others others
Cybereason researchers , though , were able to link ONI to targeted attacks in Japan and provide more context around the ransomware .		security_team others others others others others others others others malware others attack_activity attack_activity others location others others others others others others others others
In addition , Cybereason discovered MBR-ONI , a bootkit ransomware , which modifies the MBR and encrypts disk partitions .		others others others security_team others malware others others malware malware others others others others tool others others others others others
We concluded that both ONI and MBR-ONI stem from the same threat actor since they were used in conjunction in the same targeted attacks and their ransom note contains the same email address .		others others others others malware others malware others others others others person person others others others others others others others others others others others others others others others others others others others others others
Cybereason Japan analyzed a few instances of attacks that used the ONI ransomware against Japanese companies across different industries .		security_team location others others others others others others others others others malware malware others company company others others others others
These attacks share a very similar modus operandi .		others others others others others others others others others
Penetration vector : Spear-phishing emails carrying weaponized Office documents , which ultimately drop the Ammyy Admin RAT .		others others others attack_activity attack_activity others others tool tool others others others others others tool tool tool others
Reconnaissance , credential theft and lateral movement : Using the Ammyy Admin RAT and other hacking tools , the attackers mapped out the internal networks , harvested credentials and moved laterally , ultimately compromising critical assets , including the domain controller ( DC ) , to gain full control over the network .		others others others others others others others others others others tool tool tool others others others others others others person others others others others others others others others others others others others others others others others others others others tool tool others tool others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
Scorched earth policy : Log deletion and distribution of ONI via rogue Group Policy ( GPO ) : During the attack ’s last stage , a rogue group policy was created and pushed across the organization .		others others others others others others others others others malware others others tool tool others tool others others others others others others others others others others others others others others others others others others others others others others
Using autorun persistence , the group policy would fetch a batch script from the DC server , which would wipe Windows ’ event logs clean in attempt to cover the attackers ’ tracks and avoid log-based detection .		others others others others others tool tool others others others others others others others tool others others others others others OS_name others others others others others others others others others others others others others others others others others
In addition , the ONI binary file was also copied from the DC and executed , encrypting a large array of files .		others others others others malware malware malware others others others others others tool others others others others others others others others others others
MBR-ONI used against critical assets : While ONI was used against most of the endpoints , MBR-ONI was used on only a handful of endpoints .		malware others others others others others others malware others others others others others others others others malware others others others others others others others others others
These endpoints were critical assets such as an AD server and file servers .		others others others others others others others others tool tool others tool tool others
We suspect that MBR-ONI was used as a wiper to conceal the operation ’s true motive .		others others others malware others others others others others others others others others others others others others others
We have also observed instances in which this distribution between the two ransomware was different , where MBR-ONI was used primarily .		others others others others others others others others others others others others others others others others others malware others others others others
The penetration vector used in the observed attacks consisted of spear-phishing emails that carried password-protected zip files containing weaponized Office documents .		others tool tool others others others others others others others attack_activity attack_activity others others others tool tool others others tool tool others
Once the victims extracted the zip file and opened the document , they were lured into enabling a macro .		others person person others others others others others others reference_word reference_word others others others others others others others tool others
That launched a VBScript that downloaded and executed the Ammyy Admin RAT .		others others others malware others others others others others tool tool tool others
Once installed , Ammyy Admin runs as a service ( “ Time service ” ) with SYSTEM privileges .		others others others tool tool others others others others others others others others others others others others others others
The hash of the Ammyy Admin binary is unknown to VirusTotal and other threat intel engines ( 6abfb50b0657e87d8aec594ccc95f2e1b13f355e ) .		others others others others tool tool tool others others others security_team others others others others others others sha1 others others
The earliest indication of the Ammyy Admin RAT on the compromised environment dates back to December 2016 .		others others others others others tool tool tool others others others others others others others time time others
The RAT was used in some instances until September 2017 .		others tool others others others others others others time time others
This indicates that the attack were carried over a period at least nine months .		others others others others others others others others others others others others others others others
Ammyy Admin is a legitimate remote administration tool that attackers have hijacked and used for malicious activity , including attacks on financial institutions by a threat actor believed to be related to the Carbanak group .		tool tool others others others others others others others others others others others others others others others others others others others others others others others person person others others others others others others threatActor_name others others
Additionally , Ammyy Admin was involved in a supply-chain attack .		others others tool tool others others others others attack_activity attack_activity others
In that incident , threat actors compromised Ammyy Admin ’s website and replaced the installer with a trojanized version of the RAT .		others others others others person person others target_crowd target_crowd target_crowd target_crowd target_crowd others others others others others others others others others others malware others
Once the attackers gained foothold in the victim ’s environment , their next step was to compromise critical assets including file servers , application servers and the DC .		others others person others others others others others others others others others others others others others others others others others others tool tool others tool tool others others tool others
The attackers managed to move laterally within the internal network through shared network drives and other techniques .		others others others others others others others others others others others others others others others others others others
We suspect that the threat actor used the NSA-leaked exploit EternalBlue , in conjunction with other tools to spread throughout the network .		others others others others person person others others others others vul_aliases others others others others others others others others others others others others
Due to the data corruption and robust log wiping , it cannot be confirmed with absolute certainty , however , it was found that the MS17-010 security update ( released in March 2017 ) was not installed on the compromised machines at the time that attacks took place ( July-September 2017 ) .		others others others others others others others others others others others others others others others others others others others others others others others others others others vulnerability_cve others others others others others time time others others others others others others others others others others others others others others others others time time others others
ONI shares a lot of its code with GlobeImposter ransomware variants .		malware others others others others others others others malware others others others
While GlobeImposter variants are not known to spread via Eternal Blue , it has been reported that GlobeImposter was also used in targeted attacks that involved EternalBlue and other NSA-leaked exploits in the past .		others malware others others others others others others others vul_aliases vul_aliases others others others others others others malware others others others others others others others others vul_aliases others others others others others others others others
Eventually , the attackers gained domain admin and successfully compromised the DC and Active Directory servers , which enabled them to obtain full control over the network .		others others others person others others others others others others others tool others tool tool tool others others others others others others others others others others others others
Using GPO , the attackers deployed “ wiping ” scripts that resided on the compromised DC .		others tool others others person others tool tool tool tool others others others others others tool others
The purpose of those scripts was to delete event and security logs from the compromised machines and distribute the ONI/MBR-ONI ransomware as the last step of the operation .		others others others reference_word reference_word others others attack_goal attack_goal attack_goal attack_goal attack_goal others others others others others others others others others others others others others others others others others
The content of the “ clean.bat ” clearly indicates the deletion of more than 460 logs using the wevtutil command along with the “ cl ” flag , which clears events from the specified event log .		others others others others others sample_name others others others others others others others others others others others others tool tool others others others others others others others others others others others others others others others others others
Observed execution of test.bat script spawning xcopy.exe to copy ONI .		others others others others others others others others others malware others
ONI/MBR-ONI ( “ srvupd.exe ” , in some instances named “ oni.exe ” ) is copied from the compromised DC .		others others others sample_name others others others others others others others sample_name others others others others others others others tool others
ONI received its name based on the file extension that it appends to the files it encrypts .		malware others others others others others others others others others others others others others others others others others
The name ONI can mean “ devil ” in Japanese , and it also appears in the email address found in its ransom note .		others others malware others others others reference_word others others location others others others others others others others others others others others others others others others
“ Oninoy0ru ” translates into “ Night of the Devil ” in Japanese .		others malware others others others others others others others others others others location others
Cybereason observed other versions of ONI ’s ransom note that contained other email addresses whose username also included the string “ ONI ” .		security_team others others others others malware others others others others others others others others others others others others others others others others string others others
ONI seems to share code with GlobeImposter ransomware variants .		malware others others others others others malware others others others
Some routines are identical .		others others others others others
Example of one of the identified ONI ransomware samples .		others others others others others others malware others others others
SHA-1 hash : b7d33751d118fab6aedabfdf6a4ddf627e6cab02 .		others others others sha1 others
GlobeImposter ransomware variant .		malware others others others
SHA-1 hash : 4a850136af93b9918fb4290a2bf665c4f28201d1 .		others others others sha1 others
Aside from encrypting files on the infected machines , ONI can encrypt files on removable media and network drives .		others others others others others others others others others malware others sample_function sample_function others others others others others others others
Interestingly , the resources section found in ONI ’s PE file shows Russian language traces .		others others others others others others others malware others others tool others others location others others others
While this type of evidence could have been left there on purpose by the attackers as decoy , it can also suggest that the attacks were carried out by Russian speakers or , at the very least , that the ransomware was written by Russian speakers .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others location others others others others others others others others others others others others others others location others others
While most of the infected machines were infected with ONI , MBR-ONI has been observed only on a handful of machines .		others others others others others others others others others malware others malware others others others others others others others others others others
These machines consisted of the Active Directory server as well as other carefully selected critical assets .		others others others others others tool tool tool others others others others others others others others others
As mentioned earlier , there were instances where MBR-ONI was used primarily .		others others others others others others others others malware others others others others
The machines infected by MBR-ONI all exhibited the same ransom note , which contained the same message and same ID for all the infected machines , as opposed to ONI , which generates a unique ID per machine .		others others others others malware others others others others others others others others others others others others others others others others others others others others others others others others malware others others others others others others others others others
When examining the MBR of the infected machine , it is clear that the MBR-ONI modified the original MBR , as the first instructions consist of the familiar NOP-NOP-JMP , also used by DiskCryptor , which can be found on GitHub .		others others others tool others others others others others others others others others others malware others others others tool others others others others others others others others others program_language others others others others tool others others others others others others tool others
Further analysis of MBR-ONI confirms that the attackers used a modified version of a legitimate open-source tool called DiskCryptor .		others others others malware others others others others others others others others others others others others others others tool others
The tool , according to DiskCryptor ’s website , “ is an open encryption solution that offers encryption of all disk partitions , including the system partition.		others others others others others tool others others others others others others others others others others others others others others others others others others others others others others others
”  For example , when comparing the strings found in the MBR-ONI bootkit ransomware with the ones of the publicly-available DiskCryptor , the resemblance is quite evident .		others others others others others others others others others others others malware others others others others others others others others tool others others others others others others others
Error code strings found on the GitHub page of DiskCryptor : https://github.com/legiar/diskcryptor/blob/master/boot/boot_load.c .		others others others others others others tool others others tool others domain domain domain others
Unlike the notorious wiper NotPetya , MBR-ONI ’s code does allow for the recovery of the encrypted disk , given that the attackers supply the right decryption key .		others others others others malware others malware others others others others others others others others others others others others others others others others others others others others others others others
From a technical perspective , we classify this specimen as ransomware rather than a wiper .		others others others others others others others others others others others others others others others others
That being said , we suspect that the attackers never intended to provide recovery for the encrypted machines .		others others others others others others others others others others others others others others others others others others others
Instead , the program was meant to be used as a wiper to cover the attackers ’ footprints and conceal the attack ’s motive .		others others others others others others others others others others others others others others others others others others others others others others others others others others
The legitimate encryption utility , DiskCryptor , was recently abused by the threat actors behind Bad Rabbit .		others others others others others tool others others others others others others others others others malware malware others
Another example of a well-known ransomware that was also used in targeted attacks is the Mamba / HDDCryptor ransomware , which also uses DiskCryptor ’s open-source code .		others others others others others others others others others others others others others others others malware others malware others others others others others tool others others others others others
This example demonstrates the fine line between a legitimate disk encryption tool and malware .		others others others others others others others others others others others others others others others
How the tool is implemented changes its original purpose and gives the tool a different context , such as a bootkit ransomware or even a destructive wiper .		others others others others others others others others others others others others others others others others others others others others malware malware others others others others others others
Classifying ONI and MBR-ONI merely as ransomware leaves some open questions regarding the observed attacks .		others malware others malware others others others others others others others others others others others others
There ’s enough evidence to suggest that ONI and MBR-ONI worked more like wiper attempting to cover up an ongoing hacking operation by destroying data instead of a ransomware attack that encrypted files .		others others others others others others others others malware others malware others others others others others others others others others others others others others others others others others others others others others others others others
There are a couple of points worth raising in the context of these attacks .		others others others others others others others others others others others others others others others
Why use two types of ransomware in the same operation?		others others others others others others others others others others others
Why does ONI use unique IDs on each machine while MBR-ONI uses the same ID across all the machines it infects?		others others malware others others others others others others others malware others others others others others others others others others others others
This inconsistency between the two ransomware programs is very peculiar .		others others others others others others others others others others others
It is very unlikely that an attacker would not be interested in distinguishing between infected machines .		others others others others others others others others others others others others others others others others others
That also supports our suspicion that there was never an intention to recover the encrypted disk partitions .		others others others others others others others others others others others others others others others others others others
In addition to the ransomware , the attackers used a batch file whose purpose was to thoroughly clear more than 460 Windows ’ event logs .		others others others others others others others others others others others others others others others others others others others others others OS_name others others others others
This robust log-wiping action shows that the attackers wanted to destroy evidence that could potentially lead to the discovery of their methods as well as the motive behind the attack .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Why spend three to nine months in the environment without a sure plan to make money?		others others others others others others others others others others others others others others others others others
From a cost-effectiveness perspective , there is no guarantee the attacker will be rewarded with a ransom payment at the end of this long operation , despite sustaining an active operation and risking detection .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
In this blog , we showed that ONI and the newly discovered MBR-ONI stem from the same threat actor , shed light on the threat actor ’s modus operandi and gave context that can better explain these supposed ransomware attacks .		others others others others others others others malware others others others others malware others others others others person person others others others others others others others others others others others others others others others others others others others others others others others
While both ONI and MBR-ONI clearly exhibit all the characteristics of ransomware , we provided arguments that support our suspicion that the attackers might have intended to use them as wipers rather than ransomware .		others others malware others malware others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
We do not dismiss the possibility that financial gain was the motive behind these attacks .		others others others others others others others others others others others others others others others others
However , given the nature of the attacks and the profile of the targeted companies , other motives should not be dismissed lightly .		others others others others others others others others others others others others others others others others others others others others others others others others
While the ONI attacks presented in this blog are specific to Japan , we believe they also point to a concerning global trend .		others others attack_activity attack_activity others others others others others others others location others others others others others others others others others others others others
Using ransomware in targeted hacking operations is still quite uncommon compared to the popularity of ransomware in the overall cyber threat landscape .		others others others others others others others others others others others others others others others others others others others others others others others
In recent years , though , there have been increased reports about ransomware and wipers used in targeted attacks carried out by cybercriminals and nation-states .		others others others others others others others others others others others others others others others others others others others others others others others others others others
Examples of these ransomware and/or wipers include : PetWrap , Mamba , SamSam , NotPetya , Shamoon and Bad Rabbit .		others others others malware malware malware others others malware others malware others malware others malware others malware others malware malware others
We also discussed how threat actors abuse legitimate tools like DiskCryptor and Ammyy Admin and use them for malicious purposes .		others others others others person person others others others others tool others tool tool others others others others others others others
This further emphasizes the fine line between publicly available tools and malware .		others others others others others others others others others others others others others
In many cases , this distinction can only be determined by figuring out the operator ’s intent .		others others others others others others others others others others others others others others others others others others others
For instance , MBR-ONI borrows a large portion of its code from DiskCryptor .		others others others malware others others others others others others others others tool others
With some code modification , a legitimate disk encryption utility can be turned into ransomware or even a destructive wiper .		others others others others others others others others others others others others others others others others others others others others others