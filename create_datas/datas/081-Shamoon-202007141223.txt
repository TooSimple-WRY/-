The Full Shamoon: How the Devastating Malware Was Inserted Into Networks Release_Time : 2017-1-15 Report_URL : https://securityintelligence.com/the-full-shamoon-how-the-devastating-malware-was-inserted-into-networks/ Shamoon :  Researchers from the IBM X-Force Incident Response and Intelligence Services ( IRIS ) team identified a missing link in the operations of a threat actor involved in recent Shamoon malware attacks against Gulf state organizations .		others others malware others others others others others others others others others others others others others others others others others malware others person others others security_team security_team security_team security_team security_team security_team security_team security_team security_team security_team security_team others others others others others others others others others others others others others others sub_activity sub_activity sub_activity others location location others others
These attacks , which occurred in November 2016 and January 2017 , reportedly affected thousands of computers across multiple government and civil organizations in Saudi Arabia and elsewhere in Gulf states .		reference_word reference_word others others others others time time others time time others others others others others others others others others others others others others location location others others others location location others
Shamoon is designed to destroy computer hard drives by wiping the master boot record ( MBR ) and data irretrievably , unlike ransomware , which holds the data hostage for a fee .		malware others others others attack_goal attack_goal attack_goal attack_goal others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others others others others others others others others others others others others others
Through their recent investigations , our forensics analysts pinpointed the initial compromise vector and post-compromise operations that led to the deployment of the destructive Shamoon malware on targeted infrastructures .		others others others others others others person person others others others others others others others others others others others others others others others others malware others others others others others
It ’s worth mentioning that , according to X-Force IRIS , the initial compromise took place weeks before the actual Shamoon deployment and activation were launched .		others others others others others others others others others security_team security_team others others others others others others others others others others malware others others others others others others
Since Shamoon incidents feature the infiltration and escalation stages of targeted attacks , X-Force IRIS responders sought out the attackers ’ entry point .		others sub_activity sub_activity others others others others others others others others others others tool tool tool others others others others others others others others
Their findings pointed to what appears to be the initial point of compromise the attackers used : a document containing a malicious macro that , when approved to execute , enabled C2 communications to the attacker ’s server and remote shell via PowerShell .		others others others others others others others others others others others others others others person others others others others others others others others others others others others others others others others protocol others others others others others others others others others others others tool others
The document was not the only one discovered in the recent attack waves .		others others others others others others others others others others others others others others
X-Force IRIS researchers had been tracking earlier activity associated with similar malicious , PowerShell-laden documents themed as resumes and human resources documents , some of which related to organizations in Saudi Arabia .		security_team security_team person others others others others others others others others others others others others others others others others others others others others others others others others others others others location location others
This research identified several bouts of offensive activity that occurred in the past few months , which revealed similar operational methods in which the attackers served malicious documents and other malware executables from web servers to their targets to establish an initial foothold in the network .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Although Shamoon was previously documented in research blogs , the specific network compromise methods leading to the attacks have remained unclear in the reported cases .		others malware others others others others others others others others others others others others others others others others others others others others others others others others
X-Force IRIS researchers studied Shamoon ’s attack life cycle and observed its tactics at Saudi-based organizations and private sector companies .		security_team security_team person others malware others others others others others others others others others others others others others others others others others
This research led them to believe that the actor using Shamoon in recent attacks relied heavily on weaponized documents built to leverage PowerShell to establish their initial network foothold and subsequent operations :  Attackers send a spear phishing email to employees at the target organization .		others others others others others others others others person others malware others others others others others others others others others others others tool others others others others others others others others others others person others others attack_activity attack_activity sub_activity others target_crowd others others others others others
The email contains a Microsoft Office document as an attachment .		reference_word reference_word others others tool tool others others others others others
Opening the attachment from the email invokes PowerShell and enables command line access to the compromised machine .		sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others tool others others others others others others others others others others
Attackers can now communicate with the compromised machine and remotely execute commands on it .		person others others others others others others others others others others others others others others
The attackers use their access to deploy additional tools and malware to other endpoints or escalate privileges in the network .		others person others others others others others others others others others others others others others others others others others others others
Attackers study the network by connecting to additional systems and locating critical servers .		person others others others others others others others others others others others others others
The attackers deploy the Shamoon malware .		others person others others malware others others
A coordinated Shamoon outbreak begins and computer hard drives across the organization are permanently wiped .		others others malware others others others others others others others others others others others others others
X-Force IRIS identified the below malicious document .		security_team security_team others others others others others others
X-Force IRIS File name : cv_itworx.doc .		others others others others others sample_name others
X-Force IRIS MD5 : 45b0e5a457222455384713905f886bd4 .		others others others others md5 others
X-Force IRIS SHA256 : 528714aaaa4a083e72599c32c18aa146db503eee80da236b20aea11aa43bdf62 .		others others others others sha1 others
X-Force IRIS Hosting URL : http://mol.com-ho.me/cv_itworx.doc .		others others others others others url_evil url_evil url_evil others
Our researchers examined the domain that hosted the first malicious file , mol.com-ho.me .		others person others others others others others others others others others others domain_evil others
Per the domain ’s WHOIS record , an anonymized registrant registered com-ho.me in October 2016 and used it to serve malicious documents with similar macro activation features .		others others others others others protocol others others others others others others domain_evil others time time others others others others others others others others others others others others others
The following list of documents included :  cv.doc : f4d18316e367a80e1005f38445421b1f .		others others others others others others others sample_name others md5 others
cv_itworx.doc : 45b0e5a457222455384713905f886bd4 .		sample_name others md5 others
cv_mci.doc : f4d18316e367a80e1005f38445421b1f .		sample_name others md5 others
discount_voucher_codes.xlsm : 19cea065aa033f5bcfa94a583ae59c08 .		sample_name others md5 others
Health_insurance_plan.doc : ecfc0275c7a73a9c7775130ebca45b74 .		sample_name others md5 others
Health_insurance_registration.doc : 1b5e33e5a244d2d67d7a09c4ccf16e56 .		sample_name others md5 others
job_titles.doc : fa72c068361c05da65bf2117db76aaa8 .		sample_name others md5 others
job_titles_itworx.doc : 43fad2d62bc23ffdc6d301571135222c .		sample_name others md5 others
job_titles_mci.doc : ce25f1597836c28cf415394fb350ae93 .		sample_name others md5 others
Password_Policy.xlsm : 03ea9457bf71d51d8109e737158be888 .		sample_name others md5 others
These files were most likely delivered via spear phishing emails to lure employees into unwittingly launching the malicious payload .		others others others others others others others attack_activity attack_activity others others others others others others others others others others others
A closer review of the file names revealed “ IT Worx ” and “ MCI ” .		others others others others others others others others others security_team security_team others others others government others others
A search of the name IT Worx brings up a global software professional services organization headquartered in Egypt .		others others others others others security_team security_team others others others security_team security_team security_team security_team security_team others others location others
MCI is Saudi Arabia ’s Ministry of Commerce and Investment .		government others government government government government government government government government government others
It is possible these names were used in spear phishing emails because they would seem benign to Saudi-based employees and lure them to open the attachment .		others others others others others others others others attack_activity attack_activity others others others others others others others others others others others others others others others others others
X-Force IRIS researchers further identified that the threat actor behind the malicious documents served many of them using a URL-shortening scheme in the following pattern : briefl.ink/{a-z0-9}[5] .		security_team security_team person others others others others others others others others others others others others others others others others others others others others others others others url_evil url_evil url_evil url_evil url_evil url_evil url_evil others
File Detail : Info File name : job_titles_itworx.doc .		others others others others others others others sample_name others
MD5 : 43fad2d62bc23ffdc6d301571135222c .		others others md5 others
SHA256 : e5b643cb6ec30d0d0b458e3f2800609f260a5f15c4ac66faf4ebf384f7976df6 .		others others sha1 others
Hosting URL : http://briefl.ink/qhtma .		others others others url_evil url_evil url_evil others
Passive DNS results on a communications domain associated with the Shamoon attack revealed related network infrastructure , identifying additional domains used by the threat actors .		others protocol others others others others others others others others malware others others others others others others others others others others others others others others others
Domain Name : Spoofed Site ntg-sa.com The domain ntg-sa.com appears to spoof the legit domain ntg.sa.com associated with the Namer Trading Group .		others others others others others url_evil others others url_evil others others others others others others url others others others company company company others
Per their webpage , NTG “ was established primarily to cater the growing demands of Petrochemicals waste management within the Kingdom of Saudi Arabia ” .		others others others others string others others others others others others others others others others others others others others others others others others others others others
maps-modon.club : The maps-modon.club domain appears to spoof maps.modon.gov.sa , which is associated with the Saudi Industrial Property Authority , an organization “ responsible for the development of industrial cities with integrated infrastructure and services ” .		url_evil others others url_evil others others others others url others others others others others others company company company company others others others others others others others others others others others others others others others others others others
X-Force IRIS discovered that the threat actor was hosting at least one malicious executable on a server hosted on ntg-sa.com .		security_team security_team others others others person person others others others others others others others others others others others others url_evil others
This file duped targets into believing it was a Flash player installer that would drop a Windows batch to invoke PowerShell into the same C2 communications .		others others others others others others others others others tool tool others others others others others others others others others tool others others others protocol others others
Analysis of one of the threat actor ’s documents found that if the macro executes , it launches two separate PowerShell Scripts .		others others others others others person person others others others others others others others sub_activity sub_activity others others others others others tool others others
The first one executes a PowerShell script served from http://139.59.46.154:3485/eiloShaegae1 .		malware malware malware others others tool others others others url_evil url_evil url_evil others
The host is possibly related to attacks that served the Pupy RAT , a publicly available cross-platform remote access tool .		others others others others others others others others others others tool tool others others sample_function sample_function sample_function sample_function sample_function others others
The second script calls VirtualAlloc to create a buffer , uses memset to load Metasploit-related shellcode into that buffer and executes it through CreateThread .		malware malware malware others function others others others others others others function others others others others others others others others others others others function others
Metasploit is an open source framework popular as a tool for developing and executing exploit code against a remote target machine .		tool others others others others others others others others others others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
The shellcode performs a DWORD XOR of 4 bytes at an offset from the beginning of the shellcode that changes the code to create a loop so the XOR continues 0x57 times .		others others others others encryption_algo encryption_algo others others others others others others others others others others others others others others others others others others others others others others others others others others others
If this execution is successful , it creates a buffer using VirtualAlloc and calls InternetReadFile in a loop until all the file contents are retrieved from http://45.76.128.165:4443/0w0O6 .		others others others others others others others others others others others function others others function others others others others others others others others others others others url_evil url_evil url_evil others
This is then returned as a string to PowerShell , which calls invoke-expression ( iex ) on it , indicating that the expected payload is PowerShell .		others others others others others others others others tool others others others function function function function others others others others others others others others others tool others
Of note , the macro contained a DownloadFile() function that would use URLDownloadToFileA , but this was never actually used .		others others others others sub_activity others others function function function others others others others function others others others others others others others others
Based on observations associated with the malicious document , we observed subsequent shell sessions probably associated with Metasploit ’s Meterpreter that enabled deployment of additional tools and malware preceding deployment of three Shamoon-related files : ntertmgr32.exe , ntertmgr64.exe and vdsk911.sys .		others others others others others others others others others others others others others others others others others tool malware malware malware others others others others others others others others others others others others others others others sample_name others sample_name others sample_name others
Although the complete list of Shamoon ’s victims is not public , Bloomberg reported that in one case , thousands of computers were destroyed at the headquarters of Saudi ’s General Authority of Civil Aviation , erasing critical data and bringing operations to a halt for several days .		others others others others others malware others others others others others others others others others others others others others others others others others others others others others others others government government government government government government government government others others others others others others others others others others others others others others
The recent activity X-Force IRIS is seeing from the Shamoon attackers has so far been detected in two waves , but those are likely to subside following the public attention the cases have garnered since late 2016 .		others others others security_team security_team others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others time others
Saudi Arabia released a warning to local organizations about the Shamoon malware , alerting about potential attacks and advising organizations to prepare .		location location others others others others others others others others malware others others others others others others others others others others others others
Analysis and warnings about Shamoon are resulting in preparation on the targets ’ end , and actors are likely to disappear and change their tactics until the next wave of attacks .		others others others others malware others others others others others others others others others others others others others others others others others others others others others others others others others others others