Targeted Attacks in the Middle East Using KASPERAGENT and MICROPSIA .		others others others others location location others malware others malware others
Release_Time : 2017-04-05 .		others others others others
Report_URL : https://unit42.paloaltonetworks.com/unit42-targeted-attacks-middle-east-using-kasperagent-micropsia/ .		others others others others others others
This blog is the result of joint research between Unit 42 and Eyal Sela ClearSky Cyber Security .		others others others others others others others others others security_team security_team others person person security_team security_team security_team others
Over the past few months Palo Alto Networks have been working together with ClearSky on preventing and detecting targeted attacks in the Middle East using two relatively new Microsoft Windows malware families which we call KASPERAGENT and MICROPSIA .		others others others others others security_team security_team security_team others others others others others security_team others others others others others others others others location location others others others others OS_name OS_name others others others others others malware others malware others
In addition , our research has uncovered evidence of links between attacks using these two new malware families and two families of Google Android malware we are calling SECUREUPDATE and VAMP .		others others others others others others others others others others others others others others others others others others others others others others OS_name OS_name others reference_word others others malware others malware others
We named the first new Microsoft Windows malware family “ KASPERAGENT ” based on strings we found in the malware .		reference_word others others others others OS_name OS_name others others others malware others others others others others others others others others others
( Note that we DO NOT believe this is a reference to Kaspersky Lab ) .		others others others reference_word others others others others others others others others security_team security_team others others
We named the second new Microsoft Windows malware family MICROPSIA because the malware is very tightly packed making it appear smaller than it is , similar to the human condition micropsia .		reference_word others others others others OS_name OS_name others others malware others others others others others others others others others others others others others others others others others others others others others others
We named the first new Google Android malware family SECUREUPDATE because it masks its malicious updates a secure updates .		reference_word others others others others OS_name OS_name others others malware others others others others others others others others others others
We named the second new Google Android malware family VAMP because it ’s focused on stealing data .		reference_word others others others others OS_name OS_name others others malware others others others others others others others others others
The attacks are not highly sophisticated , but the themes used , organizations and geographies targeted , as well the persistence of the attacker suggest a determined and noteworthy adversary .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Some of this activity has been covered in a recent post by 360 security , however there is still a great deal of extra detail we are able to add in this report .		others others others others others others others others others others others others security_team security_team others others others others others others others others others others others reference_word others others others others others others others others
Starting in March 2016 , Palo Alto Networks began monitoring this threat following the successful prevention of the execution of a sample of the KASPERAGENT malware on a customer system , however the malware had likely already been used in attacks as early as July , 2015 .		others others time time others security_team security_team security_team others others others others others others others others others others others others others others others others malware others others others others others others others others others others others others others others others others others others others time time time others
At the time of writing , we have uncovered :  113 samples of the KASPERAGENT malware .		others others others others others others reference_word others others others others others others others malware others others
94 samples of the MICROPSIA malware .		others others others others malware others others
17 samples of Android Malware which are related to this activity .		others others others OS_name others others others others others others others others
39 command and control domains registered in relation to this activity .		others others others others others others others others others others others others
Most of the attacks discovered so far target users in the United States , Israel , Palestinian Territories , and Egypt ; although there are occasional outliers .		others others others others others others others others others others others location location others location others location location others others location others others others others others others others
Notable outliers include media organizations in a variety of countries .		others others others others others others others others others others others
This post will begin by exploring how the attackers attempt to gain a foothold into target networks before briefly describing the malware families used .		others others others others others others others others others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others others others others others others others others
This group of attackers favors using URL shortening services to disguise the true links they are sending in spear phishing emails .		reference_word reference_word others others others others tool tool tool others others others others others others others others others attack_activity attack_activity others others
In particular , a number of samples we analyzed were linked via the URL shortening service “ bit.ly ” .		others others others others others others others reference_word others others others others others tool tool tool others domain others others
The URL shortening service then redirects users to the malicious payload hosted on attacker controlled pages , with the malicious payload nearly always contained in an archive file ( most commonly a RAR file . )		others tool tool tool others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Sending spear phishing emails with direct links to malicious shortened URLs was not the only method employed by the attackers to entice users to install the malware , another method favored by the attackers was the setting up of fake news sites .		others attack_activity attack_activity others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
We are unable to confirm how traffic was driven to these sites , the attackers may have helped drive traffic via fake social media accounts , or they may have sent spear phishing links to these pages .		reference_word others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others attack_activity attack_activity others others others others others
During our analysis , we discovered two distinct malware families which for the most part leveraged distinct infrastructure with no overlaps , initially leading us to categorize these campaigns separately .		others others others others reference_word others others others others others others others others others others others others others others others others others others others others others others others others others others
Later , we discovered a key link between the two sets of activity which leads us to believe they are related .		others others reference_word others others others others others others others others others others others others others others others others others others others
The MICROPSIA activity centers around domains registered using the email address adam.swift.2016@gmail.com – and no samples of KASPERAGENT talk to these domains .		others malware others others others others others others others others others email_evil email_evil email_evil others others others others others malware others others others others others
However , one of the domains ( drive.acount-manager.net ) registered by this address was used to host a sample ( babf156ede8b5c2e6c961b6ffcccc5eb7a3d283b398370754061613f439d40f9 ) of KASPERAGENT , causing us to link the two sets of activity .		others others others others others others others url_evil others others others others others others others others others others others others sha2 others others malware others others reference_word others others others others others others others others
We have named the most common malware involved in this campaign , KASPERAGENT , due to PDB strings left behind in many samples of the malware .		reference_word others others others others others others others others others others others malware others others others others others others others others others others others others others others
An example of a PDB string left behind is given below :  c:\Users\USA\Documents\Visual Studio 2008\Projects\New folder ( 2 )\kasper\Release\kasper.pdb This analysis is based on the following file :  SHA256: babd654ef363e0645ce374dd9e2a42afe339c52f1cf17fc2285d8bebd3cfa11e .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others encryption_algo others sha2 others
The file is compressed using the legitimate tool “ mpress.exe ” and once executed drops the payload to the directory C:\vault\igfxtray.exe which has the SHA256 hash f26caee34184b6a53ecbc0b5ce1f52e17d39af2129561dd6361fb4d4364e2c8b .		others others others others others others others others others tool others others others others others others others others others others sample_name sample_name sample_name others others others others others sha2 others
The malware also drops a decoy document containing Arabic names and ID numbers to the same folder and displays it to the user .		reference_word reference_word others others others others others others others others others others others others others others others others others others others others others others
KASPERAGENT is developed in Microsoft Visual C++ and attempts to disguise itself as a product that does not exist : “ Adobe Cinema Video Player ” .		malware others others others tool tool tool others others others others others others others others others others others others others others others others others others others others
The malware first establishes persistence using the classic method of adding a Run key , using the value “ MediaSystem ” .		reference_word reference_word others others others others others others others others others others others others others others others others others string others others
The malware connects to a C2 serverhosted on www.mailsinfo.net .		reference_word reference_word others others others others others others domain_evil others
The C2 server string in the binary is “ obfuscated ” in the most basic of senses , with the author adding ‘ @ ’  characters between letters and splitting the starting “ www.m ” to another string .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Most of the samples of KASPERAGENT use “ Chrome ” as the user agent , but this recent sample uses “ OPAERA ” , possibly a misspelling of “ Opera ” , the browser .		others others others others others malware others others tool others others others others others others others others others others others others string others others others others others others others tool others others others others others
The malware communicates with the C2 server via HTTP requests and in the most recent samples observed the callbacks are made to PHP scripts whose names relate to towns or navigation .		reference_word reference_word others others others tool tool others protocol others others others others others others others others others others others others others program_language others others others others others others others others others
Example URLs used include :  GET request to /dad5/town.php .		others others others others others others others others sample_name others
POST request to /dad5/addCity.php and /dad5/sign.php .		others others others sample_name others sample_name others
Most examples of the malware are nearly identical , and the malware simply acts as a basic reconnaissance tool and downloader for further payloads , however some examples of the malware include extended capabilities beyond that of a simple downloader .		others others others reference_word reference_word others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Examples of the extended-capability KASPERAGENT samples include :  a52d3e65fe5bbf57bab79b1c5092b66d9650247249b72f667a927f266d09efe6 c9ffb81a97a9458f1fc96f35cd187b1d7311479e77d031586abdc3d426da0859 7f11e0bbc892a97b7c42416c43fe178ebb240939d9dee70c3c598305ce8a2d4f .		others others others others malware others others others sha2 sha2 sha2 others
These extended-capability samples connect to www.stikerscloud.com and implement the following additional functionality :  Theft of passwords for Firefox and Chrome browsers .		others others others others others domain_evil others others others others others others others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
Take screenshots Recording user keystrokes Exfiltrate basic environment information such as the username and computer name Perform arbitrary commands Enumerate removable drives and copy files of interest to a new folder for exfiltration Update the malware to a new version Exfilitrate arbitrary files ( zip compressed and encrypted ) .		sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
It ’s also worth mentioning that sometimes that both versions of the malware are wrapped in a Microsoft .NET Framework loader which is responsible for deploying the malware and displaying the decoy document .		others others others others others others others others others others others others reference_word reference_word others others others others tool tool tool others others others others others others others others others others others others others others
The author ( imaginatively ) calls this wrapper ‘ Loader ’ an example of this is the file is 4c1973278a30d1b4ce206eca63676624d234260758a0674d191d338a02914d23 , which contains the PDB string : C:\Users\Yousef\Desktop\MergeFiles\Loader v0\Loader\obj\Release\Loader.pdb The MICROPSIA malware family is written in Delphi and is an information stealing malware family with a wide range of data theft functionality built in .		others others others others others others others others others others others others others others others others others others others sha2 others others others others others others others sample_name sample_name sample_name sample_name others malware others others others others others tool others others others others others others others others others others others others others others others others others others
This analysis is based on the following sample :  SHA256: 6e461a8430f251db38e8911dbacd1e72bce47a89c28956115b702d13ae2b8e3b We named the malware MICROPSIA because of the way it is often packaged .		others others others others others others others others others others others sha2 reference_word others others others malware others others others others others others others others others
The malware is often delivered as a RAR , which once extracted contains an EXE , which is further packed using UPX .		reference_word reference_word others others others others others tool others others others others others others string others others others others others others tool others
Once unpacked from UPX , the next level is a further SFX RAR file , which then contains the actual malware files within .		others others others tool others others others others others others others string string others others others others others others others others others others others
This effectively means the initial payload is extremely compressed and appears much smaller than it really is .		others others others others others others others others others others others others others others others others others others
The final payload contains four legitimate executables as resources :  Two embedded DLLs relating to the OpenSSL library used for traffic encryption .		others others others others others others others others others others others others others others others others tool others others others others others others
A copy of a command line version of WinRAR – used for encrypting and compressing the exfiltrated data .		others others others others others others others others tool others others others others others others others others others others
The file ‘ shortcut.exe ’ from optimumx.com ( Creates , modifies or queries Windows shell links ) .		others others others sample_name others others domain others others others others others others others others others others others
this is used for persistence by creating a link in the startup folder to the payload .		others others others others others others others others others others others others others others others others others
The malware begins execution by first copying itself to a predefined location , setting up persistence via an LNK file ( hence the inclusion of the aforementioned shortcut.exe ) The main capabilities of the malware are as follows :  Logging of keystrokes to a hardcoded text file and exfiltration to a remote server .		reference_word reference_word others others others others others others others others others others others others others others others others others others others others others others others others others sample_name others others others others others reference_word reference_word others others others others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
Capturing screenshots of the infected machines .		sample_function sample_function sample_function sample_function sample_function sample_function others
Searching for files with extensions matching Microsoft Office documents and using WinRAR to archive these prior to exfiltration .		sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
Example syntax of the command used is as follows :  " Rar.exe a -r -ep1 -v2500k -hpd58ccc009be55ff172a9039bf35cf270 -ta2016-12-11 ProgramData\Recovery\bin\sys\sysTime\LMth_E E:\*.xls E:\*.doc " . "		others others others others others others others others others others others string string string string string string string string string string string string string string string string string string others string others
Rar.exe a -r -ep1 -v2500k -hpd58ccc009be55ff172a9039bf35cf270 -ta2016-12-11 ProgramData\Recovery\bin\sys\sysTime\LMth_E E:\*.xls E:\*.doc " .		string string string string string string string string string string string string string string string string string string others string
The value “ d58ccc009be55ff172a9039bf35cf27 ” is used to encrypt exfiltrated documents and appears to be an MD5 hash , but we have not identified a string that maps to this hash .		others others others md5 others others others others others others others others others others others others others others others others reference_word others others others others others others others others others others others
Interestingly in some cases the attackers combined an attempt to infect targeted users with malware , with an attempt to steal their credentials via traditional phishing techniques .		others others others others others others others others others others others others others others others others others others others others attack_goal attack_goal attack_goal others attack_activity attack_activity attack_activity others
The attackers sometimes directed users to sites spoofing legitimate services such as Google Drive to download the malware , however first the target users would be asked to fill in their credentials in , giving the attackers two chances to successfully steal target users ’ data ( via the phish and via the eventual malware infection ) :  Whilst a large number of the domains associated with the adam.swift.2016@gmail.com email address are associated with MICROPSIA samples , some have been observed hosting Android apps or acting as C2 domains for Android malware samples .		others others others others others others others others others others others others tool tool others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others email_evil email_evil email_evil others others others others others malware others others others others others others others OS_name others others others others others others others OS_name others others others
Analysis of these apps shows these are also malicious , and the apps also contain some social engineering tricks to enable installation .		others others others others others others others others others others others others others others others others others others others others others others others
There are two main APK malware families used by the threat actor .		others others others others others others others others others others others others others
The first is a malware family used to gain a foothold on to the device , it is effectively a downloader with no additional functionality and we call this malware SECUREUPDATE .		others others others others others others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others others others others others others others others others others others reference_word others others others malware others
In the sample we analyzed ( 6b4d65abf95cfb3cedd39b217ff0e4ee2229ae32aeda5170f34c5a3b9c5a0f3 ) the malware used the local calendar to sleep , creating an alarm in the future , at which point the malware would call back to receive an “ Update ” :  In a similar vein to the ‘ a side of phishing ’ section , some of the versions of SECUREUPDATE backdoor attempt to steal credentials for users , making them create accounts for these fake apps in addition to the installation of the malware .		others others others reference_word others others sha2 others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others attack_activity others others others others others others others others malware others others others attack_goal attack_goal attack_goal attack_goal others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
This technique relies on credential re-use across many accounts but will still yield some success for the attackers :  The second malware family is a malware family we call VAMP , which is already described in great detail in the blog by 360 , VAMP is fully featured with all the capabilities you ’d expect from a malware family that resides on a phone .		others others others others others others others others others others others others others others others others others others others others others others others others others others others reference_word others malware others others others others others others others others others others others others security_team others malware others others others others others others others others others others others others others others others others others others others others others
Features of the malware include :  Ability to record calls Contact theft Theft of documents stored on the device Theft of messages .		others others reference_word reference_word others others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
Another outlier in terms of domains registered by adam.swift.2016@gmail.com  is the domain AppPure.info .		others others others others others others others others domain_evil domain_evil domain_evil others others others domain_evil others
From the outset , the site appears to be a legitimate page :  Although we have been unable to find malicious content hosted on this site , we believe that it is very likely that amongst the many legitimate apps available for download via this store some malicious apps may exist .		others others others others others others others others others others others others others others reference_word others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Through this campaign there is little doubt that the attackers have been able to gain a great deal of information from their targets .		others others others others others others others others others others others others others others others others others others others others others others others others
We have been unable to uncover any evidence which allows us to confidently attribute this campaign to any known threat actor at present .		reference_word others others others others others others others others others others others others others others others others others others others others others others others
The scale of the campaign in terms of sheer numbers of samples and the maintenance of several differing malware families involved suggests a reasonably sized team and that the campaign is not being perpetrated by a lone wolf , but rather a small team attackers .		others others others others others others others others others others others others others others others others others others reference_word reference_word others others others others others others others others others others others others others others others others others others others others others others others others others others
The campaign also illustrates that for some targets old tricks remain sufficient to run a successful espionage campaign , including use of URL shortening services , classic phishing techniques as well as using archive files to bypass some simple file checks .		others others others others others others others others others others others others others others others others others others others others others others tool tool tool others attack_activity attack_activity others others others others others others others others others others others others others others
Palo Alto Networks customers are defended from this threat in the following ways :  WildFire and Traps detect all of the malware discussed in this report as malicious .		security_team security_team security_team others others others others others others others others others others others counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure others
The C2 domains listed in this report are blocked through Threat Prevention .		counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure others
AutoFocus customers can monitor this activity by looking at the tags :  VAMP KASPERAGENT MICROPSIA SECUREUPDATE .		counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure counter_measure others malware malware malware malware others
Associated C2 Domains :  mediafreeuploader.co.uk appppure.net upload404.club upload999.net upload999.com upload999.org .		others reference_word reference_word others domain_evil domain_evil domain_evil domain_evil domain_evil domain_evil others
KASPERAGENT : 2c8a67f8118b6aef159dd280d5998b1c41edb406a1bc8e3960254a9642b6ae4b .		malware others sha2 others
KASPERAGENT : a72178289bb518f9f100b78e56a9425332bf3a5220a6c5abd3d07c669a5d8b25 .		malware others sha2 others
KASPERAGENT : 7fdf2bdc500a8703cceb76a427752ee70164b8283b4df42c5b13ed2124a88dbd .		malware others sha2 others
KASPERAGENT : 6926f430865bd08b621bd1c6581bfe77db3e9891b14f97d00563770186fc5e74 .		malware others sha2 others
KASPERAGENT : 46b0f586a646e800ab63d1404a08864fb09aca73a13fd22542a9fce038643219 .		malware others sha2 others
KASPERAGENT : e9050c541859f2fabff6dcd492df02a48dd32d99b1f3e98ef7c14bbb6aa734a2 .		malware others sha2 others
MICROPSIA : 453b9f7aed67f41ec192db3011459e2dd865bb729265c544ee1b8814c6e7dc53 .		malware others sha2 others
MICROPSIA : c9e55094b84a06b3a40b7df1cd76fc287fdc02a2cdd30af359743bbc23475917 .		malware others sha2 others
MICROPSIA : a627d2bff74ce07a619cc8fd36294f66eab94b92d41e50b06e63d736ffafd254 .		malware others sha2 others
MICROPSIA : f70681c7e8ab419fd0938802a823337abad936cccc0ace9ee232f2b874e561f1 .		malware others sha2 others
MICROPSIA : e3963ee9bf892d3f3eea0620585e2e773a30cf536c73a01dd51d6ce36f4daf5d .		malware others sha2 others
MICROPSIA : e2ac3cf79e7267d2e088c3a269aa84fc71fc6073019abb94d16a024d3ad16f3e .		malware others sha2 others
SECUREUPDATE : d909669b000c479b8bdd9f86fa62879a7c8b4dca8cde4f4a404862a4604c52e2 .		malware others sha2 others
SECUREUPDATE : b6abeffe986eb38e411a4fe956280e2028d8bef699d9dd3244bde721a99b1dee .		malware others sha2 others
SECUREUPDATE : c1564c56c46146db36ec97afd994c45f3621f39c82cc692adba5b9f6d9a62897 .		malware others sha2 others
SECUREUPDATE : c20438ba8c9e008c1e2eb4343f177757fc260437aeac52df61b156671b07ac14 .		url_evil others sha2 others
SECUREUPDATE : 5f3b4eddcc72598721b9ca395d1e5881acbd4fc562e09b688b2d42f65d3a4a93 .		url_evil others sha2 others
SECUREUPDATE : 544a1c303ef021f0d54e62a6147c7ae9cd0c84265e302f6da5ed08b616e45b78 .		malware others sha2 others
KASPERAGENT : C:\Users\USA\Documents\Visual Studio 2008\Projects\New folder ( 2 )\kasper\Release\kasper.pdb .		malware others sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name others
KASPERAGENT : C:\Users\Yousef\Desktop\MergeFiles\Loader v0\Loader\obj\Release\Loader.pdb .		malware others sample_name sample_name sample_name sample_name others
KASPERAGENT : c:\Users\USA\Documents\Visual Studio 2008\Projects\New folder ( 2 )\s7 – Copy – Copy 19-2-17\Release\s7.pdb .		malware others sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name others
KASPERAGENT : c:\Users\USA\Documents\Visual Studio 2008\Projects\New folder ( 2 )\s7\Release\s7.pdb .		malware others sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name sample_name others
KASPERAGENT : C:\Users\Progress\Desktop\Loader v0\Loader\obj\Release\Loader.pdb .		malware others sample_name sample_name sample_name sample_name others
KASPERAGENT : D:\Merge\Debug\testproj.pdb .		malware others sample_name sample_name sample_name others