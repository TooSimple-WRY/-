COMpfun authors spoof visa application with HTTP status-based Trojan Release_Time : 2020-05-14 Report_URL : https://securelist.com/compfun-http-status-based-trojan/96874/ You may remember that in autumn 2019 we published a story about how a COMpfun successor known as Reductor infected files on the fly to compromise TLS traffic .		malware others others others others others protocol others malware others others others others others others others others others others others others others time time reference_word others others others others others others malware others others others malware others others others others others others others protocol attack_goal others
If you ’re wondering whether the actor behind the malware is still developing new features , the answer is yes .		others others others others others others others others others others others others others others others others others others others others others others
Later in November 2019 our Attribution Engine revealed a new Trojan with strong code similarities .		time time time time others tool tool others others others malware others others others others others
Further research showed that it was obviously using the same code base as COMPFun .		others others others others reference_word others others others others others others others others malware others
The campaign operators retained their focus on diplomatic entities , this time in Europe , and spread the initial dropper as a spoofed visa application .		others others others others others others others others others others others others others location others others others others others malware others others others others others others
It is not clear to us exactly how the malicious code is being delivered to a target .		others others others others others others others others others others others others others others others others others others
The legitimate application was kept encrypted inside the dropper , along with the 32- and 64-bit next stage malware .		others others others others others others others others malware others others others others others others others others others others others
We observed an interesting C2 communication protocol utilizing rare HTTP/HTTPS status codes ( check IETF RFC 7231 , 6585 , 4918 ) .		others others others others tool others others others others protocol others others others others others others others others others others others others others
Several HTTP status codes ( 422-429 ) from the Client Error class let the Trojan know what the operators want to do .		others protocol others others others others others others others others others others others others malware others others others others others others others others
After the control server sends the status “ Payment Required ” ( 402 ) , all these previously received commands are executed .		others others others others others others others others others others others others others others others others others others others others others others others
The authors keep the RSA public key and unique HTTP ETag in encrypted configuration data .		others others others others encryption_algo others others others others protocol others others others others others others
Created for web content caching reasons , this marker could also be used to filter unwanted requests to the C2 .		others others others others others others others others others others others others others others others others others others others tool others
Those that are from network scanners rather than targets .		others others others others others others others others others others
Besides the aforementioned RSA public key to communicate with the C2 , the malware also uses a self-generated AES-128 key .		others others others encryption_algo others others others others others others tool others others others others others others others encryption_algo others others
We should mention here once again that the COMPfun malware was initially documented by G-DATA in 2014 ;  And although the company did not identify which APT was using the malware .		others others others others others others others others malware others others others others others security_team others time others others others others others others others others others others others others others others others
Based mostly on victimology , we were able to associate it with the Turla APT with medium-to-low level of confidence .		others others others others others others others others others others others others others threatActor_name threatActor_name others others others others others others
Its functions include the ability to acquire the target ’s geolocation , gathering host- and network-related data , keylogging and screenshots .		reference_word others others others others others others others sample_function sample_function sample_function sample_function others sample_function sample_function others sample_function sample_function others sample_function others sample_function others
In other words , it ’s a normal full-fledged Trojan that is also capable of propagating itself to removable devices .		others others others others others others others others others others malware others others others others others others others others others others others
As in previous malware from the same authors , all the necessary function addresses resolve dynamically to complicate analysis .		others others reference_word reference_word others others others others others others others others others others others others others others others others
To exfiltrate the target ’s data to the C2 over HTTP/HTTPS , the malware uses RSA encryption .		others others others others others others others others others tool others protocol others reference_word reference_word others encryption_algo others others
To hide data locally , the Trojan implements LZNT1 compression and one-byte XOR encryption .		others sample_function sample_function sample_function others others malware others sample_function sample_function others sample_function others sample_function others
Encrypted data : Exfiltrated keystrokes , screenshots Configuration data in .rsrc section Parameters inside the HTTP GET/POST requests Commands and arguments from C2 for HTTP status 427 ( dir , upl , usb , net ) .		others others others others others others others others others others others others others others others protocol protocol others others others others others tool others protocol others others others others others others others others others others others others
Algorithm : RSA XOR ( plus LZNT1 compression ) AES-128 ( plus ETag from config ) AES-128 .		others others encryption_algo encryption_algo others others others others others encryption_algo others others others others others others encryption_algo others
Key source : Public key from configuration data Hardcoded one-byte key Generated by Trojan and shared in beacon Generated by Trojan and shared in beacon .		others others others others others others others others others others others others others others others others others others others others others others others others others others
The first stage dropper was downloaded from the LAN shared directory .		others others others malware others others others others tool others others others
The file name related to the visa application process perfectly corresponds with the targeted diplomatic entities .		others others others others others others others others others others others others others others others others others
As with all modules with a similar code base , the dropper begins by dynamically resolving all the required Windows API function addresses and puts them into structures .		others others others others others others others others others others others malware others others others others others others others function function others others others others others others others others
It then decrypts the next stage malware from its resource ( .rsrc ) section .		others others others others others others others others others others others others others others others
The algorithm used to decrypt the next stage is a one-byte XOR using the key “ 0x55 ” , followed by LZNT1 decompression .		others others others others others others others others others others others encryption_algo others others others others others others others others others sample_function sample_function others
The following files are dropped to the disk in addition to the original application that the malware tries to mimic :  MD5 hash : 1BB03CBAD293CA9EE3DDCE6F054FC325 A6AFA05CBD04E9AF256D278E5B5AD050 .		others others others others others others others others others others others others others others others others others others others others others others others others md5 md5 others
File name : ieframe.dll.mui ExplorerFrame.dll.mui .		others others others sample_name sample_name others
Features : 64-bit Trojan version 32-bit Trojan version .		others others others malware others others malware others others
The dropper urges users to run the file as administrator ( using messages such as “ need to run as admin ” ) , then drops a version corresponding to the host ’s architecture and sets the file system timestamp to 2013.12.20 22:31 .		others malware others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others time time others
Interestingly , the dropper ’s abilities aren’t limited to PE lures ; as an alternative , this stage is also able to use .doc and .pdf files .		others others others malware others others others others others others others others tool others others others others others others others others others others others others others others others others others others
In such cases , the dropper will open the files using the “ open ” shell command instead of running the legitimate spoofed executable application .		others others others others others malware others others others others others others others others others others others others others others others others others others others others
Main module – HTTP status-based Trojan .		others others others protocol others malware others
710b0fafe5fd7b3d817cf5c22002e46e2a22470cf3894eb619f805d43759b5a3 a6afa05cbd04e9af256d278e5b5ad050 2015.06.26 09:42:27 ( GMT ) I386 Windows GUI DLL 593408 ExplorerFrame.dll.mui .		sha2 md5 time time others others others others others others others others sample_name others
The analysis below is based on the 32-bit sample from the table above .		others others others others others others others others others others others others others others
The legitimate ExplorerFrame.dll.mui is a language resource for the ExplorerFrame.dll file used by Windows Explorer .		others others sample_name others others others others others others sample_name others others others tool tool others
As usual in this malware family ’s code , a huge number of short standalone functions return all the readable strings .		others others others others others others others others others others others others others others others others others others others others others others others
This is done to complicate analysis by not allowing the strings to be visible at a glance for researchers .		others others others others others others others others others others others others others others others others others others others others
The module ’s preparation stage dynamically resolves all required Windows API function addresses into corresponding custom structures .		others others others others others others others others others others function function others others others others others others others
Afterwards the malware uses indirect function calls only .		others others others others others others others others others
The module obtains the processor architecture ( 32- or 64-bit ) and Windows OS version .		others others others others others others others others others others others others OS_name OS_name others others
It includes a number of anti-analysis checks for virtual machine-related devices ( VEN_VMWARE , VBOX_HARDDISK , Virtual_DVD_ROM , etc . )		others others others others others others others others others others others others tool others tool others tool others others others others
to avoid controlled execution .		others others others others others
It also notes which security products are running on the host ( Symantec , Kaspersky , Dr.Web , Avast ) .		others others others others others others others others others others others others security_team others security_team others security_team others security_team others others
Before every communication with the C2 , the malware checks if software such as debuggers ( WinDbg , OllyDbg , Visual Studio ) and host ( Process Explorer or Monitor , etc . )		others others others others others tool others others others others others others others others others others tool others tool others tool tool others others others others tool tool others tool others others others others
or network monitoring ( Wireshark , TCPView , etc . )		others others others others tool others tool others others others others
programs are running .		others others others others
It also checks for internet connectivity and does not attempt to communicate if the checks fail .		others others others others others others others others others others others others others others others others others
The DLL also checks for potentially available launch processes that it can inject itself into .		others tool others others others others others others others others others others others others others others
In the case of PaymentRequired , this could be system , security product or browser processes .		others others others others others others others others others others others others others others others others others
Then the malware forms the corresponding code to drop files , delete files , etc .		others others others others others others others others others others others others others others others others
The last step in the initialization procedure is to decrypt and decompress the configuration file .		others others others others others others others others others others others others others others others others
Decryption is done via a one-byte XOR using the 0xAA key , followed by decompression using the LZNT1 algorithm .		others others others others others others encryption_algo others others others others others others others others others others encryption_algo others others
From the configuration , the malware parses the RSA public key , ETag and IP addresses to communicate with its control servers .		others others others others others others others others encryption_algo others others others others others others others others others others others others others others
Firstly , the module generates the following :  AES-128 encryption key used in HTTP GET/POST parameters and HTTP status code 427 ( request new command ) ;  4-byte unique hardware ID ( HWID ) based on the host network adapters , CPU and first fixed logical drive serial number .		others others others others others others others others encryption_algo others others others others protocol protocol others others protocol others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The module then chooses a process to inject the code into , in order of decreasing priority , starting from Windows ( cmd.exe , smss.exe ) , security-related applications ( Symantec ’s nis.exe , Dr.Web ’s spideragent.exe ) and browsers ( IE , Opera , Firefox , Yandex browser , Chrome ) .		others others others others others others others others others others others others others others others others others others others others others others sample_name others sample_name others others others others others sample_name sample_name sample_name sample_name others sample_name sample_name sample_name sample_name others others others others tool others tool others tool others tool tool others tool others others
The main thread checks if the C2 supports TLS in its configuration .		others others others others others others tool others protocol others others others others
If it does , communication will be over HTTPS and port 443 ; otherwise , the HTTP protocol and port 80 are used .		others others others others others others others others protocol others others others others others others others protocol others others others others others others others
Config Parameter : Encryption key ETag C2 IPs .		others others others others others others others others others
Value : RSA public key on the image above C8E9CEAD2E084F58A94AEDC14D423E1A 95.183.49.10 95.183.49.29 200.63.45.35 .		others others encryption_algo others others others others others others sha1 IP_evil IP_evil IP_evil others
The first GET request sent contains an ETag “ If-Match ” header that is built using data from its decrypted configuration .		others others others others others others others tool others others others others others others others others others others others others others others
ETags are normally used by web servers for caching purposes in order to be more efficient and save bandwidth by not resending redundant information if an ETag value matches .		tool others others others others others others others others others others others others others others others others others others others others others others others others others tool others others others
The implementation of ETags means the C2 may ignore all requests that are not sent from its intended targets if they don’t have the required ETag value .		others others others tool others others tool others others others others others others others others others others others others others others others others others others others others tool others others
RFC status meaning : OK Payment Required Unprocessable Entity ( WebDAV ) Locked ( WebDAV ) Failed Dependency ( WebDAV ) Undefined HTTP status Precondition Required Too Many Requests .		tool others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Corresponding command functionality : Send collected target data to C2 with current tickcount This status is the signal to process received ( and stored in binary flag ) HTTP statuses as commands Uninstall .		others others others others sample_function sample_function sample_function sample_function others tool others others others others others others others others others others others others others others others others others others protocol others others others others others
Delete COM-hijacking persistence and corresponding files on disk Install .		sample_function sample_function sample_function others sample_function sample_function sample_function sample_function sample_function others
Create COM-hijacking persistence and drop corresponding files to disk Fingerprint target .		sample_function sample_function sample_function others sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
Send host , network and geolocation data Get new command into IEA94E3.tmp file in %TEMP% , decrypt and execute appended command Propagate self to USB devices on target Enumerate network resources on target .		sample_function sample_function others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_name sample_function others others others others others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others others others
HTTP 427 can receive any of the following appended commands :  Command functionality : Send directory content to C2 encrypted with RSA public key from config Send file to C2 encrypted with RSA public key from config Not implemented yet .		protocol others others others others others others others others others others others others others others others others others tool others others encryption_algo others others others others others others others tool others others encryption_algo others others others others others others others others
Possibly same function planned as for HTTP status 428 Not implemented yet .		others others others others others others protocol others others others others others others
Possibly same function planned as for HTTP status 429 .		others others others others others others protocol others others others
If initialization is successful , the malware starts one more thread for dispatching Windows messages , looking for removable devices related to a WM_DEVICECHANGE event .		others others others others others others others others others others others others others OS_name others others others others others others others others others others others others
The module runs its own handlers in the event of a USB device being plugged into or unplugged from the host .		others others others others others others others others others others others others others others others others others others others others others others
The user ’s activity is monitored using several hooks .		others others others others others others others others others others others
All of them gather the target ’s data independently of any C2 command .		others others others others others others others others others others others others tool others others
Keystrokes are encrypted using the RSA public key stored in the configuration data and sent once every two seconds , or when moreа than 512 bytes are recorded .		others others others others others encryption_algo others others others others others others others others others others others others others others others others others others others others others others others
These 512 characters also include left mouse button clicks ( written as the “ MSLBTN ” string ) and Windows title bar texts .		others others others others others others others others others others others others others others others others others others others OS_name others others others others
For clipboard content , the module calculates an MD5 hash and if it changes , encrypts the clipboard content with the same RSA public key and then sends it .		others others others others others others others others others others others others others others others others others others others others others others encryption_algo others others others others others others others
In a separate thread , the Trojan takes a bitmap screenshot using the GDIPlus library , compresses it with the LZNT1 algorithm , encrypts it using the key from the configuration data and sends it to the control server .		others others others others others others malware others others others others others others tool tool others others others others others encryption_algo others others others others others others others others others others others others others others others others others others others
A screenshot will be taken of the target and sent anyway , independently of any C2 command .		others others others others others others others others others others others others others others others tool others others
There are several choices – albeit not major additional technical ones – that the malware author made which we consider to be noteworthy .		others others others others others others others others others others others others others others others others others others others others others others others others
The COM-hijacking-based persistence method injects its corresponding code and structure as a parameter into a legitimate process ’s memory .		others others others others others others others others others others others others others others others others others others others others others
The malware geolocates victims using legitimate web services : geoplugin.net/json.gp , ip-api.com/json and telize.com/geoip .		others others others others others others others others others domain others domain others domain others
The unusual thread synchronization timeout calculation in the HTTP status thread is peculiar .		others others others others others others others others protocol others others others others others
Mathematically , the partial sum of the series is precisely :  We saw innovative approaches from the COMpfun developers twice in 2019 .		others others others others others others others others others others others reference_word others others others others others malware others others others time others
First , they bypassed TLS encrypted traffic via PRNG system function patching , and then we observed a unique implementation of C2 communications using uncommon HTTP status codes .		others others others others encryption_algo others others others tool tool others others others others others others others others others others others tool others others others protocol others others others
The malware operators retained their focus on diplomatic entities and the choice of a visa-related application – stored on a directory shared within the local network – as the initial infection vector worked in their favor .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The combination of a tailored approach to their targets and the ability to generate and execute their ideas certainly makes the developers behind COMPFun a strong offensive team .		others others others others others others others others others others others others others others others others others others others others others others others malware others others others others others
File MD5 Hashes : A6AFA05CBD04E9AF256D278E5B5AD050 1BB03CBAD293CA9EE3DDCE6F054FC325 .		others others others others md5 md5 others
IPs : 95.183.49.10 95.183.49.29 200.63.45.35 .		others others IP_evil IP_evil IP_evil others