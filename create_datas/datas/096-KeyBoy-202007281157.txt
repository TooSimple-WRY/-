The KeyBoys are back in town .		others others others others others others others
Release_Time : 2017-02-11 Report_URL : https://www.pwc.co.uk/issues/cyber-security-services/research/the-keyboys-are-back-in-town.html In this blog post , we detail our analysis of a recent campaign that we attribute , with high confidence , to KeyBoy , a threat actor believed to be based in or operating from China .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others threatActor_name others others others others others others others others others others others others location others
KeyBoy has been most recently reported on by CitizenLab in 2016 , and now appears to have returned .		threatActor_name others others others others others others others security_team others time others others others others others others others others
Our analysis starts with a Microsoft Word document named 2017 Q4 Work Plan.docx ( with a hash of 292843976600e8ad2130224d70356bfc ) , which was created on 2017-10-11 by a user called “ Admin ’ ’ , and first uploaded to VirusTotal , a website and file scanning service , on the same day , by a user in South Africa .		others others others others others company tool tool others time sample_name sample_name sample_name others others others others others md5 others others others others others others time others others person others others person others others others others others sub_activity sub_activity tool others others others others others others others others others others others others others others others person others location location others
Curiously , the Word document does not contain any macros , or even an exploit .		others others reference_word reference_word reference_word others others others others tool others others others others others others
Rather , it uses a technique recently reported on by SensePost , which allows an attacker to craft a specifically created Microsoft Word document , which uses the Dynamic Data Exchange ( DDE ) protocol .		others others reference_word others others others others others others others security_team others others others others person others others others others others company tool tool others others others others protocol protocol protocol others protocol others others others
DDE traditionally allows for the sending of messages between applications that share data , for example from Word to Excel or vice versa .		protocol others others others others sub_activity sub_activity sub_activity others sub_activity others others others others others others others tool others tool others others others others
In the case reported on by SensePost , this allowed for the fetching or downloading of remote payloads , using PowerShell for example .		others others others others others others security_team others reference_word others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others tool others others others
Once we extract the initial document , using 7-zip for example , we can observe the usual structure , and inside , a file called document.xml is of interest .		others others others others others others others others tool others others others others others others others others others others others others others others others others sample_name others others others others
In this XML , a remote payload , in this case a DLL , will be downloaded using PowerShell , moved to the user ’s temporary folder , and run using rundll32.exe , starting in the HOK function or export .		others reference_word reference_word others others sub_activity sub_activity others others others others others tool others others others sub_activity others tool others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others sub_activity others sample_name others others others others function others others others others
This debug.dll is a PE32 binary file with the following properties :  md5 hash : 64b2ac701a0d67da134e13b2efc46900 .		others sample_name others others others others others others others others others others encryption_algo others others md5 others
sha1 hash : 1bb516d70591a5a0eb55ee71f9f38597f3640b14 .		encryption_algo others others sha1 others
sha256 hash : f3f55c3df39b85d934121355bed439b53501f996e9b39d4abed14c7fe8081d92 .		encryption_algo others others sha2 others
size : 531,456 bytes .		others others others others others
internal DLL name : InstallClient.dll .		others others others others sample_name others
compiler : Microsoft .		others others company others
linker : Microsoft Linker (14.0 )[DLL32] .		others others company tool others others others others others others others
compilation time : 2017-07-06 08:50:10 .		others others others time time others
This DLL serves as a dropper for the actual payload , and as such the internal name of ‘ InstallClient ’ is an apt choice by the threat actor .		reference_word reference_word reference_word others others sample_function sample_function sample_function sample_function sample_function others others others others others others others others others sample_name others others others others others others others others person others
Developing a Yara rule for the simple dropper DLL , yielded several new binaries :  1dbbdd99cb8d7089ab31efb5dcf09706 5708e0320879de6f9ac928046b1e4f4e a6903d93f9d6f328bcfe3e196fd8c78b cf6f333f99ee6342d6735ac2f6a37c1e ac9b8c82651eafff9a3bbe7c69d69447 d6ddecdb823de235dd650c0f7a2f3d8f .		others others encryption_algo others others others others others others others others others others others others md5 md5 md5 md5 md5 md5 others
We have analysed d6ddecdb823de235dd650c0f7a2f3d8f , which also has InstallClient.dll as its internal name , as it seems to be the earliest dropper DLL used in this campaign , and does not appear to be very different from any of the other DLLs so far uncovered .		others others others md5 others others others others sample_name others others others others others others reference_word others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The DLL starts in the function named Insys , which performs some simple checks , for example , if the current user account is an administrator , and will subsequently call the function named SSSS , which is the main function .		reference_word reference_word others others others others others function others others others others sample_function sample_function others others others others others others others others others others others others others others others others others others others others function others others others others others others others
A substantial amount of actions will follow according to what ’s defined in the SSSS function , as follows :  Prepare target DLL , in this case rasauto.dll , for replacement in C:\Windows\System32 ;  Stop the service belonging to the target DLL , and use the takeown and icacls commands to gain full permissions for the system service DLL ;  Disable Windows File Protection , which normally prevents software or users from replacing critical Windows files ;  Suppress any error messages from Windows from popping up on boot ;  Copy the target DLL , rasauto.dll , to a new file named rasauto32.dll ;  Replace the target DLL with the malware ’s DLL , which is time-stomped in order to evade detection ;  Start the now malicious service using net.exe and net1.exe ; and , Create configuration and keylogs in C:\Windows\system32 , using an uncommon extension , in this case .tsp , and additionally create a folder in C:\Programdata for the purpose of screen captures .		others others others others others others others others others others others others others others others function others others others others others sub_activity sub_activity sub_activity others others others others sample_name others others others others others others others others sub_activity sub_activity sub_activity others others others others others others others others others function others function others others sub_activity sub_activity sub_activity others others others others others others sub_activity OS_name tool tool others others others sample_function sample_function sample_function sample_function others others others OS_name others others sub_activity sub_activity sub_activity sub_activity others OS_name others others others others others others sub_activity sub_activity sub_activity sub_activity others sample_name others others others others others others sample_name others sub_activity sub_activity sub_activity sub_activity others others sub_activity sub_activity sub_activity sub_activity others others others sub_activity others others others sub_activity sub_activity others sub_activity sub_activity sub_activity sub_activity sub_activity others sample_name others sample_name others others others sub_activity sub_activity sub_activity sub_activity others others others others others others others others others others others others others sample_name others others others sub_activity sub_activity sub_activity others others others others others others others others sub_activity sub_activity others
The malware will also , in some observed cases , output debug or error messages in a newly created file in the user ’s Application Data folder as DebugLog.TXT , for example:\AppData\Roaming\Microsoft\Windows\Cookies\DebugLog.TXT Then , the original dropper DLL will then be deleted , using a simple batch file that runs in a loop .		others sub_activity others others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity others others others others others others others others others others others others others others sample_name others others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others others sub_activity sub_activity sub_activity others others others others others others
While visually there is apparently no difference , due to the malware being time-stomped ( altering the created and modified dates of a file or folder ) , we can however observe a few subtle differences in the real and malicious binary .		others others others others others others others others others others reference_word reference_word others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The fake DLL has a different link date , some minor spelling mistakes , and does not include the build in the file version details .		others others tool others others others others others others others others others others others others others others others others others others others others others others others
As the malware also disables Windows File Protection and thus any pop-ups , it may not be immediately obvious to system administrators that a legitimate DLL was actually replaced .		others reference_word reference_word others sub_activity OS_name tool tool others others others others others others others others others others others others person person others others sub_activity tool sub_activity sub_activity sub_activity others
The following commands are issued in order to achieve persistence :  reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v SFCDisable /t REG_DWORD /d 4 /f .		others others others others others others others others others others others others others others others others others others others others others others others others others
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Windows" /v NoPopUpsOnBoot /t REG_DWORD /d 1 /f .		others others others others others others others others others others others others others
Taking a look at the Windows registry for our service , RasAuto , short for Remote Access Auto Connection Manager and historically used for connecting dial-up modems to the internet for example , reveals no specific additional modifications .		others others others others others OS_name tool others others others others tool others others others tool tool tool tool tool others others others others sample_function sample_function sample_function sample_function sample_function sample_function others others others others others others others others others
Dllhost.exe is additionally seen to call back or phone home to a hardcoded range of C2 servers , on ports 53 , 80 , and 443 .		sample_name others others others others sub_activity sub_activity others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity tool sub_activity others others others others others others others others others others
Dllhost usually has no need to connect to the internet or WAN , and as such it is a possible indicator of malicious activity .		tool others others others others others others others others tool others tool others others others others others others others others others others others others others
Attaching a debugger to dllhost.exe , reveals the keylogger files and configuration , replaced DLL file , as well as another folder , which is likely used to store screenshots and other data .		sub_activity sub_activity sub_activity sub_activity sample_name others sample_function sample_function sample_function sample_function sample_function sample_function others sample_function sample_function sample_function others others others others others others others others others others others others others others others others others others
Another ASCII string can be discovered in the DLL ’s config , MDDEFGEGETGIZ , which likely pertains to the specific KeyBoy campaign , or target .		others others others others others others others others tool others others others others others others others others others others others others threatActor_name others others others others others
The malware leveraged by KeyBoy has a plethora of functionality , including , but not limited to :  Screen grabbing/taking screenshots ;  Determine public or WAN IP address ( using a public IP service ) , likely for determining a suited target ;  Gather extended system information , such as information about the operating system , disks , memory and so on ;  A ‘ file browser ’ or explorer ;  Shutdown and reboot commands ( in addition to the point below ) ;  Launching interactive shells for communicating with the victim machine ;  Download and upload functionality ; and Usage of custom SSL libraries for masquerading C2 traffic .		others others others others threatActor_name others others others others others others others others others others others others others sample_function sample_function sample_function others sample_function sample_function sample_function sample_function sample_function sample_function others others others others protocol others others others others others others others others others others sample_function sample_function sample_function sample_function others others others others others others others others others others others others others others others others sample_function sample_function sample_function sample_function sample_function sample_function sample_function others sample_function sample_function sample_function sample_function others others others others others others others others others sample_function sample_function sample_function others others others others others others others sample_function sample_function sample_function sample_function others others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
Interestingly enough , the malware developers left several unique debug messages , for example :  GetScreenCmd from file : %s  Take Screen Error ,May no user login !		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Take Screen Error ,service dll not exists Earlier , we mentioned the threat actor uses custom SSL libraries to communicate to the C2 .		others others others others others others others others others others others others others person person others tool protocol tool others sub_activity sub_activity sub_activity tool others
While we have been unable to observe this behavior in any traffic logs , we were able to extract a certificate , which can be found in Appendix B .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Converting this certificate to the DER format , we find strings pointing to jessma.org , and an email address , ldcsaa@21cn.com .		others others others others others tool others others others others others others others domain_evil others others others others others others email_evil email_evil email_evil others
These belong to projects by a Chinese developer , where one of the tools or libraries is named HP-Socket , which is a ‘ High Performance TCP/UDP Socket Component ’ .		others others others others others others others others others others others others others others others others others others tool others others others others others tool tool tool tool tool others others
Additionally , said library sported an interesting debug path : D:\Work\VS\Horse\TSSL\TSSL_v0.3.1_20170722\TClient\Release\TClient.pdb In addition to writing a Yara rule for the dropper DLL and finding additional samples as mentioned above , we repeated the same process for the payload DLL .		others others others others others others others others others others others others others others others others others others encryption_algo others others others others tool others others others others others others others others others others others others others others others others tool others
a55b0c98ac3965067d0270a95e60e87e :  ikeext.dll IKE and AuthIP IPsec Keying Modules .		md5 others sample_name tool tool tool tool tool tool others
2e04cdf98aead9dd9a5210d7e601cca7 :  rasauto.dll Remote Access Auto Connection Manager .		md5 others sample_name tool tool tool tool tool others
d6ddecdb823de235dd650c0f7a2f3d8f :  rasauto.dll Remote Access Auto Connection Manager .		md5 others sample_name tool tool tool tool tool others
1dbbdd99cb8d7089ab31efb5dcf09706 :  sinet.dll Unknown .		md5 others sample_name others others
581ddf0208038a90f8bc2cdc75833425 :  sinet.dll Unknown .		md5 others sample_name others others
Sinet.dll may relate to SPlayer , a popular video player in China .		sample_name others others others tool others others others others others others location others
7d39cef34bdc751e9cf9d46d2f0bef95 :  D:\work\vs\UsbFerry_v2\bin\UsbFerry.pdb .		md5 others others others others others
29e44cfa7bcde079e9c7afb23ca8ef86 :  E:\Work\VS Project\cyassl-3.3.0\out\SSLClient_x64.pdb .		md5 others others others others others others
Both samples include references to a “ work ” folder , and a “ VS ” or “ VS Project ” .		others others others others others others others others others others others others others others others others others others others others others others
The latter likely points to a Visual Studio project short name , or VS .		reference_word reference_word others others others others tool tool others others others others others tool others
While the connection initially seems rather weak , it did hit the same Yara rule as mentioned before and the sample with hash 29e44cfa7bcde079e9c7afb23ca8ef86 additionally includes an SSL certificate , which , when converted , points to another custom SSL library , called WolfSSL , which is a “ a small , fast , portable implementation of TLS/SSL for embedded devices to the cloud ” .		others others others others others others others others reference_word others sub_activity sub_activity sub_activity encryption_algo sub_activity others others others others others others others others md5 others others others protocol tool others others others others others others others others others tool tool tool others others tool others others others others others others others others others others others others others protocol others sample_function sample_function sample_function sample_function sample_function others others
The same hash or binary also includes what we assess to be a campaign name or KeyBoy version identifier , which is weblogic20170727 .		others others others others others others others others others others others others others others others others threatActor_name others others others others others others others
Another sample which hit our Yara rule is 7aea7486e3a7a839f49ebc61f1680ba3 , which was first uploaded to VirusTotal on 2017-08-25 .		others others others others others encryption_algo others others md5 others others others others others others tool others time others
This sample appears to be an older variant of KeyBoy , as there are several plain-text strings present , which are consistent with CitizenLab ’s report referenced in the introduction .		reference_word reference_word others others others others others others others threatActor_name others others others others others others others others others others others others others security_team others others others others others others others others
We have mapped out the complete infrastructure that we have discovered , using Maltego .		person others sub_activity sub_activity sub_activity sub_activity sub_activity others others others others others others tool others
There was some overlap with the samples and infrastructure , and one email address appears to jump out , which is linked to several domains : 657603405@qq.com .		others others others others others others others others others others others others others others others others others others others others others others others others others others email_evil email_evil email_evil others
This email address does not appear to have been observed before .		others others others others others others others others others others others others
One other relevant point to note in regards to the infrastructure , is the use of dates , likely relating to campaign names , as part of the C2 servers .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others tool others others
Examples include :  Weblogic727.xxuz.com ( 2017-07-27 campaign ) ; and , Weblogic1709.zzux.com ( 2017-09-17 campaign ) .		others others others domain_evil others time others others others others others domain_evil others time others others others
In this report , we have analysed what we assess with high confidence , to be ( part of ) the latest KeyBoy campaign , a threat actor that has been active for several years , and displays at least a medium level of technical and operational know-how .		others others others others others others others others others others others others others others others others others others others others others others threatActor_name others others others others others others others others others others others others others others others others others others others others others others others others others others
Several connections can be made to CitizenLab ’s report from 2016 , such as the continued usage of fake services and related DLLs , powerful capabilities , several exports and strings present in the ( sometimes decrypted ) DLLs , as well as campaign or version identifiers which are reminiscent and consistent with earlier reported identifiers .		others others others others others others security_team tool tool tool others time others others others others others others others others others others others tool others others others others others others others others others others others others others others others tool others others others others others others others others others others others others others others others others others others
While we do not have a clear visibility of targeting , it does appear that this latest campaign targets at least some Western organisations , likely for corporate espionage purposes .		others others others others others others others others others others others others others others others others others others others others others others industry industry others others others attack_goal attack_goal attack_goal others
Organisations can refer to Appendix A , in order to search of any possible indicators of compromise .		others others others others others others others others others others others others others others others others others others
Additionally , organisations may wish to disable default administrator credentials , which will prevent unauthorised services to be installed .		others others others others others others others others others others others others others others others others others others others others
Clients who are part of our threat intelligence subscription services , can refer to our latest report CTO-TIB-20171019-01A - KeyBoy's new toys , which includes more information as well as ruling in order to detect KeyBoy ’s latest campaign .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others threatActor_name others others others others others
If you would like more information on any of the threats discussed in this alert , or you suspect you may be compromised , please feel free to get in touch , by emailing threatintelligence@uk.pwc.com .		others others others others others others others others others reference_word reference_word others others others others others others others others others others others others others others others others others others others others others others others others others others others
KeyBoy :  101.200.135.85 .		threatActor_name others IP_evil others
KeyBoy :  103.215.81.196 .		threatActor_name others IP_evil others
KeyBoy :  103.215.83.193 .		threatActor_name others IP_evil others
KeyBoy :  103.86.86.177 .		threatActor_name others IP_evil others
KeyBoy :  118.163.165.20 .		threatActor_name others IP_evil others
KeyBoy :  142.4.34.92 .		threatActor_name others IP_evil others
KeyBoy :  http://213.183.51.187/debug.dll .		threatActor_name others url_evil url_evil url_evil others
KeyBoy :  dumblamb.zzux.com .		threatActor_name others domain_evil others
KeyBoy :  foxsay.mefound.com .		threatActor_name others domain_evil others
KeyBoy :  greentree.yourtrap.com .		threatActor_name others domain_evil others
KeyBoy :  kawayi.zzux.com .		threatActor_name others domain_evil others
KeyBoy :  mianliu.party .		threatActor_name others domain_evil others
KeyBoy :  mianliu.video .		threatActor_name others domain_evil others
KeyBoy :  657603405@qq.com .		threatActor_name others email_evil email_evil email_evil others
KeyBoy :  sensr9.dat .		threatActor_name others sample_name others
KeyBoy :  sensr3.dat .		threatActor_name others sample_name others
KeyBoy :  netis9.tsp .		threatActor_name others sample_name others
KeyBoy :  netis3.tsp .		threatActor_name others sample_name others
KeyBoy :  52d11a0a5142f0b37aa2d288321ba099 .		threatActor_name others md5 others
KeyBoy :  581ddf0208038a90f8bc2cdc75833425 .		threatActor_name others md5 others
KeyBoy :  64b2ac701a0d67da134e13b2efc46900 .		threatActor_name others md5 others
KeyBoy :  1dbbdd99cb8d7089ab31efb5dcf09706 .		threatActor_name others md5 others
KeyBoy :  7aea7486e3a7a839f49ebc61f1680ba3 .		threatActor_name others md5 others
KeyBoy :  a55b0c98ac3965067d0270a95e60e87e .		threatActor_name others md5 others
KeyBoy :  f21e3b927d269b0622d94c55db9d2808758379aa413c10971fa745cd6e0503c0 .		threatActor_name others sha2 others
KeyBoy :  f15d2e9deaeb495fe8a62c05993b9f69bf07331910ed2483e1bab7d31d30231b .		threatActor_name others sha2 others
KeyBoy :  f3f55c3df39b85d934121355bed439b53501f996e9b39d4abed14c7fe8081d92 .		threatActor_name others sha2 others
KeyBoy :  750f4a9ae44438bf053ffb344b959000ea624d1964306e4b3806250f4de94bc8 .		threatActor_name others sha2 others
KeyBoy :  12dfb83a3866c93cd1c08652ed0a16a492777355985a973ef50973896795eb34 .		threatActor_name others sha2 others
KeyBoy :  5d0aef905c9f8f74bb82eba89c11ec5b27d35e560b5cacf81087fca0775a8bfa .		threatActor_name others sha2 others