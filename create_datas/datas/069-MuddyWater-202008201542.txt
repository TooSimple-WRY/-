I know what you did last summer , MuddyWater blending in the crowd .		others others others others others others others others threatActor_name others others others others others
Release_Time :  2019-04-29 Report_URL :  https://securelist.com/muddywaters-arsenal/90659/ MuddyWater is an APT with a focus on governmental and telco targets in the Middle East ( Iraq , Saudi Arabia , Bahrain , Jordan , Turkey and Lebanon ) and also a few other countries in nearby regions ( Azerbaijan , Pakistan and Afghanistan ) .		others others others others others others others others threatActor_name others others others others others others others government others industry others others others others others others location others location location others location others location others location others location others others others others others others others others others others others location others location others location others others
MuddyWater first surfaced in 2017 and has been active continuously , targeting a large number of organizations .		threatActor_name others others others time others others others others others others others others others others others others others
First stage infections and graphical decoys have been described by multiple sources , including in our previous research :  “ MuddyWater expands operations “ .		others others others others others others others others others others others others others others others others others others others others others others others others others
Nevertheless , comprehensive details of what happens after the initial infection by MuddyWater have not previously been made publicly available .		others others others others others others others others others others others others threatActor_name others others others others others others others others
MuddyWater attackers deploy a variety of tools and techniques , mostly developed by the group itself in Python , C# and PowerShell , to implement their attacks and complete their victim infiltration and data exfiltration .		person person others others others others others others others others others others others others others others others program_language others program_language program_language others tool others others others others others others others others others others others others others others
Examples of such tools include multiple download/execute tools and RATs in C# and Python , SSH Python script , multiple Python tools for extraction of credentials , history and more .		others others others others others others tool tool others others others program_language program_language others program_language others tool tool tool others others program_language others others others others others others others others others others
This report details a collection of tools used by this threat actor on its targets after initial infection .		others others others others others others others others others others reference_word reference_word others others others others others others others
It also details deceptive techniques used to divert investigations once attack tools have been deployed inside victim systems ( such as Chinese strings , Russian strings and impersonation of the “ RXR Saudi Arabia ”  hacking group ) .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others threatActor_name threatActor_name threatActor_name others others others others others
The investigation revealed additional OPSEC mistakes by the attackers , but we are not detailing those here due to ongoing law enforcement investigations .		others others others others tool others others others person others others others others others others others others others others others others others others others
During our research on MuddyWater campaigns , we were able to identify a number of tools and scripts used by this actor , providing a good understanding of this actor ’s abilities .		others others others others threatActor_name others others others others others others others others others others others others others others others reference_word reference_word others others others others others others others reference_word others others others others
Most of the tools used are custom developed , while others are based on more generic and publicly available ones .		others others others others others others others others others others others others others others others others others others others others others
The list includes :  Nihay – C# Download-and-Execute tool .		others others others others tool others program_language program_language others others others
LisfonService – C# RAT .		malware others program_language program_language malware others
Client.py – Python RAT .		malware others program_language malware others
Client-win.py – SSH Python script .		sample_name others protocol program_language others others
Rc.py/Rc.exe – Basic Python RAT .		malware others others program_language malware others
VBScript and VBA files .		program_language tool program_language tool others
Third-party scripts ( Muddy , Losi Boomber , Slaver reverse tunnel … ) .		tool tool others tool others tool tool others tool tool tool others others others
Second stage PowerShell scripts .		tool tool tool tool others
Most of these tools are scripts written in Python or PowerShell .		others others others others others others others others tool others tool others
We noticed that MuddyWater compiles various offensive Python scripts into executables for portability , using Py2Exe and PyInstaller for this task .		others others others threatActor_name others others others tool tool others others others sample_function others others tool others tool others others others others
This includes Python scripts such as “ CrackMapExec ”  , “ shootback ”  and “ Lazagne ”  .		others others others others others others others tool others others others tool others others others tool others others
We have also noticed the use of “ PS2EXE ”  to convert PowerShell scripts into executables , with the original PowerShell code embedded as a Base64-encoded string .		others others others others others others others others tool others others sample_function tool sample_function sample_function sample_function others others others others tool others others others others others others others
In other cases , we have noticed a preference for using PowerShell Reflective DLL injection to deploy Metasploit Stageless Meterpreters .		others others others others others others others others others others others tool tool tool others others sample_function sample_function sample_function sample_function others
They use both 32-Bit and 64-Bit versions .		others others others others others others others others
Usually , the Stageless Meterpreter has the “ Ext_server_stdapi.x64.dll ”  , “ Ext_server_extapi.x64.dll ”  , and “ Ext_server_espia.x64.dll ”  extensions .		others others others tool tool others others others sample_name others others others sample_name others others others others sample_name others others others
LisfonService is a RAT very similar to the PowerShell RAT that we have analyzed in our previous publication .		malware others others malware others others others others malware malware others others others others others others others others others
LisfonService randomly chooses a URL from a huge array of hardcoded Proxy URLs hiding the real C2 server .		malware others others others others others others others others others others others others others others others tool others others
It collects some basic information about its victim : user name , domain or workgroup name , machine name , machine internal IP address , OS version , OS build and public IP address .		reference_word attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others others others others others others others others others others others others others others others others others others others others others others others others others others others
Once the victim is successfully registered , a victim id is assigned to the victim and is used later to request commands from the C2 , such as executing PowerShell code or causing a Blue Screen .		others others others others others others others others tool tool others others others others others others others others others others sample_function sample_function sample_function sample_function sample_function others others others others tool others others others others others others others
Inside the decompiled C# code , there is a referenced variable named “ str1 ”  that is not actually used .		others others others program_language program_language others others others others others others others others others others others others others others others others others
We believe that it is a remnant from an earlier testing phase and it might be the IP address of the C2 behind the Proxy URLs .		others others others others others others others others others others others others others others others others others protocol others others others tool others others tool tool others
str1 = " http://78.129.222.56:8090/244271232658346635408608084822345041494 " ;  Client.Py is a Python 3.6 RAT that we believe was developed by MuddyWater .		others others others IP_evil IP_evil IP_evil others others malware others others program_language others others others others others others others others threatActor_name others
It is deployed on victim computers as a compiled Python executable using PyInstaller .		reference_word others others others others others others others others program_language others others tool others
The execution flow is as follows :  Collects basic information about the victim machine :  machine name , OS name , OS version , and user name .		others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others others others others others others others others others others others others others
It then sends the information to the C2 server at 192.64.86.174:8980 .		reference_word others sub_activity sub_activity sub_activity sub_activity sub_activity tool sub_activity sub_activity IP_evil others
It supports multiple commands , some of them executed by creating a temporary .VBS file and running it by calling cscript.exe .		others others others others others others others others others others others others others others others others others others others others others others
The supported commands allow the RAT to implements basic keylogger functionality , stealing passwords saved in Chrome , killing task manager , remote command execution and displaying an alert message for the victim in a message box .		others others others others reference_word reference_word others sample_function sample_function sample_function sample_function others sample_function sample_function sample_function sample_function sample_function others sample_function sample_function sample_function others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
Client-win.py – SSH Python script .		sample_name others protocol program_language others others
This PyInstaller-compiled Python script makes use of the Python paramiko plugin to create a SSH connection to its C2 .		reference_word reference_word program_language reference_word others others others others tool tool tool others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
Connects to a hard-coded IP address for the C2 ( for instance 104.237.233.38 ) on port 8085 , sending the string “ ip ”  .		others others others others others others others others tool others others others others others others others others others others others others others others others others
It should then receive a list of IPs in the form of “ ip1::ip2::ip3 ”  .		others others others others others others others others others others others others others others others others others others others others
The script then connects to the same hard-coded IP address , sending the string “ pw ”  so that it gets a list of passwords from the C2 in the form of “ pw1\npw2\npw3 ”  .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Finally , it tries a list of hard-coded user names ( such as ‘ cisco ’  , ‘ root ’  , ‘ admin ’  ) with each of the passwords received on each of the IPs obtained in step 1 to authenticate SSH sessions .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others protocol others others
Rc.py/Rc.exe – Basic Python RAT .		malware others others others others others
This UPX-packed executable is a PyInstaller-compiled Python script ( rc.py ) .		others others others others others others tool tool others tool others others
The script receives the IP address of its C2 as parameters , connecting to it on the hard-coded port 9095 .		reference_word reference_word others others others others others others tool others others others others others others others others others others others others
This basic RAT supports a few commands on victims ’  systems to collect passwords and remote command execution .		others others others others others others others others others others others others others others others others others others others
“ kill ”  to self-terminate .		others others others others others others
“ cd ”  for changing current directory .		others others others others others others others others
“ dopass ”  for grabbing credentials from Chrome , IE ,  Mozilla , Opera and Outlook .		others others others others others others others tool others tool others tool others tool others tool others
“ info ”  extracts basic info about victim machine :  OS name/version , 32-bit/64-bit , processor name , user name , machine name , machine FQDN , internal IP address , MAC address , and public IP address .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
“ shell ”  receives files from C2 and saves them in “ C:\ProgramData ”  .		others others others others others others tool others others others others others string string string others others
“ exec ”  spawns a new process as determined by C2 .		others others others others others others others others others others tool others
Otherwise , cmd.exe /c is called to spawn a new process as determined by C2 .		others others tool tool others others others sample_function sample_function sample_function sample_function sample_function sample_function sample_function tool others
Output is always sent to C2 .		others others others others others tool others
One of MuddyWater ’s preferred infection vectors is the use of weaponized macro-enabled Office 97-2003 Word documents .		others others threatActor_name others others others others others others others others others others tool tool tool tool tool others
Its malicious VBA code includes a Base64-encoded payload .		others others program_language others others others others others others
The first file is a malicious VBScript and the second file is the Base64-encoded payload .		others others others others others others others others others others others others others others others others
The VBS calls powershell.exe to Base64-decode the second file and invoke it , as follows :  We detected MuddyWater including several “ Lazagne “ -based scripts in its arsenal .		others program_language others sample_name others others others others others others others others others others others others others others threatActor_name others others others tool others others others others others others others
The first one , called Losi Boomber , is used to extract credentials and history from browsers and Outlook .		others others others others others tool tool others others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
Muddy is another Lazagne-based script extracting credentials from mail clients and browsers .		tool others others others others sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
In this case , it supports the following browsers :  Chrome , IE , Mozilla , Opera and Coccoc .		others others others others others others others others others others tool others tool others tool others tool others tool others
In terms of mail clients , it only supports Outlook .		others others others others others others others others others tool others
Slaver.py is a compiled Python script taken from “ ShootBack ”  , used for establishing a reverse tcp tunnel .		sample_name others others others program_language others others others others tool others others others others sample_function sample_function sample_function sample_function sample_function others
Cr.exe is a compiled Python script based on CrackMapExec , used for credential gathering and lateral code execution .		sample_name others others others program_language others others others tool others others others sample_function sample_function sample_function sample_function sample_function sample_function others
Mmap.py ( called “ MapTools ”  by MuddyWaters ) is also based on CrackMapExec and used for the same purpose .		sample_name others others others sample_name others others threatActor_name others others others others others tool others others others others others others others
We detected MuddyWater making extensive use of PowerShell scripts for different purposes :  Besides disabling PowerShell Script Block Logging and bypassing AMSI ( Anti-Malware Scan Interface ) , it fetches its next stage using the “ InternetExplorer.Application ”  COM object to retrieve HTML content from http://104.237.233.40:7070/admin/get.php .		others others threatActor_name others others others others tool tool others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity others sub_activity sub_activity others tool tool tool others others others sample_function sample_function sample_function sample_function others others others tool others others others others sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
Interestingly it uses a hard-coded CloudFlare HTTP header value :  “ CF-RAY :  oBLKRK3GNKZcBGZeWl+s4ExIaQ0= ”  Case 2 :  We also identified MuddyWater ’s PowerShell prototype RAT implementing functions to collect user info ( internal IP address , user name , domain name , 32bit/64bit ) , RC4 encryption/decryption , Base64 encoding and decoding , changing cached group policy settings ( cachedGroupPolicySettings ) for PowerShell security settings , EnableScriptBlockLogging , EnableScriptBlockInvocationLogging .		others others others others others others others others others others others string string string others others others others others others others threatActor_name others others tool malware malware others others others sample_function sample_function sample_function others others others others others others others others others others others others others others sample_function sample_function others sample_function sample_function sample_function sample_function others sample_function sample_function sample_function sample_function sample_function others others others others others others others others others others others others
It also disables all HTTPS SSL certificate checks .		reference_word others sample_function sample_function sample_function sample_function sample_function sample_function others
We have seen cases where the above was renamed to “ km ”  and directly invoked with its C2 IP set to “ 78.129.139.134 “ port “ 8080 ”  and RC4 key set to “ KharashoNIKharasho !		others others others others others others others others others others others others others others others others others others tool others others others others IP_evil others others others others others others encryption_algo others others others others others others
@#123456_6 ”  :  We found an interesting case ( apparently exclusive to this actor ) of a WinRAR SFX ( self-extracting archive ) named “ Iranicard.exe ”  .		others others others others others others others others others others others others others others others others others others others tool tool others others others others others others sample_name others others
The embedded SFX pre-setup script is an MSHTA one-liner , which invokes a PowerShell one-liner that downloads and executes PowerShell code from ‘ https://dzoz.us/js/js.js ’  .		others others tool tool tool others others tool others others others others others tool others others others others others tool others others others domain_evil domain_evil domain_evil others others
In our analysis of this actor ’s activities we have detected multiple OPSEC mistakes and analyzed some of the distraction techniques it has used .		others others others others person person others others others others others others others tool others others others others others others others others others others others others
Among the OPSEC mistakes , there were multiple PDB file paths left in some samples or in artifacts collected from the C2 server .		others others tool others others others others others tool others others others others others others others others others others others others tool others others
The .Net RAT called “ LisfonService ”  has PDB file paths referring to “ dragon ”  and “ Panda ”  as user names .		others others others others others tool others others tool others others others others others others others others others others others others others others others
Panda and dragon could have been deliberately used to point researchers to a possible Chinese actor , or it may just be the way attackers like to refer to themselves .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
It is worth mentioning that in some of the PowerShell RATs , attackers also used the “ $dragon_middle ”  variable name for an array of C2 proxy URLs .		others others others others others others others others others tool others others others others others others others others others others others others others others others others tool others others others
Multiple weaponized Office Word documents also contain embedded paths from their authors ’  machines .		others others others others others others others others others others others others others others others
These paths are embedded by Office under various circumstances :  for instance , when somebody adds a binary object ( like an OLE control such as a text box or a command button ) into a Word document .		others others others others others tool others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
These PDBs provide the following usernames :  poopak , leo , Turk and Vendetta :  Multiple Chinese strings can be found in some PowerShell RAT payloads ( such as Ffb8ea0347a3af3dd2ab1b4e5a1be18a ) that seem to have been left in on purpose , probably to make attribution harder .		others tool others others others others others others others others others others others others others others others others others others others others others tool others others others others others string others others others others others others others others others others others others others others others others others
In another PowerShell sample ( md5 :  e684aa1c6e51f4696a836ecb6ff1e143 , filename : km.ps1 ) , attackers used Russian words as the RC4 key when establishing a connection to the C2 server ( 78.129.139.134 ) .		others others others others others encryption_algo others md5 others others others string others others person others others others others others encryption_algo others others others others others others others tool others others IP_evil others others
Moreover , IP 78.129.139.134 is used as a C2 for other samples as well .		others others others IP_evil others others others others tool others others others others others others
Interestingly , when visiting the C2 , it displays a blank webpage whose HTML source code shows a strange HTML tag value that suggests attackers have tried to impersonate a Saudi Hacking group called RXR Saudi Arabia .		others others others others others tool others others others others others others others program_language others others others others others program_language others others others others person others others others others others others others others others threatActor_name threatActor_name threatActor_name others
MuddyWater attacks have been expanding in recent years in terms of targets and malware functionality .		threatActor_name others others others others others others others others others others others others others others others
The attackers seem to be reasonably well-equipped for their goals , with relatively simple and expendable tools to infiltrate victims and exfiltrate data , mostly using Python and PowerShell-based tools .		person person others others others others others others others others others others others others others others others others others others others others others others others others program_language others others others others
These tools also seem to allow them flexibility to adapt and customize the toolset for victims .		others others others others others others others others others others others others others others others others others
This continuous capability to steadily adjust and enhance attacks , adapting well to the changing Middle Eastern geopolitical scene , seems to make this actor a solid adversary that keeps growing .		others others others others others others others others others others others others others others others location location others others others others others others others others others others others others others others others
We expect it to keep developing or acquiring additional tools and abilities , possibly including zero-days .		others others others others others others others others others others others others others others others others others
Nevertheless , its current OPSEC should be considered poor – for example , leaving details which could reveal different types of information about them .		others others others others tool others others others others others others others others others others others others others others others others others others others others