Chafer used Remexi malware to spy on Iran-based foreign diplomatic entities .		threatActor_name others malware others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
Release_Time :  2019-01-30 .		others others others others
Report_URL :  https://securelist.com/chafer-used-remexi-malware/89538/ .		others others others others others others
Throughout the autumn of 2018 we analyzed a long-standing ( and still active at that time ) cyber-espionage campaign that was primarily targeting foreign diplomatic entities based in Iran .		others others time time time others others others others others others others others others others others others attack_activity attack_activity others others others others target_crowd target_crowd target_crowd others others location others
The attackers were using an improved version of Remexi in what the victimology suggests might be a domestic cyber-espionage operation .		others person others others others others others others malware others others others others others others others others others attack_activity attack_activity others
This malware has previously been associated with an APT actor that Symantec calls Chafer .		reference_word reference_word others others others others others others others others others security_team others threatActor_name others
The malware can exfiltrate keystrokes , screenshots , browser-related data like cookies and history , decrypted when possible .		reference_word reference_word others sub_activity sub_activity others sub_activity others sub_activity sub_activity others tool others others others sub_activity others others others
The attackers rely heavily on Microsoft technologies on both the client and server sides : the Trojan uses standard Windows utilities like Microsoft Background Intelligent Transfer Service ( BITS ) bitsadmin.exe to receive commands and exfiltrate data .		others person others others others tool tool others others others others others others others others others malware others others tool tool others tool tool tool tool tool others tool others others others others others others others others others
Its C2 is based on IIS using .asp technology to handle the victims ’ HTTP requests .		others tool others others others tool others others others others others others others others protocol others others
Remexi developers use the C programming language and GCC compiler on Windows in the MinGW environment .		malware others others others program_language program_language program_language others tool tool others OS_name others others tool others others
They most likely used the Qt Creator IDE in a Windows environment .		others others others others others tool tool tool others others OS_name others others
The malware utilizes several persistence mechanisms including scheduled tasks , Userinit and Run registry keys in the HKLM hive .		reference_word reference_word others others others others others others others others others others others others others others others others others others
XOR and RC4 encryption is used with quite long unique keys for different samples .		encryption_algo others encryption_algo others others others others others others others others others others others others
Among all these random keys once the word “ salamati ” was also used , which means “ health ” in Farsi .		others others others others others others others others others string others others others others others others others others others others others others others
Kaspersky Lab products detect the malware described in this report as Trojan.Win32.Remexi and Trojan.Win32.Agent .		security_team security_team others others reference_word reference_word others others others others others malware others malware others
This blogpost is based in our original report shared with our APT Intelligence Reporting customers last November 2018 .		others others others others others others others others others others others others others others others others time time others
The main tool used in this campaign is an updated version of the Remexi malware , publicly reported by Symantec back in 2015 .		others others others others others reference_word reference_word others others others others others others malware others others others others others security_team others others time others
The newest module ’s compilation timestamp is March 2018 .		others others others others others others others others time time others
The developers used GCC compiler on Windows in the MinGW environment .		others person others tool tool others OS_name others others tool others others
Inside the binaries the compiler left references to the names of the C source file modules used : “ operation_reg.c ” , “ thread_command.c ” and “ thread_upload.c ” .		others others others others others others others others others others others others others others others others others others others sample_name others others others sample_name others others others sample_name others others
Like mentioned in modules file names the malware consists of several working threads dedicated to different tasks , including C2 command parsing and data exfiltration .		others others others others others others reference_word reference_word others others others others others others others others others others others tool others others others others others others
For both the receiving of C2 commands and exfiltration , Remexi uses the Microsoft Background Intelligent Transfer Service ( BITS ) mechanism to communicate with the C2 over HTTP .		others others others others others tool others others others others malware others others tool tool tool tool tool others tool others others others others others others tool others protocol others
So far , our telemetry hasn’t provided any concrete evidence that shows us how the Remexi malware spread .		others others others others others others others others others others others others others others others others others malware others others others
However , we think it ’s worth mentioning that for one victim we found a correlation between the execution of Remexi´s main module and the execution of an AutoIt script compiled as PE , which we believe may have dropped the malware .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others tool tool others others others others others others others others others others reference_word reference_word others
This dropper used an FTP with hardcoded credentials to receive its payload .		malware malware others others protocol others others others others others others others others
FTP server was not accessible any more at the time of our analysis .		protocol others others others others others others others others others others others others others
Remexi boasts features that allow it to gather keystrokes , take screenshots of windows of interest ( as defined in its configuration ) , steal credentials , logons and the browser history , and execute remote commands .		malware others others others others others others attack_goal attack_goal others attack_goal attack_goal others others others others others others others others others others others others attack_goal attack_goal others attack_goal attack_goal attack_goal attack_goal attack_goal others others attack_goal attack_goal attack_goal others
Encryption consists of XOR with a hardcoded key for its configuration and RC4 with a predefined password for encrypting the victim ’s data .		others others others encryption_algo others others others others others others others others encryption_algo others others others others others others others others others others others others
Remexi includes different modules that it deploys in its working directory , including configuration decryption and parsing , launching victim activity logging in a separate module , and seven threads for various espionage and auxiliary functions .		malware others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The Remexi developers seem to rely on legitimate Microsoft utilities , which we enumerate in the table below .		others malware others others others others others others tool tool others others others others others others others others others
Persistence modules are based on scheduled tasks and system registry .		others others others others others others others others others others others
Mechanisms vary for different OS versions .		others others others others others others others
In the case of old Windows versions like XP , main module events.exe runs an edited XPTask.vbs Microsoft sample script to create a weekly scheduled task for itself .		others others others others others OS_name others others OS_name others others others sample_name others others others sample_name others others others others others others others others others others others others
At the system registry level , modules achieve persistence by adding themselves into the key :  HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit when it finds possible add values to the Winlogon subkey , and in HKLM\Software\Microsoft\Windows\CurrentVersion\Run\Microsoft Activity Manager .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
All such indicators of comprometation are mentioned in correspondent appendix below .		others others others others others others others others others others others others
All the commands received from the C2 are first saved to an auxiliary file and then stored encrypted in the system registry .		others others others others others others tool others others others others others others others others others others others others others others others others
The standalone thread will decrypt and execute them .		others others others others others others others others others
To decrypt the configuration data , the malware uses XOR with 25-character keys such as “ waEHleblxiQjoxFJQaIMLdHKz ” that are different for every sample .		others others others others others others reference_word reference_word others encryption_algo others others others others others others others others others others others others others others others
RC4 file encryption relies on the Windows 32 CryptoAPI , using the provided value ’s MD5 hash as an initial vector .		encryption_algo others others others others others tool tool tool others others others others others others others encryption_algo encryption_algo others others others others others
Among all these random keys once the word “ salamati ” was also used , which means “ health ” in Farsi .		others others others others others others others others others string others others others others others others others others others others others others others
Most of the parameters are self-explanatory .		others others others others others others others
However , captureScreenTimeOut and captureActiveWindowTimeOut are worth describing in more detail as their programming logic is not so intuitive .		others others others others others others others others others others others others others others others others others others others others
One of the malware threads checks in an infinite loop if the mouse button was pressed and then also increments the integer iterator infinitely .		others others reference_word reference_word others others others others others others others others others others others others others others others others others others others others others
If the mouse hooking function registers a button hit , it lets the screenshotting thread know about it through a global variable .		others others others others others others others others others others others others others others others others others others others others others others others
After that , it checks if the iterator divided by ( captureScreenTimeOut/captureActiveWindowTimeOut ) has a remainder of 0 .		others others others others others others others others others others others others others others others others others others others
In that case , it takes a screenshot .		others others others others others others others others others
events.exe : b1fa803c19aa9f193b67232c9893ea57574a2055791b3de9f836411ce000ce31 c981273c32b581de824e1fd66a19a281 GCC compiler in MinGW environment version 2.24 , timestamp set to 1970 by compiler I386 Windows GUI EXE 68 608 .		sample_name others sha2 md5 tool tool others tool others others others others others others others time others others others others others others others others others
After checking that the malware is not already installed , it unpacks HCK.cab using the Microsoft standard utility expand.exe with the following arguments .		others others others reference_word reference_word others others others others others others others sample_name others others tool tool tool others others others others others others
Then it decrypts config.ini file with a hardcoded 25-byte XOR key that differs for every sample .		others others others sample_name others others others others others encryption_algo others others others others others others others
It sets keyboard and mouse hooks to its handlekeys() and MouseHookProc() functions respectively and starts several working threads .		others others others others others others others others sample_function others others others sample_function others others others others others others others others others others
This module is called from the main thread to obtain screenshots of windows whose titles are specified in the configuration CaptureSites field , bitmaps and text from clipboard , etc .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Splitter.exe : a77f9e441415dbc8a20ad66d4d00ae606faab370ffaee5604e93ed484983d3ff 1ff40e79d673461cd33bd8b68f8bb5b8 2017.08.06 11:32:36 ( GMT ) , 2.22 I386 Windows Console EXE 101 888 .		sample_name others sha2 md5 time time time time time others others others others others others others others others
Instead of implementing this auxiliary module in the form of a dynamic linked library with its corresponding exported functions , the developers decided to use a standalone executable started by events.exe with the following parameters .		others others others others others others others others others others others tool tool tool others others others others others others others person others others others others others others others others sample_name others others others others others
Exfiltration is done through the bitsadmin.exe utility .		others others others others others sample_name others others
The BITS mechanism has existed since Windows XP up to the current Windows 10 versions and was developed to create download/upload jobs , mostly to update the OS itself .		others tool others others others others OS_name OS_name others others others others OS_name OS_name others others others others others others others others others others others others others others others others
The following is the command used to exfiltrate data from the victim to the C2 .		others others others others others others others others others others others others others others tool others
The vast majority of the users targeted by this new variant of Remexi appear to have Iranian IP addresses .		others others others others others target_crowd target_crowd others others others others others malware others others others location others others others
Some of these appear to be foreign diplomatic entities based in the country .		others others others others others others others others others others others others others others
The Remexi malware has been associated with an APT actor called Chafer by Symantec .		others malware others others others others others others others others others threatActor_name others security_team others
One of the human-readable encryption keys used is “ salamati ” .		others others others others others others others others others string others others
This is probably the Latin spelling for the word “ health ” in Farsi .		others others others others others others others others others others others others others others others
Among the artifacts related to malware authors , we found in the binaries a .pdb path containing the Windows user name “ Mohamadreza New ” .		others others others others others others others others others others others others others others others others others others others others others others string string others others
Interestingly , the FBI website for wanted cybercriminals includes two Iranians called Mohammad Reza , although this could be a common name or even a false flag .		others others others government others others others others others others others others others others others others others others others others others others others others others others others others
Activity of the Chafer APT group has been observed since at least 2015 , but based on things like compilation timestamps and C&C registration , it ’s possible they have been active for even longer .		others others others threatActor_name threatActor_name threatActor_name others others others others others others time others others others others others others others others others tool tool tool others others others others others others others others others others others others others others
Traditionally , Chafer has been focusing on targets inside Iran , although their interests clearly include other countries in the Middle East .		others others threatActor_name others others others others others others location others others others others others others others others others others location location others
We will continue to monitor how this set of activity develops in the future .		others others others others others others others others others others others others others others others
Chafer : 028515d12e9d59d272a2538045d1f636 .		threatActor_name others md5 others
Chafer : 03055149340b7a1fd218006c98b30482 .		threatActor_name others md5 others
Chafer : 25469ddaeff0dd3edb0f39bbe1dcdc46 .		threatActor_name others md5 others
Chafer : 41b2339950d50cf678c0e5b34e68f537 .		threatActor_name others md5 others
Chafer : c6721344af76403e9a7d816502dca1c8 .		threatActor_name others md5 others
Chafer : d3a2b41b1cd953d254c0fc88071e5027 .		threatActor_name others md5 others
Chafer : 1FF40E79D673461CD33BD8B68F8BB5B8 .		threatActor_name others md5 others
Chafer : 108.61.189.174 .		threatActor_name others IP_evil others