APT28 Release_Time :  2016-10 .		threatActor_aliases others others others others
Report_URL :  https://www.welivesecurity.com/wp-content/uploads/2016/10/eset-sednit-part-2.pdf Sedreco serves as a spying backdoor , whose functionalities can be extended with dynamically loaded plugins .		others others others others others malware others others others others others others others others others others others others others others others others
It is made up of two distinct components : a dropper and the persistent payload installed by this dropper .		others others others others others others others others others others malware others others others others others others others malware others
Alternative Names : AZZY .		others others others malware others
Usage Sedreco is deployed on targets deemed interesting after  a reconnaissance phase .		others malware others others others others others others others others others others others
It serves for long-term espionage ,  thanks to the numerous commands provided by its payload .		others others others others others others others others others others others others others others others others
Known period of activity : May 2012 to July 2016 .		others others others others others time time others time time others
Probably still in use at the time of writing ( August 2016 ) .		others others others others others others others others others others time time others others
Known deployment methods :  Downloaded by Seduploader  Downloaded by Downdelph .		others others others others others others malware others others others others
Distinguishing characteristics ：  The Sedreco payload relies on a configuration usually stored  in a registry key named Path , or in a file named msd , and initially  embedded in the Sedreco dropper The Sedreco payload creates a mutex named MutYzAz  or AZZYMTX The inbound and outbound communications of Sedreco ’s  payload with its C&C server are buffered into two files ,  respectively named __2315tmp.dat and __4964tmp.dat .		others others others others malware others others others others others others others others others others others others tool others others others others others others tool others others others others others others malware malware others malware others others others others others others others others others others others others others others malware others others others others others others others others others others others others others others others others others others others others others
Sedreco has two binary components , a dropper and the spying backdoor usually contained  in this dropper .		malware others others others others others others malware others others others others others others others others malware others
The dropper part of Sedreco has also been used to deploy a different payload :   a lightweight downloader  (not described in this whitepaper ) named msdeltemp.dll by its developers .		others malware others others malware others others others others others others others others others others others others others others others others others others others others others sample_name others others others others
We believe Sedreco was first used in 2012 , while our analysis was performed on samples  compiled mid-2016 .		others others malware others others others others time others others others others others others others others others others others
The workflow of Sedreco ’s dropper is composed of the five steps presented in Figure 12 .		others others others malware others others others others others others others others others others others others others others
While straightforward , this workflow possesses some features worth mentioning::The payload configuration is installed on the system by the dropper , in a file or in a registry key , depending on the sample .		others others others others others others others others others others others others others others others others others others others others others malware others others others others others others others others others others others others others others others
It means that analyzing a Sedreco payload sample itself will not reveal configuration information , such as the C&C server address  (configuration content  will be described below ) .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Payload persistence is usually ensured by registering an auto-start entry in the Windows  Registry , but we have observed other methods , like registering the payload as a Shell Icon  Overlay handler COM object .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
During its execution the dropper builds a small report , which is then sent to the C&C server .		others others others others malware others others others others others others others others others others others others others others others others
Here is an example of such a report :  INST MSD=0  INST FL=0  INST RUN=0  ST DL=0 .		others others others others others others others others others others others others others others others others others others
Each line corresponds to one step of the dropper workflow , as described in Figure 12 .		others others others others others others others others others others others others others others others others others
The value 0 means success , while there would be an error code returned from the Windows API  GetLastError otherwise .		others others others others others others others others others others others others others others others others tool tool others others others
In this section we will describe the internal working of the Sedreco payload :  first , its configuration file format ;  second , the commands it can execute ;  then , how it communicates with its C&C server ; and finally , how its functionality can be extended with plugins .		others others others others others others others others others others others malware others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The first action of Sedreco ’s payload is to retrieve the configuration file previously installed  by the dropper .		others others others others malware others others others others others others others others others others others others others malware others
This configuration file consists of a series of variably-sized data fields , preceded  by a header , as described in Figure 13 .		others others others others others others others others others others others others others others others others others others others others others others others
The configuration is encrypted with a custom algorithm using a 6-byte key stored at its beginning .		others others others others others others others others others others others others others others others others others
An implementation of this algorithm in Python can be found in ESET ’s GitHub repository .		others others others others others others program_language others others others others others others others tool others others
Following the key come 10 1-byte fields , each of them containing the size of a corresponding  data field .		others others others others others others others others others others others others others others others others others others others others
Those data fields contain the following values  (ESET ’s names ) :    Timer1: Time to wait between two attempts to ask the C&C server for a command  to execute  (usually set to 10 minutes ) .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Timer2: Time to wait between two attempts to exfiltrate data to the C&C server  (usually  set to 10 minutes ) .		others others others others others others others others others others others others others others others others others others others others others others others others others
Computer Name :  Computer name to which a pseudo-randomly generated 6-byte value  is appended , plus a two-byte value hardcoded in the dropper .		others others others others others others others others others others others others others others others others others others others others others others others others
C&C1: Domain name of the first C&C server .		others others others others others others others others others others others others others others
C&C2: Domain name of the second C&C server .		others others others others others others others others others others others others others others
Operation Name :  4-character string initially hardcoded in the dropper , which likely  identifies the operation or the target .		others others others others others others others others others others others others others others others others others others others others
So far , we have observed the following values :  rhze ,  rhdn , rhst , rhbp , mtfs , mctf , mtqs .		others others others others others others others others others others string others string others string others string others string others string others string others
We do not know the exact meaning of these values .		others others others others others others others others others others others
Keylogger MaxBuffer :  Maximum size of the memory buffer where keystrokes are logged ,  before they are dumped to the outbound file  (described below ) .		others others others others others others others others others others others others others others others others others others others others others others others others others others others
Keylogger MaxTimeout :  Maximum time to wait before the logged keystrokes are dumped  to the outbound file  (described below ) .		others others others others others others others others others others others others others others others others others others others others others others
Keylogger Flag :  Specify whether to enable the keylogger or not 10 .		others others others others others others others others others others others others others
C&C3: Domain name of the third C&C server .		others others others others others others others others others others others others others others
The next ten data fields are the paths to the plugins that Sedreco will load at startup .		others others others others others others others others others others others others malware others others others others others
These fields  are initially empty , and are updated when Sedreco receives a plugin to load from the C&C server .		others others others others others others others others others others malware others others others others others others others others others others others others
Once it is running , Sedreco provides numerous commands to its operators , identified by a number ,  as described in Table 4 .		others others others others others malware others others others others others others others others others others others others others others others others others others
Those commands allow the attackers to spy on the target , but also to collect  information on other computers accessible from the compromised machine .		others others others others others others others others others others others others others others others others others others others others others others others others others
Number Purpose .		others others others
1 Update configuration value .		others others others others others
2 Load plugin .		others others others others
3 Unload plugin .		others others others others
4 Start keylogger .		others others others others
5 Stop keylogge .		others others others others
6 List directories .		others others others others
7 Read file .		others others others others
8 Write file .		others others others others
9 Delete file or directory .		others others others others others others
10 Enumerate registry key .		others others others others others
11 Write registry key .		others others others others others
12 Delete registry key .		others others others others others
13 List running processes .		others others others others others
14 Create process .		others others others others
15 Terminate process .		others others others others
16 List loaded plugins .		others others others others others
17 Run Windows shell command  ( output temporarily stored in a file  named tmp.dat ) .		others others tool tool others others others others others others others others others sample_name others others
18 List connected devices .		others others others others others
19 Update Sedreco payload binary on disk .		others others tool others others others others others
20 Read file from a specified offset .		others others others others others others others others
21 Map network resources .		others others others others others
22 Run systeminfo Windows shell command .		others others others tool tool others others
23 List files and directories .		others others others others others others
24 Read file  (wrapper for command 6 ) .		others others others others others others others others others others
25 Run a given Sedreco command .		others others others others malware others others
26 Create thread .		others others others others
36 Start remote shell over HTTP  ( plugin command , see below ) .		others others others others others protocol others others others others others others others others
Interestingly , the commands are registered at runtime by calling an internal function — usually  exported under the name RegisterNewCommand — with the command number and the address  of the command handler .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
For example , Figure 14 shows the registration of the first six commands .		others others others others others others others others others others others others others others
This mechanism makes Sedreco a flexible backdoor , which includes only the commands in a sample  that are currently needed  (which means in particular that the previous list of commands may  not be complete ) .		others others others malware others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
It also allows plugins to easily register new commands , as we will explain later .		others others others others others others others others others others others others others others others others
Sedreco communicates with its C&C server in a quite unusual way , pictured in Figure 15 .		malware others others others others others others others others others others others others others others others others others others
On one hand , Sedreco network threads periodically ask the C&C server for orders , and store them  in an  “inbound file ” .		others others others others malware others others others others others others others others others others others others others others others others others others others others others others
Those orders are then fetched and processed by Sedreco core threads .		others others others others others others others others malware others others others
On the other  hand , the data to exfiltrate  (logged keystrokes , results of executed commands , etc ) are queued  in an  “outbound file ” ,  and periodically transmitted in bulk to the server by the network threads .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
As this asynchronous communication method limits the number of network contacts with the  C&C server , it might reduce the chance of attracting attention in the target ’s network .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Moreover ,  using files rather than keeping the data buffered in memory avoids losing the data if the machine  shuts down or loses network connectivity .		others others others others others others others others others others others others others others others others others others others others others others others others others others
In the following sections , we describe the network communications and the exact format  of the inbound/outbound files .		others others others others others others others others others others others others others others others others others others others
Sedreco regularly asks its C&C server for a command to run — usually every 10 minutes .		malware others others others others others others others others others others others others others others others others others others
The C&C server  domain names are retrieved from the configuration , and they are contacted in their order of appearance  in this configuration  (see configuration format ) .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
In other words , if the first C&C server is up — C&C1  in Figure 13 — the others are never contacted .		others others others others others others others others others others others others others others others others others others others others others others others others others others others
The actual contact is a POST request over HTTP or , depending of the sample , HTTPS , on the URI  /update .		others others others others others others others others protocol others others others others others others others protocol others others others others others others
The body of the request contains the base64-encoding of the data structure picturedThis data structure is encrypted with the 6-byte key stored at the end , using the same algorithm  as that used to encrypt the configuration file .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The Type field is set to 0 , which distinguishes inbound  from outbound .		others others others others others others others others others others others others others others
in Figure 16 .		others others others others
The C&C server will then answer with the information about a command to run , the commands  being stored in the inbound file by Sedreco network threads .		others others others others others others others others others others others others others others others others others others others others others others others others others others malware others others others
The inbound file is usually named  __2315tmp.dat and located in the %TEMP% directory .		others others others others others others others others others others others others others others others others
This file consists of a series of variably-sized  entries , each entry containing the information from the C&C server for one command to run , as described in Figure 17 .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
As before , each entry starts with a 6-byte key to decrypt the entry data , again using the same algorithm  used for the configuration .		others others others others others others others others others others others others others others others others others others others others others others others others others others
Then comes a 4-byte magic value , which , in all the samples we analyzed ,  has to be set to 0x75DF9115 for the command to be executed .		others others others others others others others others others others others others others others others others others others others others others string others others others others others others others
The entry may also contain the arguments to pass to the command handler .		others others others others others others others others others others others others others others
Finally , Sedreco core threads process the inbound file to extract and run the commands .		others others malware others others others others others others others others others others others others others
Sedreco core threads store the output generated by a command execution in the outbound file ,  which is usually named __4964tmp.dat and located in the %TEMP% directory .		malware others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Similarly to the inbound  file , it consists of a series of variably-sized entries , each entry describing one particular command  execution , as shown in Figure 18 .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Each entry begins with a 32-byte header , containing in particular a 4-byte magic number  (0xB2745DAF ) ,  the command return status code , a timestamp of the command execution  (in a SYSTEMTIME Windows structure ) , and the actual command number .		others others others others others others others others others others others others others others others others string others others others others others others others others others others others others others others others others others tool tool others others others others others others others others others
Then comes the output data generated  by the command execution , compressed with a custom implementation of the Lempel–Ziv–Welch  ( LZW ) algorithm .		others others others others others others others others others others others others others others others others others others encryption_algo encryption_algo encryption_algo encryption_algo others others
A source code search engine allowed us to retrieve what we believe  to be the C source code of the LZW algorithm implementation employed  by Sedreco.Figure 19 shows an extract of the compressed data header .		others others others others others others others others others others others others others others others others others others others others encryption_algo others others others others others others others others others others others others others others others
Sedreco network threads regularly — usually every 10 minutes — fetch the data from the outbound  file and encrypt them with the 3DES algorithm and a hardcoded key .		malware others others others others others others others others others others others others others others others others others others others others others encryption_algo others others others others others others
The data structure described  in Figure 16 is then appended to the encrypted data , thus acting as a footer .		others others others others others others others others others others others others others others others others others others others others others
In this case , the Type  field is set to 1 .		others others others others others others others others others others others others
Finally , the resulting encrypted data are transmitted to the C&C server by Sedreco network threads .		others others others others others others others others others others others others others others others malware others others others
An interesting feature of Sedreco is its ability to run external plugins .		others others others others others others others others others others others others others
The downloading and execution of those plugins can be requested by the C&C server with command number 1 , while their unloading  can be accomplished with command number 2  (see commands list ) .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
A Sedreco plugin comes as a Windows DLL with two exported functions named Init and UnInit .		others malware others others others others sample_name sample_name others others others others others others others others others
The plugin is loaded in the same address space as Sedreco ’s payload with a call to the Windows API  LoadLibraryA .		others others others others others others others others others others malware others others others others others others others others tool tool tool others
The plugin ’s Init export is then called , with the following structure as its argument .		others others others others others others others others others others others others others others others others others others
This structure contains some helper functions ’ addresses , plus some data addresses , from Sedreco ’s  payload , that the plugin may need during its execution .		others others others others others others others others others others others others others others others malware others others others others others others others others others others others others others
We only found one Sedreco plugin during our investigation .		others others others others malware others others others others others
Once loaded in memory , this plugin  registers a new command , numbered 36 , as shown in Figure 20 .		others others others others others others others others others others others others others others others others others others others others others
When called by the operators , the newly registered command will open a remote Windows  shell over HTTP .		others others others others others others others others others others others others others others tool tool others protocol others
When Sedreco exits , the payload unloads all plugins and calls their UnInit exports .		others malware others others others others others others others others others others others others others
In the case  of the plugin we retrieved , this export simply unregisters the command it provides , as shown  in Figure 21 .		others others others others others others others others others others others others others others others others others others others others others others others others
Interestingly , parts of the plugin code are shared with the Windows Xagent module named ProcessRetranslatorModule  (see table 1 ) .		others others others others others others others others others others others tool tool others others tool others others others others others others
In particular ,  the function in charge of creating a Windows shell process with some communication pipes is exactly the same in both binaries , including some custom error messages such as #EXC_1 Cannot create ExtToProc Pipe!		others others others others others others others others others others tool tool others others others others others others others others others others others others others others others others others others others others others others others others others others others others
.		others
With its ability to register new commands dynamically , Sedreco is a flexible backdoor that has been  used for many years by the Sednit group .		others others others others others others others others others malware others others others others others others others others others others others others others others others others
An interesting feature of Sedreco is the ability to load external plugins .		others others others others malware others others others others others others others others
As we only found one plugin ,  we hope this report will encourage other researchers to contribute further pieces to the puzzle .		others others others others others others others others others others others others others others others others others others others others others others others
In particular , it would be interesting to search for other code-sharing cases between Sedreco plugins  and Xagent modules .		others others others others others others others others others others others others others others malware others others malware others others