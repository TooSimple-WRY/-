BlackOasis APT and new targeted attacks leveraging zero-day exploit Release_Time : 2017-10-16 Report_URL : https://securelist.com/blackoasis-apt-and-new-targeted-attacks-leveraging-zero-day-exploit/82732/ Kaspersky Lab has always worked closely with vendors to protect users .		threatActor_name others others others others others others vul_aliases others others others others others others others others others security_team security_team others others others others others others others others others others
As soon as we find new vulnerabilities we immediately inform the vendor in a responsible manner and provide all the details required for a fix .		others others others others others others others others others others others others others others others others others others others others others others others others others others
On October 10 , 2017 , Kaspersky Lab's advanced exploit prevention systems identified a new Adobe Flash zero day exploit used in the wild against our customers .		others time time time time others tool tool tool tool tool tool tool others others others company company vul_aliases vul_aliases others others others others others others others others others
The exploit was delivered through a Microsoft Office document and the final payload was the latest version of FinSpy malware .		reference_word reference_word others others others others tool tool tool others tool tool tool others tool tool tool tool malware tool others
We have reported the bug to Adobe who assigned it CVE-2017-11292 and released a patch earlier today :  Vulnerability details : Vulnerability Category : Type Confusion , Vulnerability Impact : Remote Code Execution , Severity : Critical , CVE Number : CVE-2017-11292 .		others others others reference_word reference_word others company others others reference_word vulnerability_cve others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others vulnerability_cve others
So far only one attack has been observed in our customer base , leading us to believe the number of attacks are minimal and highly targeted .		others others others others others others others others others others others others others others others others others others others others others others others others others others others
Analysis of the payload allowed us to confidently link this attack to an actor we track as "BlackOasis" .		others others others others others others others others others others others others others others others others others others threatActor_name others others
We are also highly confident that BlackOasis was also responsible for another zero day exploit ( CVE-2017-8759 ) discovered by FireEye in September 2017 .		others others others others others others threatActor_name others others others others others vul_aliases vul_aliases others others vulnerability_cve others others others security_team others time time others
The FinSpy payload used in the current attacks ( CVE-2017-11292 ) shares the same command and control ( C2 ) server as the payload used with CVE-2017-8759 uncovered by FireEye .		others malware tool others others others others sub_activity others vulnerability_cve others others others others others others others others tool others others others others others others others vulnerability_cve others others security_team others
We first became aware of BlackOasis' activities in May 2016 , while investigating another Adobe Flash zero day .		others others others others others threatActor_name others others others time time others others others others company company vul_aliases vul_aliases others
On May 10 , 2016 , Adobe warned of a vulnerability ( CVE-2016-4117 ) affecting Flash Player 21.0.0.226 and earlier versions for Windows , Macintosh , Linux , and Chrome OS .		others time time time time others company others others others reference_word others vulnerability_cve others others tool tool tool others others others others OS_name others OS_name others OS_name others others OS_name OS_name others
The vulnerability was actively being exploited in the wild .		reference_word reference_word others others others others others others others others
Kaspersky Lab was able to identify a sample exploiting this vulnerability that was uploaded to a multi scanner system on May 8 , 2016 .		security_team security_team others others others sub_activity sub_activity sub_activity sub_activity reference_word reference_word others others others others others tool tool tool others time time time time others
The sample , in the form of an RTF document , exploited CVE-2016-4117 to download and install a program from a remote C&C server .		reference_word reference_word others others others others others others others others others others vulnerability_cve others sub_activity sub_activity sub_activity sub_activity sub_activity others tool tool protocol protocol protocol tool others
Although the exact payload of the attack was no longer in the C&C , the same server was hosting multiple FinSpy installation packages .		others others others others others others others others others others others others protocol protocol protocol others others others others others others others tool tool tool others
Leveraging data from Kaspersky Security Network , we identified two other similar exploit chains used by BlackOasis in June 2015 which were zero days at the time .		others others others tool tool tool others others others others others others others others others others threatActor_name others time time others others vul_aliases others others others others others
Those include CVE-2015-5119 and CVE-2016-0984 , which were patched in July 2015 and February 2016 respectively .		reference_word others vulnerability_cve others vulnerability_cve others others others others others time time others time time others others
These exploit chains also delivered FinSpy installation packages .		reference_word others others others others tool tool tool others
Since the discovery of BlackOasis' exploitation network , we've been tracking this threat actor with the purpose of better understanding their operations and targeting and have seen a couple dozen new attacks .		others others others others threatActor_name others others others others others others others sub_activity target_crowd target_crowd target_crowd others others others others others others others others others others others others others others others others others others others
To summarize , we have seen BlackOasis utilizing at least five zero days since June 2015: CVE-2015-5119 – June 2015 , CVE-2016-0984 – June 2015 , CVE-2016-4117 – May 2016 , CVE-2017-8759 – Sept 2017 , CVE-2017-11292 – Oct 2017 .		others others others others others others threatActor_name others others others others tool tool others time time others vulnerability_cve others time time others vulnerability_cve others time time others vulnerability_cve others time time others vulnerability_cve others time time others vulnerability_cve others time time others
The attack begins with the delivery of an Office document , presumably in this instance via e-mail .		others others others others others others others others tool tool others others others others others others tool others
Embedded within the document is an ActiveX object which contains the Flash exploit .		others others tool tool others others tool tool others others others tool tool others
The Flash object contains an ActionScript which is responsible for extracting the exploit using a custom packer seen in other FinSpy exploits .		others tool tool others others program_language others others others others sample_function sample_function sample_function others tool tool tool others others others malware tool others
The exploit is a memory corruption vulnerability that exists in the "com.adobe.tvsdk.mediacore.BufferControlParameters" class .		reference_word reference_word others others others others others others others others others others sample_name others others others
If the exploit is successful , it will gain arbitrary read / write operations within memory , thus allowing it to execute a second stage shellcode .		others reference_word reference_word others others others reference_word others sample_function sample_function sample_function sample_function sample_function sample_function others tool others others others reference_word others sample_function sample_function sample_function sample_function sample_function others
The first stage shellcode contains an interesting NOP sled with alternative instructions , which was most likely designed in such a way to avoid detection by antivirus products looking for large NOP blocks inside flash files .		others others others tool others others others tool tool others others others others others others others others others others others others others others sample_function sample_function sample_function sample_function sample_function others others others tool tool others tool tool others
The main purpose of the initial shellcode is to download second stage shellcode from http://89.45.67.107/rss/5uzosoff0u.iaf .		others others others others others others tool others others sample_function sample_function sample_function sample_function others url_evil url_evil url_evil others
The second stage shellcode will then perform the following actions : Download the final payload ( FinSpy ) from http://89.45.67.107/rss/mo.exe , Download a lure document to display to the victim from the same IP , Execute the payload and display the lure document .		others others others tool others others others others others others others sample_function tool tool tool others malware others others url_evil url_evil url_evil others sample_function sample_function sample_function tool sample_function sample_function sample_function target_crowd target_crowd others others others protocol others sample_function sample_function sample_function others sample_function sample_function sample_function sample_function others
As mentioned earlier , the "mo.exe" payload ( MD5: 4a49135d2ecc07085a8b7c5925a36c0a ) is the newest version of FinSpy malware , typically sold to nation states and other law enforcement agencies to use in lawful surveillance operations .		others others others others others others sample_name others others others encryption_algo others md5 others others reference_word reference_word reference_word reference_word malware reference_word others others others others location location others others industry industry industry others others others others others others others
This newer variant has made it especially difficult for researchers to analyze the malware due to many added anti-analysis techniques , to include a custom packer and virtual machine to execute code .		others tool tool others others reference_word others others others person others sub_activity sub_activity sub_activity others others others others others others others others others tool tool tool others sub_activity sub_activity sub_activity sub_activity sub_activity others
The PCODE of the virtual machine is packed with the aplib packer .		others tool others others tool tool others others others others tool tool others
After unpacking the virtual machine PCODE is then decrypted .		others others others others others tool others others others others
Once the payload is successfully executed , it will proceed to copy files to the following locations : C:\ProgramData\ManagerApp\AdapterTroubleshooter.exe , C:\ProgramData\ManagerApp\15b937.cab , C:\ProgramData\ManagerApp\install.cab , C:\ProgramData\ManagerApp\msvcr90.dll , C:\ProgramData\ManagerApp\d3d9.dll .		others others others others others others others reference_word others others others others others others others others others others location location location others location location location others location location location others location location location others location location location others
The "AdapterTroubleshooter.exe" file is a legitimate binary which is leveraged to use the famous DLL search order hijacking technique .		others others sample_name others others others others others others others others others others sample_function sample_function sample_function tool sample_function sample_function sample_function sample_function others
The "d3d9.dll" file is malicious and is loaded into memory by the legit binary upon execution .		others others sample_name others others others others others others others others location others others others others others others others
Once loaded , the DLL will then inject FinSpy into the Winlogon process .		others others others others tool others others sample_function malware sample_function sample_function tool tool others
The payload calls out to three C2 servers for further control and exfiltration of data .		tool tool others others others tool tool tool others others sample_function sample_function sample_function sample_function sample_function others
We have observed two of them used in the past with other FinSpy payloads .		others others others others others reference_word others others others others others others malware tool others
Most recently one of these C2 servers was used together with CVE-2017-8759 in the attacks reported by FireEye in September 2017 .		others others others others reference_word tool others others others others others vulnerability_cve others others others others others security_team others time time others
These IPs and other previous samples tie closely to the BlackOasis APT cluster of FinSpy activity .		others others others others others others others others others others threatActor_name others others others malware others others
BlackOasis' interests span a wide gamut of figures involved in Middle Eastern politics and verticals disproportionately relevant to the region .		threatActor_name others others others others others others others target_crowd others others location location industry others others others others others reference_word reference_word others
This includes prominent figures in the United Nations , opposition bloggers and activists , and regional news correspondents .		others others others target_crowd target_crowd target_crowd target_crowd target_crowd others target_crowd target_crowd others target_crowd others others target_crowd target_crowd target_crowd others
During 2016 , we observed a heavy interest in Angola , exemplified by lure documents indicating targets with suspected ties to oil , money laundering , and other illicit activities .		others time others person others others others others others location others others others tool tool others others others others others others industry others attack_goal attack_goal others others others attack_goal attack_goal others
There is also an interest in international activists and think tanks .		others others others others others others person person others person person others
Victims of BlackOasis have been observed in the following countries : Russia , Iraq , Afghanistan , Nigeria , Libya , Jordan , Tunisia , Saudi Arabia , Iran , Netherlands , Bahrain , United Kingdom and Angola .		person others threatActor_name others others others others others others others others location others location others location others location others location others location others location others location location others location others location others location others location location others location others
We estimate that the attack on HackingTeam in mid-2015 left a gap on the market for surveillance tools , which is now being filled by other companies .		others others others others sub_activity sub_activity company others time others others others others others others others others others others others others others others others others others others others
One of these is FinFisher with their suite of tools .		others others others others tool others others others others others others
We believe the number of attacks relying on FinFisher software , supported by zero day exploits such as the ones described here will continue to grow .		others others others others others others others others tool tool others others others vul_aliases vul_aliases others others others others others others others others others others others others
What does it mean for everyone and how to defend against such attacks , including zero-day exploits?		others others others others others others others others others others others others others others others vul_aliases others others
For CVE-2017-11292 and other similar vulnerabilities , one can use the killbit for Flash within their organizations to disable it in any applications that respect it .		others vulnerability_cve others others others others others person others others others tool others tool others others others others sub_activity reference_word sub_activity sub_activity sub_activity others others reference_word others
Unfortunately , doing this system-wide is not easily done , as Flash objects can be loaded in applications that potentially do not follow the killbit .		others others others others others others others others others others others tool tool others others others others others others others others others others others tool others
Additionally , this may break any other necessary resources that rely on Flash and of course , it will not protect against exploits for other third party software .		others others others others others others others others others others others others tool others others others others reference_word others others others others others others others others others others others
Deploying a multi-layered approach including access policies , anti-virus , network monitoring and whitelisting can help ensure customers are protected against threats such as this .		others others others others others tool tool others tool others tool tool others tool others others others person others others sample_function sample_function others others others others
Users of Kaspersky products are protected as well against this threat by one of the following detections : PDM : Exploit.Win32.Generic , HEUR : Exploit.SWF.Generic , HEUR : Exploit.MSOffice.Generic .		person others tool tool others others others others sample_function sample_function sample_function others others others others others others others sample_name sample_name sample_name others sample_name sample_name sample_name others sample_name sample_name sample_name others