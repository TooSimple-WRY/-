OSX Malware Linked to Operation Emmental Hijacks User Network Traffic .		malware malware others others others sub_activity sub_activity sub_activity sub_activity sub_activity others
Release_Time : 2017-07-10 Report_URL : https://blog.trendmicro.com/trendlabs-security-intelligence/osx_dok-mac-malware-emmental-hijacks-user-network-traffic/ The OSX_DOK malware ( Detected by Trend Micro as OSX_DOK.C ) showcases sophisticated features such as certificate abuse and security software evasion that affects machines using Apple ’s OS X operating system .		others others others others others others others others others malware malware others others others security_team security_team others malware others others others others others others others others others others others others others others others others OS_name OS_name OS_name OS_name OS_name others others others
This malware , which specifically targets Swiss banking users , uses a phishing campaign to drop its payload , which eventually results in the hijacking of a user ’s network traffic using a Man-in-the- Middle ( MitM ) attack .		others malware others others others others target_crowd target_crowd target_crowd others others others attack_activity attack_activity others others others others others others others others others others others others others target_crowd others others others others others others attack_activity attack_activity attack_activity attack_activity attack_activity attack_activity others
OSX_DOK.C seems to be another version of WERDLOD ( Detected by Trend Micro as TROJ_WERDLOD Family ) , which is a malware that was used during the Operation Emmental campaigns—an interesting development that we will tackle further in this blog post .		malware others others others others others others malware others others others security_team security_team others malware malware others others others others others others others others others others others attack_activity attack_activity others others others others others others others others others others others others others
OSX_DOK.C first arrives via a phishing email that contains certain files labeled as either .zip or .docx files .		malware others others others others email_evil email_evil others others others others others others others others others others others others
The sample we analyzed was a purported message from a police inspector in Zurich allegedly claiming to unsuccessfully contact the recipient .		others others others others others others others others others others person others others location others others others others others others others others
The email also comes with two files attached claiming to contain questions for the user : one is a .zip file , which is a fake OS X app , while the other is a .docx file used to target Windows operating systems using WERDLOD .		others reference_word others others others others others others others others others others others others target_crowd others others others others others others others others others others others OS_name OS_name tool others others others others others others others others others others others OS_name others others others malware others
Both of these samples work as Banking Trojans and provide similar functionalities .		others others others others others others malware malware others others others others others
Some examples of the files used in the email attachment include the following :  Zahlungsinformationen 01.06.2017.zip .		others others others others others others others others others others others others others others sample_name sample_name others
Zahlungsinformationen digitec.zip .		sample_name sample_name others
zip .		sample_name others
Dokument 09.06.2017.zip .		sample_name sample_name others
Dokument 09.06.2017.docx .		sample_name sample_name others
docx .		sample_name others
06.2017.docx .		sample_name others
Once the docx file included in the phishing email is clicked , a warning window will pop up .		others others others others others others others attack_activity attack_activity others others others others others others others others others others
After this , the App Store on the system will be removed , followed by a full screen fake OS X update screen .		others others others others tool tool others others others others others others others others others others others others others OS_name OS_name others others others
It will ask for a password to run command as root .		others others others others others others others others others others others others
The malware will begin to download other utilities .		others others others others others others others tool others
It relies on Homebrew , an open source software package manager to install Golang and Tor .		reference_word others others tool others others others others tool others others others others tool others tool others
The malware will then install fake certificates in the system to perform a MitM attack without notifying the user .		others reference_word others others others others others others others others others others others attack_activity attack_activity others others others target_crowd others
The structure of the fake App Store matches the application bundle structure and provides both English and German interfaces .		others others others others others tool tool others others others others others others others others location others location others others
The main executable is Dokument.app/Contents/MacOS/AppStore .		others others others others others others
The archive in Mac OS X looks like this :  Mac OS X will run the application if it passes certificates .		others others others OS_name tool tool others others others others OS_name tool tool others others others others others others others others others
In this case , the malware is signed off by a “ developer ” , which may actually be a dummy account or that of a compromised user .		others others others others others reference_word others others others others others others person others others others others others others others others others others others others others others target_crowd others
In addition , the time stamp on the CA is new , which might mean that it was obtained specifically for this attack .		others others others others time others others others company others others others others others others others time others others others others others sub_activity others
The fake certificate imitates the COMODO root certificate .		others others others others others company others others others
Take note that the fake certificate does not contain a COMODO Certificate Authority seal that certifies its validity , as seen in the comparison below :  We noticed that this malware will not work for Mozilla Firefox or Google Chrome since these two browsers have their own root certificates .		others others others others others others others others others others company company company others others others others others others others others others others others others others others others others others others others others others others company tool others company tool others others others tool others others others others others others
Of all the major browsers , only Safari uses the system ’s certificates .		others others others others tool others others tool others others others others others others others
We observed the attacker targeting both Windows and Mac OS X in the same spam mail on June 9 , 2017 .		others others others person others others OS_name others OS_name tool tool others others others sub_activity sub_activity others others time time time others
There is a file shortcut embedded in the malicious .docx file—one that will download an executable file from Dropbox—that executes once clicked by the user .		others others others others others others others others others others others others others others others others others others others others others others others others target_crowd others
The functionalities are similar to the malicious app provided , which includes installing tor and proxy .		others others others others others others malware malware others others others others others tool others tool others
We have already notified Dropbox about the use of its service for this malware .		others others others others tool others others others others others others others others others others
Dropbox has already taken down the links .		tool others others others others others others others
The malware will install two proxies running on local host port 5555 and 5588 .		others others others others others tool others others others others others others others others others
All of the traffic will be hijacked into the first proxy ( port 5555 ) with the victim ’s external IP address as parameter .		others others others others others others others others others others others others others others others others others others others others others others others others others others
The first ( port 5555 ) proxy first finds the IP parameter .		others others others others others others others others others others others others others
If it is not in Switzerland , the traffic will proceed as normal .		others others others others others location others others others others others others others others
If it detects an IP located in Switzerland , the malware will run an obfuscated JavaScript code and find its visiting domain .		others others others others IP others others location others others malware malware others others others others others others others others others others others
If the domain is in the target , the malware will perform a MitM attack and redirect the traffic to the second proxy ( port 5588 ) , which routes the traffic to the Tor network .		others others others others others others others others others reference_word others others others attack_activity attack_activity others others others others others others others others others others others others others others others others others others others others others others
The purpose of these steps is to target users in Switzerland and hijack their traffic After deobfuscating the malware , we found the target domains :  The target domain ’s visitors will be redirected into an e-banking login page that looks and acts normally , but is located on dark web sites .		others others others others others others others others target_crowd others location others others others others others others others reference_word others others others others others others others others others others others others target_crowd others others others others others others others others others others others others others others others others others others others others others others
However , once the victim enters an account and password .		others others others others others others others others others others others
A window will pop out .		others others others others others others
The pop-out window is just smoke and mirrors , where nothing actually happens once the countdown timer reaches zero .		others others others others others others others others others others others others others others others others others others others others
We analyzed the webpage and found attackers injecting a script into the webpage .		others others others others others others person others others others others others others others
Once the user enters an account and password , it will initiate POST using AJAX .		others others target_crowd others others others others others others others others others others others others others
The POST message is sent to the same site as the fake login page—which an attacker can control inside the Tor network .		others others others others others others others others others others others others others others others person others others others others others others others
We decoded the data section and found not only the account and password , but that it also fingerprinted the user ’s browser and system information .		others others others others others others others others others others others others others others others others others others others others target_crowd others others others others others others others
While Operation Emmental was able to bypass two-way authentication by tricking its victims into installing a fake app , we have not observed OSX_DOK.C doing this .		others attack_activity attack_activity others others others others others others others others others others others others others tool tool others others others others others malware others others others
However , since they can inject code into the webpage , it means they have the ability to do this as well .		others others others others others others others others others others others others others others others others others others others others others others others
We performed static analysis on the sample and found it packed by Ultimate Packer for Executables ( UPX ) , an open source executable packer that can often be abused by malware .		others others others others others others others others others others others others tool tool others tool others others others others others others others others others others others others others others others malware others
We successfully unpacked the initial sample we found dropped by the UPX unpacker .		others others others others others others others others others others others tool tool others
The malware is not obfuscated so we easily found interesting strings here .		others malware others others others others others others others others others others others
We can see that the malware relies on bash shell for most of its setup .		others others others others others malware others others others others others others others others others others
We were not able to unpack the sample discovered after June 9 , 2017 .		others others others others others others others others others others time time time time others
The UPX gave a warning message about memory buffer overflow .		others tool others others others others others others others others others
The malware author seemingly made unpacking the malware more difficult to slow down or even evade the antivirus engine ’s scanning process .		others malware others others others others others others others others others others others others others others others others others others others others others others
The packer is the same but the malware tries to exploit the undiscovered bug in the UPX library that causes unpack failure .		others others others others others others others others others others others others others others others others tool others others others others others others
We have reported the issues to the UPX team , and they have already fixed it .		others others others others others others others tool others others others others others others others others others
The impacted versions of the UPX library are 3.94 , 3.93 , and 3.92 .		others others others others others tool others others others others others others others others others
This technique enables the malware to efficiently run while evading unpacking techniques from the AntiVirus-integrated UPX library .		others others others others others others others others others others others others others others others others others others
As mentioned earlier , we believe that OSX_DOK.C might be the MAC OS X version of WERDLOD , an online banking malware that used the same techniques as Operation Emmental .		others others others others others others others malware others others others OS_name others others others others malware others others others others malware others others others others others others tool tool others
Other research have also connected the OSX malware and Retefe ( the external term used for WERDLOD ) via similarities in their behavior .		others others others others others others OS_name others others others others others others others others others malware others others others others others others others
While OSX_DOK.C is designed for MAC OS X , which is a Unix-like system , WERDLOD is designed for Windows .		others malware others others others OS_name tool tool others others others others others others others malware others others others OS_name others
But in terms of features and behaviors , these two malware are very similar .		others others others others others others others others others others others others others others others
Here is a list of their similarities .		others others others others others others others others
Both malware kill all current browsers before installing fake certificates :  Both WERDLOD and OSX_DOK.C are designed to kill the browser process before installing fake certificates .		others others others others others others others others others others others others malware others malware others others others others others others others others others others others others
While WERDLOD kills processes for Internet Explorer , Firefox , and Chrome , OSX_DOK.C does the same on Safari , Firefox , and Chrome .		others malware others others others tool tool others tool others others tool others malware others others others others tool others tool others others tool others
Both malware share the same proxy settings and script :  While WERDLOD and OSX_DOK.C use different codes ( since they target different operating systems ) , they have similar proxy settings and script formats .		others malware others others others others others others others others others malware others malware others others others others others others others others others others others others others others others others others others others others others
In particular , WERDLOD uses scripts running on hxxp://127.0.0.1:5555/#{random_string}.js?ip=#{my_ip} as proxy :  Comparing it to OSX_DOK.C , we can see that it uses the same script format :  Both malware have similar targets :  Both WERDLOD and OSX_DOK.C targeted financial institutions , with a particular focus on banks in Switzerland .		others others others malware others others others others others others others others others others others others others others others others others others others others others others others others malware others others others others others others others others others others others others others malware others others others others others malware others malware others industry industry others others others others others others industry others location others
Further analysis of both malware revealed that their main targets are very similar , as seen in the screenshot below .		others others others others malware others others others others others others others others others others others others others others others others
While it ’s possible that this is a coincidence , the rest of the evidence makes it unlikely for these two malware to target the same organizations by chance .		others others others others others others others others others others others others others others others others others others others others others others malware others others others others industry others others others
Given the connection between WERDLOD and OSX_DOK.C , it is reasonable to assume that the latter is also a part of the Operational Emmental campaign .		others others others others malware others malware others others others others others others others others others others others others others others others attack_activity attack_activity others others
To further illustrate , here is a timeline of Operation Emmental and its potential relationship to OSX_DOK.C :  Despite phishing incidents for Mac devices being rarer than their Windows counterparts , users should still be aware that attackers can target them at any moment .		others others others others others others others others others attack_activity attack_activity others others others others others malware others others sub_activity others others OS_name others others others others others OS_name others others person others others others others others person others others person others others others others
By implementing best practices for phishing-type attacks—such as refraining from downloading files unless they are absolutely certain that they come from trustworthy sources—users can avoid being victimized by malware such as OSX_DOK.C that prey on users who lack awareness of phishing strategies .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others malware others others others others others others others others others others others
In addition , end users can also benefit from security solutions such as Trend Micro Home Security for Mac , which provides comprehensive security and multi-device protection against viruses , ransomware , malicious websites , and identity thieves .		others others others others person others others others others others others others others security_team security_team security_team security_team others OS_name others others others others others others others others others malware others malware others malware malware others others malware malware others
It also provides secure storage of passwords and other sensitive information .		security_team others others others others others others others others others others others
Trend Micro™ Mobile Security for Apple devices ( available on the App Store ) can monitor and block phishing attacks and other malicious URLs .		security_team security_team security_team security_team others company tool others others others others tool tool others others others others others sub_activity sub_activity others others others url_evil others
For enterprises , Trend Micro ’s Smart Protection Suites with XGen™ security , which support Mac systems , infuse high-fidelity machine learning into a blend of threat protection techniques to eliminate security gaps across any user activity and any endpoint .		others others others security_team security_team security_team security_team security_team security_team security_team others security_team security_team others others others tool others others others others others others others others others others others others others others others others others others others others others others others others others
With additional analysis from Yi-Jhen Hsieh ( DSNS lab , National Chiao Tung University )		others others others others others others others others others others others others others others others