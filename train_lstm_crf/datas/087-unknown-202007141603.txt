Technical analysis of recent attacks against Polish banks .		others others others others others others industry industry others
Release_Time : 2017-02-16 Report_URL : https://badcyber.com/technical-analysis-of-recent-attacks-against-polish-banks/ It has been three weeks since first information about succesful attacks on Polish banks has reached our ears .		others others others others others others others others others others others others others others others others others others others others industry industry others others others others others
It's time to put together the technical description of how the attacks were performed .		others others others others others others others others others others others others others others others others
When two weeks ago we have revealed the fact that a few Polish banks were hacked by uknown attackers , the banks were super busy scanning internal networks and looking for intruders .		others others others others others others others others others others others others industry industry others others others others person others target_crowd target_crowd others others others sub_activity sub_activity sub_activity others sub_activity sub_activity sub_activity others
Nobody bothered to write down the details of the infection process .		others others others others others others others others others others others others
Since then some companies tried to cover less or more technical details of this attack .		others others others others others others others others others others others others others others others others
We've seen publications by Symantec , Booz Allen and BAE Systems : we particulary recommend the latter , as in our opinion it includes the most technically correct information confirmed by multiple sources .		others others others others others company others company company others company company others others others others others others others others others others others others others others others others others others others others others others others
In this article we will try to cover the whole infection process : starting with a bank employee visiting the Polish Financial Supervision Authority website and ending in his workstation being infected by a clever RAT .		others others others others others others others others others others others others others others others person person person sub_activity sub_activity government government government government sub_activity others others others others attack_goal attack_goal attack_goal others others others tool others
We will include only one of the infection scenarios : we understand that there were others with less or more significant differences .		others others others others others others others others others others others others others others others others others others others others others others others
To start the infection process a bank employee had to visit the www.knf.gov.pl website sometimes between October 5h , 2016 and February 2nd , 2017 .		others others others others others others person person others others sub_activity sub_activity sub_activity sub_activity others others time time others time others time time time time others
Most pages on this website included the following script : http://www.knf.gov.pl/DefaultDesign/Layouts/KNF2013/resources/accordian-src.js?ver=11 .		others others others others others others others others tool others url url url url url others
Somewhere next to the end of this file an external script was included : depending on the month it was either http://sap.misapor.ch/vishop/view.jsp?pagenum=1 or http://www.eye-watch.in/design/fancybox/images.jsp?pagenum=1 .		others others others others others others reference_word reference_word others others others others others others others others others others others others others url_evil url_evil url_evil url_evil url_evil others url_evil url_evil url_evil url_evil url_evil others
Attackers' controlled server performed some initial verification of the visitor : most probably based on IP whitelists including address classess deemeed interesting by the attackers .		tool tool tool tool sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others others others others tool tool others tool tool others others others others person others
Once the target was confirmed as interesting , it received one of four exploits : cambio.xap file attacking vulnerable Silverlight plugin : 4cc10ab3f4ee6769e520694a10f611d5 .		others others others others others others others others reference_word sub_activity sub_activity sub_activity sub_activity sub_activity others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others sample_name others
including a malicious DLL file or cambio.swf file attempting to exploit Flash plugin : 6dffcfa68433f886b2e88fd984b4995a , 1f2cd85583a4a56b764ba6429c2155ec .		others others others tool tool others tool tool others others others tool tool others sample_name others sample_name others
including three exploits : CVE-2015-8651 , CVE-2016-1019 and CVE-2016-4117 .		others others others others vulnerability_cve others vulnerability_cve others vulnerability_cve others
Exploits used in this attack were borrowed from commercial exploit packs .		others others others others others others others others others others others others
As far as we know at the moment of the attacks none of the exploited vulnerabilities were considered a 0day .		others others others others others others others others others others others others others others others others others others others others others
The exploit call included a parameter pointing to a shellcode , which downloaded a reconnaissance tool ( described in the BAE article ) from the same domain .		others others others others others others others others others others others others others others others others others others others others company others others others others others others others
The tools gathered some basic info about the machine and uploaded it back to its server .		others others others others others others others others others others others others others others others others others
If the analysis results were deemed interesting to the attackers , they could manually trigger downloading another malicious component , served as perfmon.dat .		others others others others others others others others others person others reference_word others others sub_activity sub_activity sub_activity sub_activity sub_activity others others others sample_name others
It was an encrypted EXE file , which was run on the target system after decryption .		reference_word others others others reference_word reference_word others others others others others others others others others others others
There was an EXE bedceafa2109139c793cb158cec9fa48f980ff2b found on one of the infected computers , which played the role of the installer for the next malware stage .		others others others sample_name sample_name others others others others others tool tool others others others others others others others reference_word others others others others others others
It is a simple commandline tool , with basic capabilities , including : -l :  list of potential services which clould be used by malware , -e [NAME] :  unpacks DLL and CHM files under given NAME .		reference_word others others others others others others others others others others others others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function others
The installer decrypts and saves two files ( depending on target architecture in 32 or 64bit versions ) : a DLL file protected with commercial Enigma packer and a CHM file .		others reference_word others others others others others others others others others others others others others others others others others others tool tool others others others others others others others tool tool others
The DLL file can be named srservice.dll e29fe3c181ac9ddbb242688b151f3310 and is installed as a service , while the CHM file would be named srservice.chm 9216b29114fb6713ef228370cbfe4045 and saved in %WINDIR%\Help folder .		others tool tool others others others sample_name sample_name others others others others others others others others others tool tool others others others sample_name sample_name others others others tool tool tool tool others others
In reality the CHM file is an encrypted DLL injected into the process .		others others others tool tool others others others tool others others others others others
The service also decrypts the config file srservice.hlp : 8e32fccd70cec634d13795bcb1da85ff .		others others others others others others others sample_name others sample_name others
Files are encrypted using a RC4 variant called Spritz .		others others others others others tool others others tool others
The config file includes , among other information , two domain names looking like C&C server : which they are not : tradeboard.mefound.com : 443 , movis-es.ignorelist.com : 443 .		others others others others others others others others others others others others others others tool tool tool tool others others others others others others domain_evil domain_evil domain_evil others domain_evil domain_evil domain_evil others
In an interesting plot twist the malware resolves those domains to their real IP addresses , but then performs a XOR operation on the original IPs to obtain true C&C IP addresses .		others others others others others others others others reference_word others others others others others others others others others sub_activity sub_activity sub_activity sub_activity others others others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
The service.chm file is the final stage of this part of infection scenario : it's a RAT connecting to the C&C and taking orders .		others tool tool others others others others others others others others others others others reference_word others others tool sub_activity sub_activity sub_activity protocol protocol protocol others sub_activity sub_activity others
Some of the 20-something commands include :  CMDL : execute command , write result to temporary file , upload the file to C&C and delete it DEL : remove file DIE : turn off DIR : search files or folders DOWN : download and save file DRIV : list logical drives GCFG : download current config PEEX : inject into explorer.exe PKIL : kill process PVEW : display information about running processes RUN : execute SCFG : get new config , encrypt it and save UPLD : upload file to C&C WIPE : secure delete .		others others others others others others others tool others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function protocol protocol protocol sample_function sample_function sample_function tool others sample_function sample_function tool others sample_function sample_function tool others sample_function sample_function sample_function sample_function tool others sample_function sample_function sample_function sample_function tool others sample_function sample_function sample_function tool others sample_function sample_function sample_function tool others sample_function sample_function sample_name tool others sample_function sample_function tool others sample_function sample_function sample_function sample_function sample_function tool others sample_function tool others sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function tool others sample_function sample_function sample_function protocol protocol protocol tool others sample_function sample_function others
Another piece of malware identified during incident response was the fdsvc.exe file 9914075cc687bdc352ee136ac6579707 probalby run manually or coming from a different infection process .		others others others others others others others others others others sample_name others sample_name others others others others others others others others others others others
The file accepts parameters pointing to a server it should connect to and the process it should inject malicious code into .		others others others others others others others others others others others others others others others others others others others others others others
The injected file was fdsvc.dll 9cc6854bc5e217104734043c89dc4ff8 which was also encrypted .		others others others others sample_name sample_name others others others others others