VPNFilter EXIF to C2 mechanism analysed Release_Time :  2018-05-24 Report_URL :  https://securelist.com/vpnfilter-exif-to-c2-mechanism-analysed/85721/ On May 23 2018 , our colleagues from Cisco Talos published their excellent analysis of VPNFilter , an IoT / router malware which exhibits some worrying characteristics .		malware tool others tool others others others others others others others others others others others time time time others others others others security_team security_team others others others others others malware others others others others others others others others others others others others
Some of the things which stand out about VPNFilter are :  It has a redundant , multi-stage command and control mechanism which uses three different channels to receive information .		others others others others others others others others malware others others reference_word sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
It has a multi-stage architecture , in which some of the more complex functionality runs only in the memory of the infected devices .		reference_word sub_activity sub_activity sub_activity sub_activity others others others others others others others others others others others others others others others others others others others
It contains a destructive payload which is capable of rendering the infected devices unbootable .		reference_word sub_activity sub_activity sub_activity sub_activity others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
It uses a broken ( or incorrect ) RC4 implementation which has been observed before with the BlackEnergy malware .		reference_word sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity encryption_algo sub_activity others others others others others others others malware others others
Stage 2 command and control can be executed over TOR , meaning it will be hard to notice for someone checking the network traffic .		others others tool tool tool others others others others tool others others others others others attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
We ’ve decided to look a bit into the C&C mechanism for the persistent malware payload .		others others others others others others others others others others tool tool tool sub_activity others others others others others others
As described in the Talos blog , this mechanism has several stages :  First , the malware tries to visit a number of gallery pages hosted on photobucket.com and fetches the first image from the page .		others others others others others others others reference_word reference_word others others others others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others domain_evil others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
If this fails , the malware tries fetching an image file from a hardcoded domain , toknowall.com .		others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others domain_evil others
This C2 domain is currently sinkholed by the FBI .		reference_word tool reference_word others others others others others government others
If that fails as well , the malware goes into a passive backdoor mode , in which it processes network traffic on the infected device waiting for the attacker ’s commands .		others others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal attack_goal others
For the first two scenarios in which the malware successfully receives an image file , a C2 extraction subroutine is called which converts the image EXIF coordinates into an IPv4 address .		others others others others others others others others others others others others others others others others tool sub_activity sub_activity sub_activity sub_activity others sub_activity sub_activity sub_activity tool sub_activity sub_activity sub_activity protocol sub_activity others
This is used as an easy way to avoid using DNS lookups to reach the C&C .		others others others others others others others others others others protocol others others others others tool tool tool others
Of course , in case this fails , the malware will indeed lookup the hardcoded domain ( toknowall.com ) .		others others others others others others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity domain_evil sub_activity others
It may be worth pointing that in the past , the BlackEnergy APT devs have shown a preference for using IP addresses for C&C instead of hardcoded domain names , which can be easily sinkholed .		others others others others others others others others others others others threatActor_name others others others others others others others sub_activity sub_activity sub_activity sub_activity tool tool tool others others others others others others others others others others others others
To analyse the EXIF processing mechanism , we looked into the sample 5f358afee76f2a74b1a3443c6012b27b , mentioned in the Talos blog .		others others others tool others others others others others others others others md5 others others others others others others others
The sample is an i386 ELF binary and is about 280KB in size .		reference_word reference_word others others others tool others others others others others others others others
Unfortunately for researchers , it appears that the photobucket.com galleries used by the malware have been deleted , so the malware cannot use the first C2 mechanism anymore .		others others others others others others others others domain_evil others others others others others others others others others others others others others others others others others tool others others others
With these galleries unavailable , the malware tries to reach the hardcoded domain toknowall.com .		others others others others others others others others others others others others others domain_evil others
While looking at the pDNS history for this domain , we noticed that it resolved to an IP addresses in France , at OVH , between Jan and Feb 2018: toknowall.com 188.165.218.31 2018-01-23 11:23:14 2018-02-06 05:50:32 .		others others others others protocol others others reference_word reference_word others others others others others others others others protocol others others location others others tool others time time time time time others domain_evil IP_evil time time time time others
Interestingly , when visiting this website ’s C2 URL , we are presented with a JPG image , suggesting it is still an active C2 .		others others others others others others others others tool tool others others others others others others sample_name others others others others others others others others tool others
When we look into the EXIF data for the picture , for instance using IrfanView , it looks as following :  Filename update.jpg GPS information – GPSLatitude – 97 30 - 175 ( 97.451389 ) GPSLongitude – -118 140 -22 ( -115.672778 ) .		others others others others others tool others others others others others others others others tool others others others others others others others sample_name others others others others others others others others others others others others others others others others others others others others others
How to get the IP out of these?		others others others others protocol others others others others
The subroutine which calculates the C2 IP from the Latitude and Longitude can be found at offset 0x08049160 in the sample .		others others others others others tool protocol others others others others others others others others others others others others others others others
As it turns out , VPNFilter implements an actual EXIF parser to get the required information .		others others others others others malware sub_activity sub_activity sub_activity tool sub_activity others attack_goal attack_goal attack_goal attack_goal others
First , it searches for a binary value 0xE1 .		others others reference_word sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
This makes sense because the EXIF attribute information begins with a tag “ 0xFF 0xE1 ” .		others others others others others tool sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity string string sub_activity others
Then , it verifies that the tag is followed by a string “ Exif ” .		others others reference_word others others others others others others others others others others tool others others
The malware ’s parser carefully traverses each record until it finds the one with a tag ’2 5 88′ ( 0x8825 little endian ) .		reference_word reference_word others others others others sub_activity sub_activity sub_activity others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
This is the tag value for “ GPS Info ” .		others others others others others others others tool others others others
That IFD record is , in turn , a list of tagged IFD records that hold separate values for latitude , longitude , timestamp , speed , etc .		others tool others others others others others others others others others others tool others others others others others others others others others others others others others others others others
In our case , the code is looking for the tags ‘ 2 ’ ( latitude ) and ‘ 4 ’ ( longitude ) .		others others others others others others others others others others others others others others others others others others others others others others others others others
The data for latitude and longitude are stored as three values in the “ rational ” format :  two 32-bit values , the first is the enumerator and the second one is the denominator .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Each of these three values corresponds to degrees , minutes and seconds , respectively .		others others others others others others others others others others others others others others others
Then , for each record of interest , the code extracts the enumerator part and produces a string of three integers ( i.e .		others others others others others others others others others others others others others others others others others others others others others others others others
“ 97 30 4294967121 ” and “ 4294967178 140 4294967274″ that will be displayed by a typical EXIF parser as 1193143 deg 55′ 21.00″ , 4296160226 deg 47′ 54.00 ” ) .		others string string string others others others string string others others others others others others others others tool others others string string string string others string string string string string others others
Then , curiously enough , it uses sscanf() to convert these strings back to integers .		others others others others others others others function function function others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
This may indicate that the GPS Info parser was taken from a third-party source file and used as-is .		others others others others others tool others others others others others others others others others others others others others
The extracted integers are then used to produce an actual IP address .		others others others others others others others others others others protocol others others
The implementation of the EXIF parser appears to be pretty generic .		others others others others tool others others others others others others others
The fact that it correctly handles the byte order ( swapping the data , if required ) and traverses all EXIF records skipping them correctly , and that the GPS data is converted to a string and then back to integers most likely indicates that the code was reused from an EXIF-parsing library or toolkit .		others others others reference_word others sub_activity sub_activity sub_activity sub_activity others others others others others others others others others sub_activity sub_activity tool sub_activity sub_activity sub_activity sub_activity others others others others tool others others others others others others others others others others others others others others others others others others others others others others others others others others
For the values provided here , the code will produce the IP address “ 217.12.202.40 ” that is a known C&C of VPNFilter .		others others others others others others others others others others others protocol others others IP_evil others others others others others tool tool tool others malware others
It should be noted that this IP is included in Cisco Talos ’ IOCs list as a known C&C .		others others others others others others protocol others others others security_team security_team others tool others others others others tool tool tool others
Currently , it appears to be down .		others others others others others others others others
Perhaps the most interesting question is who is behind VPNFilter .		others others others others others others others others others malware others
In their Affidavit for sinkholing the malware C2 , FBI suggests it is related to Sofacy .		others others others others others others others tool others government others others others others others threatActor_name others
Interestingly , the same Affidavit contains the following phrase : “ Sofacy Group , also known as apt28 , sandworm , x-agent , pawn storm , fancy bear and sednit ” .		others others others others others others others others others others others threatActor_name threatActor_name others others others others threatActor_aliases others threatActor_aliases others threatActor_aliases others threatActor_aliases threatActor_aliases others threatActor_aliases threatActor_aliases others threatActor_aliases others others
This would suggest that Sandworm , also known as BlackEnergy APT , is regarded as subgroup of Sofacy by the FBI .		others others others others threatActor_name others others others others threatActor_name others others others others others others others threatActor_name others others government others
Most threat intel companies have held these groups separate before , although their activity is known to have overlapped in several cases .		others others others others others others others others others others others others others others others others others others others others others others others
Perhaps the most interesting technical detail , which Cisco Talos points in their blog linking VPNFilter to BlackEnergy , is the usage of a flawed RC4 algorithm.The RC4 key scheduling algorithm implementation from these is missing the typical “ swap ” at the end of the loop .		others others others others others others others others security_team security_team others others others others others malware others malware others others others others others others others encryption_algo others encryption_algo others others others others others others others others others others others others others others others others others others others others
While rare , this mistake or perhaps optimization from BlackEnergy , has been spotted by researchers and described publicly going as far back as 2010 .		others others others others others others others others others malware others others others others others others others others others others others others others others time others
For instance , Joe Stewart ’s excellent analysis of Blackenergy2 explains this peculiarity .		others others others others others others others others others others malware others others others others
So , is VPNFilter related to BlackEnergy?		others others others malware others others malware others
If we are to consider only the RC4 key scheduling implementation alone , we can say there is only a low confidence link .		others others others others others others others encryption_algo others others others others others others others others others others others others others others others others
However , it should be noted that BlackEnergy is known to have deployed router malware going back as far as 2014 , which we described in our blogpost : “ BE2 custom plugins , router abuse , and target profiles “ .		others others others others others others others malware others others others others sub_activity sub_activity sub_activity others others others others others time others others others others others others others others others others others others others others others others others others others others others
We continue to look for other similarities which could support this theory .		others others others others others others others others others others others others others