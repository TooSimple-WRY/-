‘Twas the night before Release_Time :  2018-3-9 .		others others others others others others others others others
Report_URL :  https://securelist.com/masha-and-these-bears/84311/ Sofacy , also known as APT28 , Fancy Bear , and Tsar Team , is a prolific , well resourced , and persistent adversary .		others others others others others threatActor_name others others others others threatActor_aliases others threatActor_aliases threatActor_aliases others others threatActor_aliases threatActor_aliases others others others others others others others others others others others others
They are sometimes portrayed as wild and reckless , but as seen under our visibility , the group can be pragmatic , measured , and agile .		others others others others others others others others others others others others others others others others others others others others others others others others others others others
Our previous post on their 2017 activity stepped away from the previously covered headline buzz presenting their association with previously known political hacks and interest in Europe and the US , and examines their under-reported ongoing activity in middle east , central asia , and now a shift in targeting further east , including China , along with an overlap surprise .		others others others others reference_word time others others others others others others others others others others others others others others others others others others others others location others location location others others others others others others others others location location others location location others others others others others others others others others others others location others others others others others others others
There is much understated activity that can be clustered within this set and overlap in APT activity .		others others others others others others others others others others others others others others others others others others
Here , we examine current deployment , code , cryptography , and targeting .		others others others others others others others others others others others others others others
Essentially , this examination finds the group maintains subdivisions of efforts in targeting , development , and coding .		others others others others others others others others others others others others others others others others others others others
Comparisons to other modules quickly shows a delineation in other Sofacy efforts .		others others others others others others others others others others threatActor_name others others
SPLM , GAMEFISH , and Zebrocy delivery all maintain their own clusters , but frequently overlap later .		malware others malware others others malware others others others others others others others others others others others others
Because SPLM is their primary and selective second stage tool , SPLM deployment is of much interest .		others malware others others others others others others others others others malware others others others others others others
But Zebrocy efforts are in such high volume , that these modules need examination as well .		others malware others others others others others others others others others others others others others others others
SPLM , otherwise known as CHOPSTICK , or by the author (s ) as “ XAgent ” , is described as Sofacy ’s signature second stage tool , selectively used for years against around the world .		malware others others others others malware others others others others others others others others others others malware others others others others others threatActor_name others others others others others others others others others others others others others others others others
Really , many modified XAgent modules have been deployed over the years .		others others others others malware others others others others others others others others
Even the individual Linux modules renamed as “ Fysbis ” backdoors released in 2016 were merely modified and reduced portions of recompiled XAgent C/C++ codebase .		others others others OS_name others others others others malware others others others others time others others others others others others others others program_language program_language others others
Anyway , SPLM/CHOPSTICK has maintained various combinations of code , with some recognizable functionality listed here .		others others malware others others others others others others others others others others others others others others
Source Modules Channels .		others others others others
Modules Keylogger HTTP .		others others protocol others
Channels RemoteShell FTP .		others others protocol others
Boot FileSystem SMTP .		others others protocol others
Version 3 and early version 4 SPLM modules maintained keylogger , remoteshell , and filestealer code all within the larger compiled backdoor , and executed each body of functionality from within that process memory space .		others others others others others others malware others others malware others malware others others malware others others others others others others malware others others others others others others others others others others others others others others
Later v4 SPLM injected individual keylogger , filestealer , and remoteshell modules into memory space .		others others malware others others malware others malware others others malware others others others others others
But for the most part , deployed SPLM maintained the structure of earlier executable code .		others others others others others others others malware others others others others others others others others
In 2018 , we now see them pushing individual and separate blobs of keylogger , filesystem , and remoteshell code that never touch disk .		others time others others others others others others others others others others others malware others malware others others malware others others others others others others
The larger , 300kb+ SPLM backdoors deployed in 2016 and 2017 are not observed any longer at targets in 2018 .		others others others others malware others others others time time time others others others others others others others others time others
Instead , in-memory modules appear in isolation .		others others others others others others others others
In addition to purely XAgent based code , we also observe zebrocy modules completely recoded into powershell from .Net .		others others others others malware others others others others others others tool others others others others program_language others tool others
Current SPLM code maintains the unusual cipher hack that Sofacy began deploying in 2017 to hide away configuration details .		others malware others others others others others others others threatActor_name others others others time others others others others others others
Comparisons with cipher design and implementations we see in WhiteBear , earlier SPLM and Zebrocy modules tell a few things about design decisions and culture .		others others others others others others others others others threatActor_name others others malware others malware others others others others others others others others others others others
And when specific malware sets are selectively deployed , that may tell us something about how efforts are divided .		others others others others others others others others others others others others others others others others others others others others
SPLM full backdoor and plugins crypto and strings v4 973ff7eb7a5b720c5f6aafe4cd0469d5 Summary : SPLM is being carved up and delivered as memory-only chunks of compiled code .		others others others others others others others others others string others others malware others others others others others others others others others others others others others
We observe the “ retranslator ” code , or ProcessRetranslator.dll , currently being delivered to systems without the presence of the previous , large , SPLM code and injection capabilities .		others others others sample_name sample_name sample_name sample_name others others sample_name sample_name others others others others others others others others others others others others others others malware others others attack_activity attack_activity others
The smaller plugins deployed in 2018 now maintain the same dynamic encryption code as the large 330kb full SPLM backdoors seen in more widespread use in 2017 .		others others others others others time others others others others others others others others others others others others malware others others others others others others others time others
Strings are well organized and concise .		others others others others others others others
Code and strings example ( decrypted from 2018 “ ProcessRetranslator.dll ” plugin ) :  success command not correct error save parameters error set parameters for channel , see full info command processing error not correct command command loading func/net module error command unloading func/net module error cmd.exe Retranslator is now launched Retranslator is now stopped the process is destroyed one thread has died so the process is killed too create process failed on : ( %s ) , error ( %d ) Retranslator is already running Retranslator is not running exit command is successful command is unsuccessful .		others others others others others others others time others sample_name others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
SPLM crypto v3 ( DNC hack ) cc9e6578a47182a941a478b276320e06 Summary : This earlier SPLM variant found on the DNC network in 2016 still maintains the internal name “ splm.dll ” , with only one export “ init ” that was called at runtime .		malware others others others others others others string others others others others malware others others others others tool tool others time others others others others others others sample_name others others others others others others others others others others others others others others others
The C++ structure of this 280kb+ dll is familiar SPLM/CHOPSTICK , but it maintains a completely different cipher for decrypting configuration data and error messages , etc .		others program_language others others others others others others others tool others others others others others others others others others others others others others others others others others others
The loop performing the bulk of the work is less than 100 bytes , performing pointer arithmetic alongside a couple xor operations of a lower nibble against sequential bytes .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Here , the cipher uses a modolo pointer arithmetic along with a decryption key per blob .		others others others others others others others others others others others others others others others others others
Reviewing all the older ciphers and newer EC based ciphers in openssl and elsewhere results in no match .		others others others others others others others others others others others others others others others others others others others
Summary : WhiteBear is a cluster of activity targeting foreign embassies and MFA organizations , starting in early 2016 and continued into early 2017 .		others others threatActor_name others others others others others others government government others industry industry others others others time time others others others time time others
Our private GReAT report on this activity pushed in February 2017 , and a public report from another vendor described much of the same content almost seven months later as “ Gayzer ” .		others others security_team others others others others others others time time others others others others others others others others others others others others others others others others others others others others malware others others
It appeared to be a parallel project to WhiteAtlas Turla , and maintained quirks like modular , well logged code with an elegant , professional RSA and 3DES encryption implementation and high quality code injection capabilities , but lots of immature and crude language and english mistakes .		others others others others others others others others malware malware others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Clearly , english and maturity was not the developers ’ native language .		others others others others others others others others others others others others others
While WhiteBear is Turla related , it is interesting to compare to other ongoing development styles .		others threatActor_name others malware others others others others others others others others others others others others others
Strings and code are crass .		others others others others others others
Debug and command strings ：  i cunt waiting anymore #%d lights aint turnt off with #%d Not find process CMessageProcessingSystem::Receive_NO_CONNECT_TO_GAYZER CMessageProcessingSystem::Receive_TAKE_LAST_CONNECTION CMessageProcessingSystem::Send_TAKE_FIN .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Summary : innovative .Net , AutoIT , Delphi , and powershell components are continually updated and deployed to new and old targets .		others others others tool tool tool tool tool tool tool tool others others others others others others others others others others others others
Cryptography ranges from built-in windows api to custom RC4-based ciphers .		others others others others others others others others others others others
Strings and code are simple , innovative , and concise .		others others others others others others others others others others others
News headlines repeatedly trumpet Sofacy ’s foray into Western targets in the US and Europe , especially those connected with NATO .		others others others others threatActor_name others others others others others others others others location others location others others others others others location others
But these efforts only tell a portion of the Sofacy story .		others others others others others others others others others others others others
Delineating groups and activity can be messy , and there appears to be overlap in targeting efforts across varying groups in central and east asia throughout 2017 and into 2018 .		others others others others others others others others others others others others others others others others others others others others others others others others others others time others others time others
Sofacy has been heavily interested in military and foreign affairs organizations here , resulting in multiple overlapped and competing targeting scenarios :  Mosquito Turla and Zebrocy clusters – Zebrocy clusters targeting diplomatic and commercial organizations within Europe and Asia that match Mosquito targeting profiling SPLM overlap with traditional Turla – often Turla precedes SPLM deployments SPLM overlap with Zebrocy – Zebrocy often precedes SPLM deployments SPLM overlap with Danti .		threatActor_name others others others others others others others others others others others others others others others others others others others others others malware malware others malware others others malware others others others others others others others location others location others others malware others others malware others others others malware others others others others malware others malware others others malware others others others others others others malware others others malware others
Currently , Sofacy targets large air-defense related commercial organizations in China with SPLM , and moves Zebrocy focus across Armenia , Turkey , Kazahkstan , Tajikistan , Afghanistan , Mongolia , China , and Japan .		others others threatActor_name others industry industry industry industry industry others location others malware others others others malware others others location location location location location location location location location location location location location location location location others
A previous , removed , report from another vendor claimed non-specific information about the groups ’ interest in Chinese universities , but that report has been removed – most likely detections were related to students ’ and researchers ’ scanning known collected samples and any “ incidents ” remain unconfirmed and unknown .		others others others others others others others others others others others others others others reference_word others others others location location others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
On the other hand , this Chinese conglomerate designs and manufactures aerospace and air defense technologies , among many other enterprises .		others others others others others others industry industry industry industry industry industry industry industry industry industry others others others others others others
And here , an interest in military technologies is certainly within Sofacy purview .		others others others others others others others others others others others threatActor_name others others
So , even more interesting than the shift eastward and other targeting overlap , is that the specific target system in China was previously a Grey Lambert target .		others others others others others others others others others others others others others others others others others others others others others location others others others sample_name sample_name others others
The Sofacy modules at this system appeared to never touch disk , and resemble the Linux Fysbis code .		others threatActor_name others others others others others others others others others others others others others OS_name others others others
Only one maintained the Filesystem.dll code , while another maintained ProcessRetranslator.dll code .		others others others others sample_name others others others others others sample_name others others
However , it is unusual that a full SPLM backdoor was not detected on this system , nor was any powershell loader script .		others others others others others others others others malware others others others others others others others others others others others tool others others others
Because the injection source remains unidentified on such a unique system , we might speculate on what is going on here :  Sofacy attackers had recorded a previous Grey Lambert remote session and replayed the communication after discovering this host , essentially compromising the Grey Lambert module on the system to gain access and later injecting SPLM modules Grey Lambert attackers inserted false flag and reduced SPLM modules a new and unrecognized , full variant of SPLM attempted to inject module code into memory and deleted itself an unknown new powershell script or legitimate but vulnerable web app was exploited to load and execute this unusual SPLM code .		others others others others others others others others others others others others others others others others others others others others others others threatActor_name others others others others others sample_name sample_name others others others others others others others others others others others others others others sample_name sample_name sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function sample_function malware sample_function sample_name sample_name others others others others others others malware others others others others others others others others others malware others others others others others others others others others others others others others others others others others others others others others others others others others others others others others malware others others
In all likelihood , the last option is accurate .		others others others others others others others others others others
Sofacy is such a large , active group that appears to maintain multiple sub-groups and efforts that all fit under the Sofacy “ umbrella ” .		threatActor_name others others others others others others others others others others others others others others others others others others others others threatActor_name others others others others
Sometimes , they share infrastructure , but more often they do not share infrastructure and appear to compete for access within targets .		others others others others others others others others others others others others others others others others others others others others others others others
Either way , the group ’s consistent activity throughout central and eastern asia seems to be poorly represented in the public discussion .		others others others others reference_word others others others others others location location location location others others others others others others others others others others
SPLM did not change in substantial ways for several years , and now it is being split up and used for just functional modules .		malware others others others others others others others others others others others others others others others others others others others others others others others others
And much of the malware being deployed by Sofacy is quickly changed from C/C++ to .Net to powershell .		others others others others others others others others threatActor_name others others others others program_language others tool others tool others
Other open source and semi-legitimate pen-testing tools like nbtscan and powercat are being used for mapping available resources and lateral movement as well .		others others others others others others others others tool others tool others others others others others others others others others others others others others
It is easy to expect deliberate changes within this group in 2018 , with even more .Net , Delphi ,  and powershell ports of various tools appearing at Sofacy targets throughout the year .		others others others others others others others others others others others time others others others others tool others tool others others tool others others others others others others threatActor_name others others others others others
Early 2018 Reference Set SPLM : 452ed4c80c1d20d111a1dbbd99d649d5 .		others time others others others others string others
ZEBROCY : efd8a516820c44ddbf4cc8ed7f30df9c .		others others string others
ZEBROCY : ff0e4f31a6b18b676b9518d4a748fed1 .		others others string others
GAMEFISH : bd3e9f7e65e18bb9a7c4ff8a8aa3a784 .		others others string others
GREY LAMBERT : 86146d38b738d5bfaff7e85a23dcc53e .		others others others string others
GREYWARE / PEN-TESTING NBTSCAN : f01a9a2d1e31332ed36c1a4d2839f412 .		others others others others others string others