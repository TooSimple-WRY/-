HOT KNIVES THROUGH BUTTER:  Evading File-based Sandboxes With organizations facing a deluge of cyberattacks , virtual-machine sandboxing has become a popular tool for quickly examining legions of files for suspicious activity .		others others others others others others others others others others others others others others others others others others others others others others others others security_team others others others others others others others others
These sandboxes provide isolated , virtual environments that monitor the actual behavior of files as they execute .		others others others others others others others others others others others others others others others others others others
In theory , this setup enables security professionals to spot malicious code that evades traditional signature-based defenses .		others others others others others others others others others others others others others others others others others others
But sandboxes are only as good as the analysis that surrounds them .		others others others others others others others others others others others others others
By themselves , sandboxes can only monitor and report file activity , not analyze it .		others others others others others others others others others others others others others location location location
And unfortunately for organizations that rely on them , the file-based sandboxes used by many vendors are proving oblivious to the latest malware .		others location location others others location location others others others others others others others others others others others others others others others others others
Attackers are using a variety of techniques to slip under the radar of these sandboxes , leaving systems just as vulnerable as they were before .		others others others others others others others others others others others others others others others others others attack_activity attack_activity attack_activity others others others target_crowd target_crowd target_crowd
Note : The term “ sandboxing ” is a broad concept that includes many forms of isolating code .		others others others location location others others others others others others others others others others threatActor_name threatActor_name threatActor_name threatActor_name
This report focuses on file-based sandboxing that uses instrumented virtual-machine ( VM )  environments to simulate targeted computers , execute unknown files , and monitor those files ’ activity for reporting and analysis .		threatActor_name others others attack_activity others others others others others others others others others others others others others others others others others government others others government government others target_crowd others target_crowd target_crowd target_crowd target_crowd others
The techniques outlined in this report render VM-aware malware invisible to this category of sandboxing .		government government government government government others government others industry others industry industry others government government government
Detecting them requires analyzing the context of behavior and correlating disparate phases of an attack through multi-flow analysis— which is how FireEye researchers identified the malware samples outlined in this report .		others industry industry others industry industry industry others others others others others others others others others others tool others others others others others others others others others others others others others others
This report is an updated version of the report published in February 2014 .		others others others tool others others security_team security_team others others others others others others
In this update we have added :  New evasion techniques that make use of human interaction to evade file-based sandboxes .		others others others others others others others others others others security_team others others others others others others others others others others
Under the Configuration section we provide details about techniques that use image files to hide executables with malicious behavior to evade file-based sandboxes .		location location others others others others others others others others others others others others others others others others others others others others others others
Security professionals widely agree that traditional signature-based security measures are toothless against today ’s sophisticated attacks .		others others others others others others others others others others others others others others others others others others
Advanced malware is dynamic and polymorphic , exploiting unknown vulnerabilities to attack through multiple vectors in a coordinated fashion .		others others others others others others others others others others others others others others others others others others others others
Malware defenses have had to evolve .		others others others others others others others
Instead of relying on signatures , automated analysis systems examine malware behavior using sandboxing .		others others others others others others others others others others others others others others others
These self-contained simulated computer environments allow files to execute without doing any real damage .		others others others others others others others others others others others others others others others
Observing the files in these virtual environments , security systems can flag suspicious behavior , such as changes to the operating system or calls to the attacker ’s command-and-control ( CnC ) servers .		industry industry others industry others others others industry others others others others others others others others location location location location others others others others location others location location others others location location location others others
But attackers have evolved , too .		location others others others location location others
Mindful that their code may execute in a sandbox before it reaches its target , malware authors are creating VMaware code that hides any telltale behavior until it has reached “ live ” prey .		others location others others location others location location others others location others location others location others others others others others location others location others others others others others others others others others others others others
Observing no suspicious actions in the sandbox , the security analysis deems the code harmless .		others others others others others location location location others others others others others others others others
The key for malware authors is determining whether the code is running in a virtual environment or on a real target machine .		others others others others others others others others others others others others others others others others others others others others others others others
To that end , malware authors have a developed a variety of techniques .		others others others others others others others others others others others others others others
File-based sandboxes emulate physical systems , but without a human user .		others others others others others others others others others others others others
Attackers use this key difference to their advantage , creating malware that lies dormant until it detects signs of a human user : a mouse click , intelligent responses to dialog boxes , and the like .		others time others others others others others others others others others others others others others others others others others others others others others others others others others others others others others threatActor_name threatActor_name threatActor_name others others threatActor_name
This section describes these checks in more detail .		threatActor_name others others others others others others others others
Mouse clicks UpClicker , a trojan analyzed in December 2012 , was among the earliest-discovered malware samples that used mouse clicks to detect human activity .		others others others others others others others others others others others others others others others others others others others others others others others others others others
A similar , albeit simpler , technique emerged a few months earlier To fool sandboxes , UpClicker establishes communication with malicious CnC servers only after detecting a click of the left mouse button .		others others others others others others others others others others others others others others others others others others others location others others others others others others others others others others others others others others
UpClicker is a wrapper around Poison Ivy , a remote access tool ( RAT ) tied extensively to advanced persistent threat ( APT ) attacks .		others others others others others others others others others others others others others others others others others others others others others others others others others others
This code watches for a left-click on the mouse— more specifically , an up-click , which is where the Trojan gets its name .		others others others others others others others others others others others tool others others others others others others others others others others others others
When an up-click occurs , the code calls function UnhookWindowsHookEx to stop monitoring the mouse and then calls the function sub_401170 to execute the malicious code .		others others others others others others others others others others others others others others others others others others others others others others others others others others others
Another APT-related malware file called BaneChant , which surfaced six months after UpClicker , further refined the concept .		others others others others others others others others others others others others others others others others others others others
It activates only after three mouse clicks .		others others tool others others others others others
Dialog boxes Another way of detecting a live target is displaying a dialog box that requires the user to respond .		others others others others others others tool others others others others others others others others others others others others others others
A common malware technique is using the MessageBox and MessageBoxEx API functions of Windows to create dialog boxes in EXE and DLL files .		others others others others others others others others others others others others others others others others others others others others others others others others
The malware activates only after the user clicks a button .		others others others others others others others others others others others
In the same way , malware can use JavaScript to open a dialog box within Adobe Acrobat PDF files using the app.alert method documented in the JavaScript for Acrobat API .		others others others others others others tool tool others others others others others others others others others others others others others others others others others others others others others others others
When the user clicks OK , the code uses the app.launchURL method to open a malicious URL .		others others others others others others others others others others others others others others others others others others
To scroll is human7 One malware we discovered lies dormant until the user scrolls to the second page of a Rich Text Format ( RTF ) document .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others
So simulating human interaction with random or preprogrammed mouse movements isn’t enough to activate its malicious behavior .		others others others others others others others others others others others others others others others others others others others others
The rule of two ( clicks )  Another sandbox-evading attack we spotted in recent attacks waits for two or more mouse clicks before executing .		others others others others others others others others others others others others others others others others others others others others others others others others others
To thwart earlier evasion techniques that detect human interaction , some sandboxes have begun programming one-time mouse clicks when executing code .		others others others others others others others others others others others others others others others others others others others others others others
But most people click mouse buttons many times throughout the day .		others others others others others others others others others others others others
By lying dormant until it detects more than two clicks , the malicious code ensures that the mouse clicks are from an actual person —not a sandbox mimicking one .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others