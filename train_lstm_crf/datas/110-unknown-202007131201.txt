From BlackEnergy to ExPetr .		others malware others malware others
Release_Time : 2017-06-30 .		others others others others
Report_URL : https://securelist.com/from-blackenergy-to-expetr/78937/ .		others others others others others others
As in the case of Wannacry , attribution is very difficult and finding links with previously known malware is challenging .		others others others others others malware others others others others others others others others others others others others others others others
In the case of Wannacry , Google ’s Neel Mehta was able to identify a code fragment which became the most important clue in the story , and was later confirmed by further evidence .		others others others others malware others company others others person person others others others others others sub_activity sub_activity others others others others others others others others others others others others others others others others others others
To date , nobody has been able to find any significant code sharing between ExPetr/Petya and older malware .		others others others others others others others others others others others others others others others others others malware others
At the beginning of the ExPetr outbreak , one of our team members pointed to the fact that the specific list of extensions used by ExPetr is very similar to the one used by BlackEnergy ’s KillDisk  ransomware from 2015 and 2016 .		others others others others others malware sub_activity others others others others others others others others others others others others others others others others others others malware others others others others others others others others malware others others malware others others time time time others
The BlackEnergy APT is a sophisticated threat actor that is known to have used at least one zero day , coupled with destructive tools , and code geared towards attacking ICS systems .		others threatActor_name others others others others others others others others others others others others others others others vulnerability_cve vulnerability_cve others others others others others others others others others others others attack_goal attack_goal others
They are widely confirmed as the entity behind the Ukraine power grid attack from 2015 as well as a chain of other destructive attacks that plagued that country over the past years .		reference_word others others others others others others others others location sub_activity sub_activity sub_activity others time others others others others others others others others others others others others others others others others others others
Going back to the hunt for similarities , here ’s how the targeted extensions lists looks in ExPetr and a version of a wiper used by the BE APT group in 2015: ExPetr : .3ds , .7z , .accdb , .ai , .asp , .aspx .		others others others others others others others others others others others others others others target_crowd target_crowd others others malware others others others others others others others others others threatActor_name threatActor_name others others time others malware others sub_activity others sub_activity others sub_activity others sub_activity others others others others others
2015 BlackEnergy wiper sample : .csr , .csv , .dat , .db3 , .db4 .		time malware others others others sub_activity others others others others others others others others others
Obviously , the lists are similar in composition and formatting , but not identical .		others others others others others others others others others others others others others others others
Moreover , older versions of the BE destructive module have even longer lists .		others others others others others others malware malware malware others others others others others
Nevertheless , the lists were similar in the sense of being stored in the same dot-separated formats .		others others others others others others others others others others others others others others others others others others
Although this indicated a possible link , we wondered if we could find more similarities , especially in the code of older variants of BlackEnergy and ExPetr .		others others others others others others others others others others others others others others others others others others others others others others others others malware others malware others
We continued to chase that hunch during the frenetic early analysis phase and shared this gut feeling of a similarity between ExPetr and BlackEnergy with our friends at Palo Alto Networks .		others others others others others others others others others others others others others others others others others others others others others malware others malware others others others others security_team security_team security_team others
Together , we tried to build a list of features that we could use to make a YARA rule to detect both ExPetr and BlackEnergy wipers .		others others others others others others others others others others others others others others others others others tool others others sample_function sample_function malware sample_function malware sample_function others
During the analysis , we focused on the similar extensions list and the code responsible for parsing the file system for encryption or wiping .		others others others others others others others others sub_activity sub_activity sub_activity others others sub_activity sub_activity others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
This works by going through the target file system in a recursive way , then checking if the extension for each file is included in the dot-separated list .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Unfortunately for our theory , the way this is implemented in older BlackEnergy variants is quite different ; the code is more generic and the list of extensions to target is initialized at the beginning , and passed down to the recursive disk listing function .		others others others others others others others others others others others others malware others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Instead , we took the results of automated code comparisons and paired them down to a signature that perfectly fit the mould of both in the hope of unearthing similarities .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
What we came up with is a combination of generic code and interesting strings that we put together into a cohesive rule to single out both BlackEnergy KillDisk components and ExPetr samples .		others others others others others others others others others others others others others others others others others others others others others others others others others others malware malware others others malware others others
The main example of this generic code is the inlined wcscmp function merged by the compiler ’s optimization , meant to check if the filename is the current folder , which is named “ .		others others others others others others others others others others function others others others others others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others others others others others
” .		others others
Of course , this code is pretty generic and can appear in other programs that recursively list files .		others others others others others others others others others others others others others others others others others others others
It ’s inclusion alongside a similar extension list makes it of particular interest to us –but remains a low confidence indicator .		others others others others others others others others others others others others others others others others others others others others others others others
Looking further , we identified some other candidate strings which , although not unique , when combined together allow us to fingerprint the binaries from our case in a more precise way .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
These include : exe /r /f , ComSpec , InitiateSystemShutdown .		others others others string others others others string others string others
When run on our extensive malware collection , the YARA rule above fires on BlackEnergy and ExPetr samples only .		others others others others others others others others others tool others others others others malware others malware others others others
Unsurprisingly , when used alone , each string can generate false positives or catch other unrelated malware .		others others others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
However , when combined together in this fashion , they become very precise .		others others others others others others others others others others others others others others
The technique of grouping generic or popular strings together into unique combinations is one of the most effective methods for writing powerful Yara rules .		others others others others others others others others others others others others others others others others others others others others others others tool others others
Of course , this should not be considered a sign of a definitive link , but it does point to certain code design similarities between these malware families .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
This low confidence but persistent hunch is what motivates us to ask other researchers around the world to join us in investigating these similarities and attempt to discover more facts about the origin of ExPetr/Petya .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
Looking back at other high profile cases , such as the Bangladesh Bank Heist or Wannacry , there were few facts linking them to the Lazarus group .		others others others others others others others others others others others sub_activity sub_activity sub_activity others malware others others others others others others others others others threatActor_name others others
In time , more evidence appeared and allowed us , and others , to link them together with high confidence .		others others others others others others others others others others others others others others others others others others others others others
Further research can be crucial to connecting the dots , or , disproving these theories .		others others others others others others others others others others others others others others others others
ExPetr : 027cc450ef5f8c5f653329641ec1fed91f694e0d229928963b30f6b0d7d3a745 .		malware others md5 others
BE : 11b7b8a7965b52ebb213b023b6772dd2c76c66893fc96a18a9a33c8cf125af80 , 5d2b1abc7c35de73375dd54a4ec5f0b060ca80a1831dac46ad411b4fe4eac4c6 , F52869474834be5a6b5df7f8f0c46cbc7e9b22fa5cb30bee0f363ec6eb056b95 .		malware others md5 others md5 others md5 others