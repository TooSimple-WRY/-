En Route with Sednit Part 2 : Observing the Comings and Goings .		others others others threatActor_name others others others others others others others others others
Release_Time : 2016-10 Report_URL : https://www.welivesecurity.com/wp-content/uploads/2016/10/eset-sednit-part-2.pdf The HttpChannel::getRawPacket() method is implemented as a HTTP GET request—the message from the server being then in the HTTP answer body—while HttpChannel::sendRawPacket() is an HTTP POST request , whose body contains the message .		others others others others others others others others others function function function function function others others others others others protocol function others others others others others others others others others protocol others others function function function function function others others protocol function others others others others others others others others
The C&C IP address is hardcoded in the associated header file HttpChannel.h .		others tool tool tool protocol sub_activity others others others others others others others sample_name others
Roughly summarized , this URL is a series of pseudo-randomly chosen parameters associated with pseudo-randomly generated values , except for a special parameter called mark .		others others others others tool others others others others others others others others others others others others others others others others others others others others others
This special parameter ( whose value is set to ai in the Linux source code ) is associated with a so-called token , which is a 20-byte value .		others others others others others others others others others others others others OS_name others others others others others others others others others others others others others others others others
In this token , the Key is pseudo-randomly generated , while URL_TOKEN is hardcoded in the source code and probably serves to check the integrity of the message by the C&C server .		others others others others others others others others others others others function others others others others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others tool tool tool others others
The bodies of the POST requests , and of the responses to GET requests , follow exactly the same format as the token , except that they contain a CryptRawPacket object in place of the agent ID .		others others others others function others others others others others others others function others others others others others others others others others others others others others others others others function others others others others others others others others
Also , the hardcoded value is a different one , called DATA_TOKEN by the developers .		others others others others others others others others others others others function others others person others
The MailChannel object is an implementation of Xagent communication channel over emails , where messages are sent and received as attachments to emails .		others function others others others sub_activity sub_activity malware sub_activity sub_activity others tool others others others others others others others others others others others others
During an investigation , we discovered the source code of a proxy server employed to relay traffic between Xagent infected computers using MailChannel ( dubbed “ agents ” hereafter ) and a C&C server .		others others others others others others others sub_activity sub_activity others others tool tool others others sub_activity sub_activity others malware target_crowd target_crowd others tool others others others others others others others others others tool tool tool others others
This source code was left in an open directory on the proxy server , which was then indexed by the Google search engine .		reference_word reference_word reference_word others others others others others others others others others others others others others others others others others company tool tool others
The proxy code is a set of Python scripts containing more than 12,200 lines of code among 14 files .		reference_word reference_word reference_word others others others others program_language others others others others others others others others others others others others
It also contains some log files indicating it was in use from April 2015 to June 2015 .		others others others others sub_activity sub_activity others others others others others others time time time time time others
As can be seen from the files ’ names , the proxy is actually more than a simple relay of communications : it translates the email channel protocol from the agents into HTTP requests for the C&C server .		others others others others others others others others others others reference_word reference_word others others others others others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity others others others others protocol others others others tool tool tool others others
Therefore , we decided to include this proxy in our analysis of the email communication channel .		others others others others others others others others others others others others others others others others others
The proxy source code contains a few unused instructions related to agents communicating over HTTP , i.e.		reference_word reference_word reference_word reference_word others others others others others others others others others others protocol others others others
using HttpChannel rather than MailChannel .		others function others others function others
Nevertheless , the main class responsible for relaying HTTP traffic from agents—named W3Server—is absent and its instantiation has been commented out .		others others others others others others others sub_activity sub_activity sub_activity sub_activity others others others others others others others others others others others
Similar to Xagent , the operators therefore seem to deploy the components of the proxy server only if needed , and this one was intended to relay MailChannel traffic only .		others others malware others others person others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others others others others others others others others others others function others others others
The MailChannel::sendRawPacket() method is in charge of sending CryptRawPacket objects as email attachments .		others function function function function function others others others others others sub_activity function sub_activity sub_activity sub_activity sub_activity others
For that purpose , the code contains an SMTP server address with an email address and a password to log in , plus a recipient email address to which the emails will be sent .		others others others others reference_word reference_word others others protocol tool tool others others sub_activity sub_activity others others sub_activity others others others others others others tool tool tool others others others others others others others others
Depending on the sample , this recipient email address may belong to a freemail provider , a custom Sednit domain , or even a hacked target .		others others others others others reference_word reference_word reference_word reference_word others others others others others others others others others threatActor_name others others others others others others others others
Building a C&C protocol over email brings at least two problems for the operators : they need to be able to distinguish Xagent emails from unrelated emails in the inbox ( like spam emails ) , and they need to bypass spam filters .		sub_activity sub_activity tool tool tool sub_activity sub_activity sub_activity others others others others others others others person others others others others others others others sub_activity malware sub_activity sub_activity sub_activity sub_activity others others others others others others others others others others others others others sub_activity sub_activity sub_activity others
To do so , they implemented a protocol named P2Scheme ( and dubbed “ P2 ” hereafter ) , which defines the format of the emails .		others others others others reference_word others others others others protocol others others others others protocol others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others
This protocol is described as a “ level 2 protocol ” by the developers , and defines the following email fields :  In this format , the Key is pseudo-randomly generated , while SUBJ_TOKEN is a 7-byte value hardcoded in the source code and strangely containing the string “ china ” ( prefixed with bytes 0x550xAA ) .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
This specific subject serves to distinguish Xagent emails from unrelated emails in an inbox , as we will explain .		others others others others others others malware others others others others others others others others others others others others others
The email body and the attachment name are the base64 encodings of pseudo-randomly generated values .		others others others others others others others others others others others others others others others others
The boundary value , used to separate a MIME multipart message in parts , is a pseudorandomly generated value .		others sub_activity sub_activity others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others others others others others others
Nevertheless , in practice only the boundary is actually generated with the P2 protocol , as the code to generate the others fields has been commented out in the Linux source code .		others others others others others others others others others others others others protocol others others others others others others others others others others others others others others others others OS_name others others others
Instead , these fields are set to fixed values , likely chosen to avoid attracting attention from Georgian targets :  the email subject is set to piradi nomeri , which refers to a national ID number in Georgian .		others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others
the email body is set to gamarjoba , which means hello in Georgian .		others others others others others others others others others others others others others others
the attachment name is set to detaluri_X.dat , where X is the current time ( detaluri means detailed in Georgian ) .		others others others others others others sample_name others others others others others others others others others others others others others others others
Georgian institutions are well-known targets of the Sednit group , as documented by FireEye in 2014 .		target_crowd target_crowd others others others others others threatActor_name others others others others others security_team others time others
Once the email has been built , the CryptRawPacket object is added as an attachment .		others others others others others others others others function others others others others others others others
Finally , the email is sent with the SMTP protocol over TLS to the recipient email address ( exfil@example.com ) .		others others others others others others others others protocol others others tool others others others others others others email_evil email_evil email_evil others others
It will be retrieved by the proxy server , and the message will be forwarded to the C&C server , as we will describe below .		others others others others others others tool tool others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity tool tool tool sub_activity others others others others others others others
In the other direction , the MailChannel::getRawPacket() method retrieves emails containing messages from the C&C server with the POP3 protocol over TLS .		others others others others others others function function function function function others sub_activity sub_activity sub_activity sub_activity others others tool tool tool others others others protocol others others tool others
The email address to receive messages is a different one than the one used to send messages ( orders@example.com ) .		others others others others others others others others others others others others others others others others others others email_evil email_evil email_evil others others
For each received email , the method checks that the subject is set to piradi nomeri and , if so , instantiates a CryptRawPacket object from the attachment , which is then transmitted to the intended module .		others others others others others reference_word reference_word sub_activity sub_activity sub_activity sub_activity others others others others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others others others sub_activity sub_activity sub_activity sub_activity sub_activity others
The MailServer.py script manages the communications by emails with the agents .		others sample_name others others others others others others others others others others
To do so , it regularly fetches emails from the inbox agents have sent their messages to ( exfil@example.com ) .		others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others others others others others email_evil email_evil email_evil others others
The script then checks for each email whether the subject matches the P2 protocol ; that is , if once decoded it contains the SUBJ_TOKEN value .Alternatively , it checks whether the subject is set to piradi nomeri , which is the case with the Linux source code as we just explained .		reference_word reference_word others sub_activity sub_activity sub_activity sub_activity others others others others others protocol others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others others OS_name others others others others others others others
If the subject is valid , MailServer.py stores the email attachment into a “ FROM ” folder associated with the sender agent , using a custom format defined in a class named P3Scheme .		others others others others others others sample_name others others others others others others others others others others others others others others others others others others others others others others others others others others others
This format , dubbed “ level 3 protocol ” , is a variation for the HTTP token : namely , the length of Junk is set to 9 and the hardcoded value is different .		others others others others others others others others others others others others others others others protocol others others others others others others others others others others others others others others others others others others others
The script LocalStorage.py manages a storage with a “ FROM ” and “ TO ” folder for each agent that sent an email to the monitored inbox ( the agent ID being retrieved from the CryptRawPacket attached to the email ) .		others others sample_name sample_function sample_function sample_function others others others others others others others others others others others others others others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others others others others others others others others others others others others others others
The second important script is w3s.py , which manages the HTTP communications with the C&C server .		others others others others others sample_name others others sample_function sample_function protocol sample_function sample_function sample_function protocol protocol protocol sample_function others
For all known agents , the script retrieves the messages dropped in the “ FROM ” folder , and sends them to the C&C server in the body of a HTTP POST request .		others others others others others reference_word reference_word sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity others others sub_activity sub_activity sub_activity sub_activity tool tool tool sub_activity others others others others others protocol function others others
The values XAS_IP and XAS_GATE are respectively the C&C server address and URL path , while SERVER_UID is a 4-byte value identifying the proxy server .		others others others others others others others others tool tool tool others others others others others others others others others others others others others others others others others
The P3_Scheme.pack_service_data() method encodes data following the previously-described P3 format .		others function function function others others others others others others protocol others others
In the other direction , the w3s.py script regularly sends a HTTP GET request to the C&C server , on the URL previously described , for all known agents .		others others others others others others sample_name others others sub_activity sub_activity protocol function sub_activity sub_activity sub_activity tool tool tool sub_activity others others others others others others others others others others others others
The body of the C&C answer is a message encoded with the P3 protocol that will be stored in the “ TO ” folder .		others others others others tool tool tool others others others others others others others protocol others others others others others others others others others others others others
Then , the MailServer.py script will retrieve the message and attach it to an email following the P2 protocol , which will be sent to the agent .		others others others sample_name others others sub_activity sub_activity sub_activity others sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity sub_activity protocol others others others others others others others others others others
From the log files contained in the proxy open folder , we can infer that it was a Windows server configured in the Russian language ( Python console error messages were output in Russian language ) .		others others others others others others others others others others others others others others others others others others OS_name others others others others others others others tool others others others others others others others others others others
Xagent is a well-designed backdoor that has become the flagship espionage malware of the Sednit group over the past few years .		malware others others others malware others others others others others others others others others threatActor_name others others others others others others others
The ability to communicate over HTTP or via emails make it a versatile tool for the operators .		others others others sub_activity sub_activity protocol sub_activity sub_activity tool others reference_word others others others others others person others
Moreover , the existence of Xagent versions for Windows , Linux and iOS shows the importance of this backdoorin their arsenal.We speculate that there are versions for others platforms , likeAndroid .		others others others others others malware others others OS_name others OS_name others OS_name others others others others others others others others others others others others others others others others others others others